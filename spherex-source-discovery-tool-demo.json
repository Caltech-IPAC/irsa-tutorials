{"version":3,"kind":"Notebook","sha256":"dbb23d6a9316c1e188dfc580cdec856952647ac2a618241885699c81294fee40","slug":"spherex-source-discovery-tool-demo","location":"/tutorials/spherex/spherex_source_discovery/spherex_source_discovery_tool_demo.md","dependencies":[],"frontmatter":{"title":"SPHEREx Source Discovery Tool IRSA Demo","kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"jupytext":{"text_representation":{"extension":".md","format_name":"myst","format_version":"0.13","jupytext_version":"1.18.1"}},"execute":{"skip":true},"content_includes_title":false,"authors":[{"id":"IRSA Scientists and Developers","name":"IRSA Scientists and Developers"}],"license":{"content":{"id":"BSD-3-Clause","url":"https://github.com/Caltech-IPAC/irsa-tutorials/blob/main/LICENSE","name":"BSD 3-Clause \"New\" or \"Revised\" License","free":true,"osi":true}},"github":"https://github.com/Caltech-IPAC/irsa-tutorials/","subject":"IRSA Tutorials","keywords":["astronomy"],"settings":{"output_matplotlib_strings":"remove"},"numbering":{"title":{"offset":1}},"source_url":"https://github.com/Caltech-IPAC/irsa-tutorials//blob/main/tutorials/spherex/spherex_source_discovery/spherex_source_discovery_tool_demo.md","edit_url":"https://github.com/Caltech-IPAC/irsa-tutorials//edit/main/tutorials/spherex/spherex_source_discovery/spherex_source_discovery_tool_demo.md","exports":[{"format":"md","filename":"spherex_source_discovery_tool_demo.md","url":"/irsa-tutorials/build/spherex_source_disco-fe40da9d7cf47cadb30908f0d298cf0f.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"The SPHEREx Source Discovery Tool is the Python package ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"jvfNsRvCCs"},{"type":"inlineCode","value":"spherex_source_discovery_tool","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"YxszEeFayB"},{"type":"text","value":" (included in this directory), which is used to discover and extract sources from SPHEREx Spectral Images and visualize their spectra.\nThis notebook demonstrates how to use it.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"O3sQMMOnFz"}],"key":"nRb9NUJ2h3"},{"type":"heading","depth":2,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"1. Learning Goals","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"tgskz61mZC"}],"identifier":"id-1-learning-goals","label":"1. Learning Goals","html_id":"id-1-learning-goals","implicit":true,"key":"llyNMDdZ5v"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":23,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"Search and download SPHEREx images","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"X1eGJAwJDq"}],"key":"ctITSPrrC2"}],"key":"Uj3XZkJF55"},{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"Implement a simple image subtraction to find red sources in the SPHEREx images","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"H5giEP5x4f"}],"key":"VFg2V1HkET"}],"key":"Iljmn7On1t"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"Visualize images and catalog data in ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"iCc2eIn7rq"},{"type":"emphasis","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"deDzVgMGGT"}],"key":"peGVkILwq2"},{"type":"text","value":" as well as interactive ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"qCQ4WBiqYe"},{"type":"emphasis","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"VirwUh5MMt"}],"key":"QaG4P8poDY"},{"type":"text","value":" plots.","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"mzA9tfqhZc"}],"key":"myJom0Ekjy"}],"key":"Pade3iLzPJ"},{"type":"listItem","spread":true,"position":{"start":{"line":29,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"Select sources interactively and extract their SPHEREx spectra","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"i9LKmGhi6Y"}],"key":"P3PSsac33H"}],"key":"Lhhigg79Xq"}],"key":"fLBZPzsdXJ"}],"key":"zoYd9PhcMb"},{"type":"block","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"2. SPHEREx Overview","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"W2DuBRQx7T"}],"identifier":"id-2-spherex-overview","label":"2. SPHEREx Overview","html_id":"id-2-spherex-overview","implicit":true,"key":"nbvRkrfKtG"},{"type":"paragraph","position":{"start":{"line":35,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"SPHEREx is a NASA Astrophysics Medium Explorer mission that launched in March 2025.\nDuring its planned two-year mission, SPHEREx will obtain 0.75-5 micron spectroscopy over the entire sky, with deeper data in the SPHEREx Deep Fields.\nSPHEREx data will be used to:","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"SG4aAbtkBj"}],"key":"K529H5q59q"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":39,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"constrain the physics of inflation","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"etj1m79N2x"}],"key":"DEZk6ZG40o"},{"type":"text","value":" by measuring its imprints on the three-dimensional large-scale distribution of matter,","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"S3jmkwv0Fo"}],"key":"QI7kzyTer3"}],"key":"Ar7twuZa8k"},{"type":"listItem","spread":true,"position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"text","value":"trace the history of galactic light production","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"cEauwt1Weq"}],"key":"Smke6L1kwC"},{"type":"text","value":" through a deep multi-band measurement of large-scale clustering,","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"VsayXhkiVY"}],"key":"R05297cI1a"}],"key":"aNIQ89pl6g"},{"type":"listItem","spread":true,"position":{"start":{"line":41,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"investigate the abundance and composition of water and biogenic ices","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"IJVtNBS692"}],"key":"Tx63oGHrKr"},{"type":"text","value":" in the early phases of star and planetary disk formation.","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"key":"g0cCXnnDUO"}],"key":"MNXKejyNCo"}],"key":"rfzHFZSSDF"}],"key":"TjOSCspJzz"},{"type":"paragraph","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"children":[{"type":"text","value":"The community will also mine SPHEREx data and combine it with synergistic data sets to address a variety of additional topics in astrophysics.","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"key":"bnzglpKKAx"}],"key":"YnEM8FjlKi"},{"type":"paragraph","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"More information is available in the ","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"AeLe04he8Q"},{"type":"link","url":"https://irsa.ipac.caltech.edu/data/SPHEREx/docs/SPHEREx_Expsupp_QR.pdf","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"SPHEREx Explanatory Supplement","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"fgjTjCepuH"}],"urlSource":"https://irsa.ipac.caltech.edu/data/SPHEREx/docs/SPHEREx_Expsupp_QR.pdf","key":"dSVvmmQLoN"},{"type":"text","value":".","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"lamPRgLUNx"}],"key":"QNpGGzWWzV"}],"key":"qut8cJdd1c"},{"type":"block","position":{"start":{"line":47,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":49,"column":1},"end":{"line":49,"column":1}},"children":[{"type":"text","value":"3. Requirements","position":{"start":{"line":49,"column":1},"end":{"line":49,"column":1}},"key":"GnXkugqGE6"}],"identifier":"id-3-requirements","label":"3. Requirements","html_id":"id-3-requirements","implicit":true,"key":"z8hN2izx42"}],"key":"s4HCugRrYH"},{"type":"block","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"children":[{"type":"heading","depth":3,"position":{"start":{"line":53,"column":1},"end":{"line":53,"column":1}},"children":[{"type":"text","value":"3.1 On local machines","position":{"start":{"line":53,"column":1},"end":{"line":53,"column":1}},"key":"WbuyiedZVi"}],"identifier":"id-3-1-on-local-machines","label":"3.1 On local machines","html_id":"id-3-1-on-local-machines","implicit":true,"key":"Gj7kJtNSkv"},{"type":"paragraph","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"children":[{"type":"text","value":"All necessary packages and tools (e.g., ","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"k9fgFzsGHU"},{"type":"inlineCode","value":"SExtractor","key":"SQ8zkE1L4y"},{"type":"text","value":") are listed in the ","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"syUf2SHAUi"},{"type":"inlineCode","value":"conda-spherex_sdt.yml","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"ukcdazZi7Y"},{"type":"text","value":" file.","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"TUSLQvs5Ll"}],"key":"hBHEpIjBYx"},{"type":"paragraph","position":{"start":{"line":57,"column":1},"end":{"line":57,"column":1}},"children":[{"type":"text","value":"To create a conda environment with the dependencies on your local machine use:","position":{"start":{"line":57,"column":1},"end":{"line":57,"column":1}},"key":"CQZ0oO4jUZ"}],"key":"XQSVgOwiUv"},{"type":"code","lang":"","value":"conda env create --file conda-spherex_sdt.yml","position":{"start":{"line":58,"column":1},"end":{"line":60,"column":1}},"key":"ZVOVRFjAVr"},{"type":"paragraph","position":{"start":{"line":62,"column":1},"end":{"line":62,"column":1}},"children":[{"type":"text","value":"Then, make the environment available in the list of kernels for your JupyterLab:","position":{"start":{"line":62,"column":1},"end":{"line":62,"column":1}},"key":"tBhGzRfWnl"}],"key":"nJjDxgfqtn"},{"type":"code","lang":"","value":"conda activate spherex_sdt\npython -m ipykernel install --user --name=spherex_sdt","position":{"start":{"line":63,"column":1},"end":{"line":66,"column":1}},"key":"rD1fi3JAcD"},{"type":"paragraph","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"text","value":"To use the environment in your Jupyter notebooks, either start JupyterLab in that environment by typing","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"sEs0pi8VVi"}],"key":"CSKoL5GiZM"},{"type":"code","lang":"","value":"conda activate spherex_sdt\njupyter-lab","position":{"start":{"line":70,"column":1},"end":{"line":73,"column":1}},"key":"Ze9sMks6JU"},{"type":"paragraph","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"children":[{"type":"text","value":"or select the environment ","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"b3krhgRxFU"},{"type":"inlineCode","value":"spherex_sdt","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"ZshP7jNka7"},{"type":"text","value":" in your Jupyter Notebook using the dropdown on the upper left.","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"wRNaeee22T"}],"key":"Bk7kiTalUh"},{"type":"heading","depth":3,"position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"3.2 On Fornax","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"dpD3Gk3lQc"}],"identifier":"id-3-2-on-fornax","label":"3.2 On Fornax","html_id":"id-3-2-on-fornax","implicit":true,"key":"PQUXwduIWe"},{"type":"paragraph","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"text","value":"Installing the conda environment on the ","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"oQMQXhzGkB"},{"type":"link","url":"https://science.nasa.gov/astrophysics/programs/physics-of-the-cosmos/community/the-fornax-initiative/","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"text","value":"NASA Fornax Science Console","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"AZwevCAiea"}],"urlSource":"https://science.nasa.gov/astrophysics/programs/physics-of-the-cosmos/community/the-fornax-initiative/","key":"ntPogu0pBV"},{"type":"text","value":" needs slightly different steps. These can be reviewed in the documentation ","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"RcRBrKETbi"},{"type":"link","url":"https://docs.fornax.sciencecloud.nasa.gov/compute-environments/#create-new-env","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"text","value":"create a new environment","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"XVmcSMjOfK"}],"urlSource":"https://docs.fornax.sciencecloud.nasa.gov/compute-environments/#create-new-env","key":"nJH4H47Rsb"},{"type":"text","value":".","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"Qbux3HZg7i"}],"key":"zAcYalUBuT"},{"type":"paragraph","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"text","value":"In order to install this specific conda environment on Fornax, the file name of the ","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"Ax1irxsLxd"},{"type":"inlineCode","value":"yml","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"kXOAKdatIW"},{"type":"text","value":" file specifically needs to be in the format ","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"BGdYdwrt4s"},{"type":"inlineCode","value":"conda-*.yml","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"bTZquk7cYw"},{"type":"text","value":". The ","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"H2C80KIYq7"},{"type":"inlineCode","value":"yml","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"VY3A21wkbD"},{"type":"text","value":" file distributed here is already provided in that format (","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"HnvvDw4QnK"},{"type":"inlineCode","value":"conda-spherex_sdt.yml","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"y6rlO1mXcG"},{"type":"text","value":"). Once this is set, open a new terminal (click on the large “+” button right under the “File” menu tab) and type to following command ","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"T9GM3jzpiW"},{"type":"emphasis","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"text","value":"inside","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"YAuEM9kqH5"}],"key":"Zg0QjlIild"},{"type":"text","value":" the same directory where the ","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"SrJ9ELxtPh"},{"type":"inlineCode","value":"yml","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"npg464Rj3d"},{"type":"text","value":" file is located:","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"w2hBeDpSug"}],"key":"GAqGlfmLFc"},{"type":"code","lang":"","value":"setup-conda-env --user","position":{"start":{"line":83,"column":1},"end":{"line":85,"column":1}},"key":"feQSgSw15I"},{"type":"paragraph","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"children":[{"type":"text","value":"Note that we use the ","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"KmMOYcRJE1"},{"type":"inlineCode","value":"--user","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"hrKOycO3x8"},{"type":"text","value":" option here, which will keep the environment available for subsequent Fornax sessions.","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"pAsb0qadH9"}],"key":"PR0PZVWlIC"},{"type":"paragraph","position":{"start":{"line":89,"column":1},"end":{"line":89,"column":1}},"children":[{"type":"text","value":"To use the environment in your Jupyter notebooks on Fornax, directly select the environment ","position":{"start":{"line":89,"column":1},"end":{"line":89,"column":1}},"key":"IlLG5EHyvV"},{"type":"inlineCode","value":"spherex_sdt","position":{"start":{"line":89,"column":1},"end":{"line":89,"column":1}},"key":"jMPxOTHhkD"},{"type":"text","value":" in your Jupyter Notebook using the dropdown on the upper left.","position":{"start":{"line":89,"column":1},"end":{"line":89,"column":1}},"key":"vky6VRNeSy"}],"key":"Iqy0M2D0Kt"}],"key":"NcJSNiY3c2"},{"type":"block","position":{"start":{"line":91,"column":1},"end":{"line":91,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"children":[{"type":"text","value":"4. Imports","position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"key":"uGu1Gz79pa"}],"identifier":"id-4-imports","label":"4. Imports","html_id":"id-4-imports","implicit":true,"key":"sJQELVcEbz"}],"key":"UFL93eV1cm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Standard library imports\nimport concurrent.futures\nimport copy\nimport json\nimport os\nimport io\nimport pickle\nimport time\nfrom concurrent.futures import as_completed\n\n# Related 3rd-party imports\nimport numpy as np\nimport pyvo\nimport sep\nimport astropy.units as u\nfrom astropy.coordinates import SkyCoord\nfrom astropy.io import fits\nfrom astropy.nddata import Cutout2D\nfrom astropy.table import Table\nfrom astropy.units import Unit\nfrom astropy.wcs import WCS\nfrom astroquery.ipac.irsa import Irsa\nfrom bokeh.io import output_notebook\nfrom bokeh.resources import INLINE\nfrom firefly_client import FireflyClient\nfrom reproject import reproject_exact, reproject_interp\n\n# Local application imports\nfrom spherex_source_discovery_tool.aperture_photometry import build_phot_table, grab_star\nfrom spherex_source_discovery_tool.bokeh_viz import (\n    plot_apertures, plot_spectrum, plot_subtracted_trio, plot_overlap_trio)\nfrom spherex_source_discovery_tool.firefly_viz import preview_query\nfrom spherex_source_discovery_tool.sdt_utils import (\n    format_extracted, get_filename, get_exp_id, get_obs_id, results_summary, get_lambda_range)\nfrom spherex_source_discovery_tool.source_extraction import run_sextractor, get_sextractor_file","key":"qdd24moTna"},{"type":"outputs","id":"Aopu9N2UhPYditZkEAC9p","children":[],"key":"KuIVvcadYs"}],"key":"VAeZ11kXQM"},{"type":"block","children":[],"key":"ckYV3zXCBz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Suppress logging temporarily to prevent astropy\n# from repeatedly printing out warning notices related to alternate WCSs\nimport logging\nlogging.getLogger('astropy').setLevel(logging.ERROR)\n\n# The time it takes to read SPHEREx files can exceed\n# astropy's default timeout limit. Increase it.\nfrom astropy.utils.data import conf\nconf.remote_timeout = 120\n\n# For interactive bokeh visualizations\noutput_notebook(resources=INLINE)","key":"goB8u6IllV"},{"type":"outputs","id":"d5mWV7TjRQjb_DV8PcyFL","children":[],"key":"ZjPD2dyUaB"}],"key":"usfVUVitO4"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":148,"column":1},"end":{"line":148,"column":1}},"children":[{"type":"text","value":"5. Initialize Ephemeral Query Parameters","position":{"start":{"line":148,"column":1},"end":{"line":148,"column":1}},"key":"XzcpbMbvhm"}],"identifier":"id-5-initialize-ephemeral-query-parameters","label":"5. Initialize Ephemeral Query Parameters","html_id":"id-5-initialize-ephemeral-query-parameters","implicit":true,"key":"h7RdbjjBox"},{"type":"admonition","kind":"attention","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Attention","key":"FSeTnO6psV"}],"key":"sqJ8P9DovK"},{"type":"paragraph","position":{"start":{"line":151,"column":1},"end":{"line":152,"column":1}},"children":[{"type":"text","value":"The query parameters below are valid as of ","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"key":"mXFS4nULVM"},{"type":"strong","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"children":[{"type":"text","value":"February 2026","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"key":"kJb1tA7mnz"}],"key":"IeGkbIrp7g"},{"type":"text","value":", but will need to be updated as the mission proceeds.\nSpecifically, the ephemeral query parameters ","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"key":"WmNUPk06EJ"},{"type":"emphasis","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"children":[{"type":"text","value":"will","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"key":"MTNdsTssyX"}],"key":"kuZscbkLGA"},{"type":"text","value":" change for future SPHEREx data releases.","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"key":"ElHhfrYDuE"}],"key":"Er9fyOEsNd"}],"key":"EEWyUQaVfs"}],"key":"MRS5AnFDES"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# General\ndata_release = \"qr2\"\n\n# Spectral image queries\nsia_collection = f\"spherex_{data_release}\"\n\n# Solid angle pixel map queries\ndataset_type=\"solid_angle_pixel_map\"\nsapm_collection = \"cal-sapm-v2-2025-164\"\nsapm_s3 = [\n    f\"nasa-irsa-spherex/{data_release}/{dataset_type}/{sapm_collection}/{k}/\"\\\n    f\"{dataset_type}_D{k}_spx_{sapm_collection}.fits\" for k in range(1, 7)\n]","key":"reIpbTlEyp"},{"type":"outputs","id":"ApRgSOPGvS__R6IgAmJEW","children":[],"key":"wg0q4URFDU"}],"key":"s0kag0mGII"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":171,"column":1},"end":{"line":171,"column":1}},"children":[{"type":"text","value":"6. Search for SPHEREx Spectral Images","position":{"start":{"line":171,"column":1},"end":{"line":171,"column":1}},"key":"MsRVJ7GWug"}],"identifier":"id-6-search-for-spherex-spectral-images","label":"6. Search for SPHEREx Spectral Images","html_id":"id-6-search-for-spherex-spectral-images","implicit":true,"key":"vSS1g4tlTh"}],"key":"FKphVOVwa3"},{"type":"block","position":{"start":{"line":173,"column":1},"end":{"line":173,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":175,"column":1},"end":{"line":175,"column":1}},"children":[{"type":"text","value":"We search first search for all the available SPHEREx images around a given position on the sky.","position":{"start":{"line":175,"column":1},"end":{"line":175,"column":1}},"key":"rfrpHdGfWH"}],"key":"NAzsKycqFl"},{"type":"paragraph","position":{"start":{"line":177,"column":1},"end":{"line":177,"column":1}},"children":[{"type":"text","value":"Here, we choose the random position at R.A. = 150.7817877 degrees and Decl. = 3.3502204 degrees, which is close to the COSMOS field. We also choose a search radius of 50 arc-seconds.","position":{"start":{"line":177,"column":1},"end":{"line":177,"column":1}},"key":"H7LaIYqrpg"}],"key":"WjTdYTWCI9"}],"key":"SoxK3FFAEf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"coord = SkyCoord(150.7817877, 3.3502204, unit='deg')\nsearch_radius = 50 * u.arcsec","key":"QhXbODbBnw"},{"type":"outputs","id":"1qwHxjE8XcwtExwhsmtDG","children":[],"key":"mrEil0TIyC"}],"key":"kJZ7sS2Tmx"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":184,"column":1},"end":{"line":185,"column":1}},"children":[{"type":"text","value":"We then search for the SPHEREx spectral images that overlap with the position in the search radius defined above.\nFor this we use the ","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"vH6aq7Fx2N"},{"type":"link","url":"https://astroquery.readthedocs.io/en/latest/ipac/irsa/irsa.html","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"children":[{"type":"text","value":"IRSA module in astroquery","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"kOeR0Yzqws"}],"urlSource":"https://astroquery.readthedocs.io/en/latest/ipac/irsa/irsa.html","key":"Y3DHih33eY"},{"type":"text","value":" and the Simple Image Access (SIA) API.","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"lGmIORiBjM"}],"key":"ll66C9M6zD"}],"key":"IQFiPiAsAX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"results = Irsa.query_sia(pos=(coord, search_radius), collection=sia_collection)\nresults_summary(results)","key":"r2OjCl2bH7"},{"type":"outputs","id":"xDfvwXZuVBr2cWwGstdiH","children":[],"key":"O8os6eBf3q"}],"key":"ji147no2tg"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"children":[{"type":"text","value":"Note that we have used the collection ","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"mGN8mcXRrA"},{"type":"inlineCode","value":"spherex_qr2","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"RnSwzm9nSd"},{"type":"text","value":" in this case. All the available collections are documented at ","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"LpZAXyP65b"},{"type":"link","url":"https://caltech-ipac.github.io/spherex-archive-documentation/spherex-data-access#application-program-interfaces-apis","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"children":[{"type":"text","value":"SPHEREx Data Access: Application Program Interfaces (APIs)","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"SFJwWFxrSf"}],"urlSource":"https://caltech-ipac.github.io/spherex-archive-documentation/spherex-data-access#application-program-interfaces-apis","key":"DElCL6Mc6Q"},{"type":"text","value":".","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"jbYClOLqYi"}],"key":"kMsbHSgNvr"}],"key":"efBp1BjbUH"},{"type":"block","position":{"start":{"line":193,"column":1},"end":{"line":193,"column":1}},"children":[{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"GP6rfAwWct"}],"key":"jBanQMc5rr"},{"type":"paragraph","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"children":[{"type":"text","value":"The IRSA SIA collections can be listed using using the ","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"ECGt2orB3A"},{"type":"inlineCode","value":"list_collections","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"dIyryATIOp"},{"type":"text","value":" method, we can filter on the ones containing “spherex” in the collection name:","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"ReNqCLHmj2"}],"key":"kXHyz6zt20"},{"type":"code","lang":"","value":"Irsa.list_collections(filter='spherex')","position":{"start":{"line":198,"column":1},"end":{"line":198,"column":1}},"key":"V2yLDMUC8W"}],"key":"DJx555ykHO"}],"key":"om0BumiX5Y"},{"type":"block","position":{"start":{"line":201,"column":1},"end":{"line":201,"column":1}},"children":[],"key":"n2wKIoRPnG"},{"type":"block","position":{"start":{"line":203,"column":1},"end":{"line":203,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":205,"column":1},"end":{"line":205,"column":1}},"children":[{"type":"text","value":"Next, we set up the ","position":{"start":{"line":205,"column":1},"end":{"line":205,"column":1}},"key":"NWOWIxlY93"},{"type":"emphasis","position":{"start":{"line":205,"column":1},"end":{"line":205,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":205,"column":1},"end":{"line":205,"column":1}},"key":"FkqpWkyVZa"}],"key":"jEzwHp2ruR"},{"type":"text","value":" client and use it to visualize one image with the search coordinates (and search radius) indicated.","position":{"start":{"line":205,"column":1},"end":{"line":205,"column":1}},"key":"cdVG8IHnei"}],"key":"Lpal2nSytK"},{"type":"paragraph","position":{"start":{"line":207,"column":1},"end":{"line":207,"column":1}},"children":[{"type":"text","value":"There are two ways to run ","position":{"start":{"line":207,"column":1},"end":{"line":207,"column":1}},"key":"k0RI6eiB2z"},{"type":"emphasis","position":{"start":{"line":207,"column":1},"end":{"line":207,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":207,"column":1},"end":{"line":207,"column":1}},"key":"SMOx3am9OX"}],"key":"uxhAcbYM3p"},{"type":"text","value":" from the JupyterLab environment:","position":{"start":{"line":207,"column":1},"end":{"line":207,"column":1}},"key":"qoA0oUU6KE"}],"key":"mnIbRgQ99d"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":208,"column":1},"end":{"line":210,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Open it in another browser tab","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"WJj6KwcfDC"}],"key":"ZWwtC6HEmW"}],"key":"eoltK7jPBL"},{"type":"listItem","spread":true,"position":{"start":{"line":209,"column":1},"end":{"line":210,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Open it in another Jupyter Notebook tab","position":{"start":{"line":209,"column":1},"end":{"line":209,"column":1}},"key":"t04onPgfuc"}],"key":"uXdFwyoso2"}],"key":"pbUaHy2aFI"}],"key":"v5omVCQ5vO"},{"type":"paragraph","position":{"start":{"line":211,"column":1},"end":{"line":212,"column":1}},"children":[{"type":"text","value":"The second option requires setting some environment variables and installing the ","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"j5QEfbGrE3"},{"type":"emphasis","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"j1qwSuf70P"}],"key":"TuUvjRru5e"},{"type":"text","value":" JupyterLab extension. See ","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"u9iIjeyS4Y"},{"type":"link","url":"https://github.com/Caltech-IPAC/jupyter_firefly_extensions/blob/master/README.md","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"rHhqCU6JwN"}],"urlSource":"https://github.com/Caltech-IPAC/jupyter_firefly_extensions/blob/master/README.md","data":{"kind":"file","org":"Caltech-IPAC","repo":"jupyter_firefly_extensions","reference":"master","file":"README.md","raw":"https://raw.githubusercontent.com/Caltech-IPAC/jupyter_firefly_extensions/master/README.md"},"internal":false,"protocol":"github","key":"Y6zuD8CkXP"},{"type":"text","value":" for more information on how to do that.\nMore information can be found in the ","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"vB0o1L2nGI"},{"type":"link","url":"https://caltech-ipac.github.io/firefly_client/usage/","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"OnSPtYZtZC"}],"key":"KWzk6hTAye"},{"type":"text","value":" documentation","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"zmOCRW4DVO"}],"urlSource":"https://caltech-ipac.github.io/firefly_client/usage/","key":"AXcCwnO0UJ"},{"type":"text","value":".","position":{"start":{"line":211,"column":1},"end":{"line":211,"column":1}},"key":"F7Zj2YC1fP"}],"key":"V2ThDAfQdn"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"pieMnkPZ2S"}],"key":"rm2gkYQnpe"},{"type":"paragraph","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"children":[{"type":"text","value":"If you open ","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"oHkh30L8nn"},{"type":"emphasis","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"JmZHc8upaj"}],"key":"OWIAvjt7D5"},{"type":"text","value":" in a new Jupyter Notebook tab, you can drag the ","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"o5iQco9Ccl"},{"type":"emphasis","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"CKDY0FJ0SM"}],"key":"EvWMALtNYD"},{"type":"text","value":" tab to the right to enable split view. That way you can see the ","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"oLcgT8PuyK"},{"type":"emphasis","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"N9MMosA25k"}],"key":"GQ5XmwxLHL"},{"type":"text","value":" window next to this notebook, which makes it more convenient for visualization.","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"XVP1A1TlXy"}],"key":"OydpElMDxz"}],"key":"Zwk5S7NkQF"},{"type":"paragraph","position":{"start":{"line":219,"column":1},"end":{"line":219,"column":1}},"children":[{"type":"text","value":"Below, we give the two options to open ","position":{"start":{"line":219,"column":1},"end":{"line":219,"column":1}},"key":"TD9qzMcram"},{"type":"emphasis","position":{"start":{"line":219,"column":1},"end":{"line":219,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":219,"column":1},"end":{"line":219,"column":1}},"key":"dcf5YJ2JuC"}],"key":"KAGquCrszM"},{"type":"text","value":".","position":{"start":{"line":219,"column":1},"end":{"line":219,"column":1}},"key":"DtOkOgmLT0"}],"key":"tGTWk19j3h"}],"key":"ATcEESmzgl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Set up Firefly client to open in a new browser tab\n#fc = FireflyClient.make_client(url=\"https://irsa.ipac.caltech.edu/irsaviewer\")\n\n# Set up Firefly client to open in new JupyterLab tab\nfc = FireflyClient.make_lab_client()\n\n# Initiate Firefly\nfc.reinit_viewer()\n\n# Show image\npreview_query(fc, results['access_url'][0], coord, search_radius)","key":"g4AecYQJVn"},{"type":"outputs","id":"zNN79Izr0bl_0jjIbj32V","children":[],"key":"V90hTX1pCX"}],"key":"nJEapYekd4"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":235,"column":1},"end":{"line":236,"column":1}},"children":[{"type":"text","value":"Now, we select two images, one each in Detector 2 (D2) and Detector (D4). For simplicity, we just select the first image in Detector 2 and the first in Detector 4.\nDetector 2 covers 1.10 - 1.62 ","position":{"start":{"line":235,"column":1},"end":{"line":235,"column":1}},"key":"fDVHr3A6FF"},{"type":"inlineMath","value":"\\mu","position":{"start":{"line":235,"column":1},"end":{"line":235,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">μ</span></span></span></span>","key":"JvdAl4KMEP"},{"type":"text","value":"m and Detector 4 covers 2.42 - 3.82 ","position":{"start":{"line":235,"column":1},"end":{"line":235,"column":1}},"key":"EZOAqe0FSi"},{"type":"inlineMath","value":"\\mu","position":{"start":{"line":235,"column":1},"end":{"line":235,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">μ</span></span></span></span>","key":"CAc3XXQBHB"},{"type":"text","value":"m.","position":{"start":{"line":235,"column":1},"end":{"line":235,"column":1}},"key":"fQjTb7L4hM"}],"key":"nHi0wbGqIw"},{"type":"paragraph","position":{"start":{"line":238,"column":1},"end":{"line":238,"column":1}},"children":[{"type":"text","value":"We can use two different methods to obtain the images:","position":{"start":{"line":238,"column":1},"end":{"line":238,"column":1}},"key":"IVwAsOJiQS"}],"key":"rkJUyEvQ4y"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":239,"column":1},"end":{"line":241,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"using a boolean mask selecting ","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"Ec4cVOTJVi"},{"type":"inlineCode","value":"energy_bandpassname","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"DLX8GQxe8l"},{"type":"text","value":" as “SPHEREx_D2”","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"Y7Dtq7Dk4c"}],"key":"Jt1Y45ORNq"}],"key":"Lfz3VK4kns"},{"type":"listItem","spread":true,"position":{"start":{"line":240,"column":1},"end":{"line":241,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"using the ","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"key":"XQAuOynLp3"},{"type":"inlineCode","value":"astropy.table.TableGroups","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"key":"MTYMyaLTun"}],"key":"iky4teFmFR"}],"key":"pm1xSuJgPS"}],"key":"MMf4Vlp2i7"},{"type":"paragraph","position":{"start":{"line":242,"column":1},"end":{"line":242,"column":1}},"children":[{"type":"text","value":"We show both methods below, the first one for the detector 2 spectral image and the second one for the detector 4 spectral image.","position":{"start":{"line":242,"column":1},"end":{"line":242,"column":1}},"key":"RV5uxFPuUm"}],"key":"lPttLcGxV9"}],"key":"nyC7HgfJKl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Using a boolean mask\nd2_result = results[results['energy_bandpassname'] == 'SPHEREx-D2'][0]  # first D2 image\n\n# Using `astropy.table.TableGroups`\nresults_by_detector = results.group_by('energy_bandpassname')\nprint(results_by_detector.groups.keys)\nd4_result = results_by_detector.groups[3][0]  # first D4 image","key":"cqPpHTydDb"},{"type":"outputs","id":"l7qQC5B0c4cZLVaSWs2mj","children":[],"key":"vdYsV6prLX"}],"key":"dVv85CFJR7"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"children":[{"type":"text","value":"7. Load the Data","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"key":"sTqTPuc3RD"}],"identifier":"id-7-load-the-data","label":"7. Load the Data","html_id":"id-7-load-the-data","implicit":true,"key":"FCnX8HGmRZ"},{"type":"paragraph","position":{"start":{"line":256,"column":1},"end":{"line":256,"column":1}},"children":[{"type":"text","value":"Next, we download the two SPHEREx spectral images. We download them directly from the cloud.","position":{"start":{"line":256,"column":1},"end":{"line":256,"column":1}},"key":"xmeZwC7Jjb"}],"key":"iOMuv1ccy2"},{"type":"paragraph","position":{"start":{"line":258,"column":1},"end":{"line":258,"column":1}},"children":[{"type":"text","value":"For this, we first define a handy function to obtain the S3 cloud path.","position":{"start":{"line":258,"column":1},"end":{"line":258,"column":1}},"key":"jmaGDwxjcZ"}],"key":"o7O7I0FEBf"}],"key":"oZgYMUTrYw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Function to access data from cloud\ndef get_s3_fpath(cloud_access):\n    cloud_info = json.loads(cloud_access) # converts str to dict\n    bucket_name = cloud_info['aws']['bucket_name']\n    key = cloud_info['aws']['key']\n    return f'{bucket_name}/{key}'","key":"xiLASgqcZW"},{"type":"outputs","id":"elvMOt3z1M18Lulr-hi8t","children":[],"key":"LO5dhUVQdp"}],"key":"hQ8864x87I"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":269,"column":1},"end":{"line":269,"column":1}},"children":[{"type":"text","value":"Next we download the images.","position":{"start":{"line":269,"column":1},"end":{"line":269,"column":1}},"key":"rMRz3seJxD"}],"key":"MwDzcALToM"}],"key":"Qp05lHfOuR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# HDUs for D2 image\ns3_fpath_d2 = get_s3_fpath(d2_result['cloud_access'])\nwith fits.open(f's3://{s3_fpath_d2}', fsspec_kwargs={\"anon\": True}) as hdul2:\n    img_hdu2 = hdul2[\"IMAGE\"].copy()\n    img_data2 = hdul2[\"IMAGE\"].data\n    img_hdr2 = hdul2[\"IMAGE\"].header\n    flags_data2 = hdul2[\"FLAGS\"].data\n\n# HDUs for D4 image\ns3_fpath_d4 = get_s3_fpath(d4_result['cloud_access'])\nwith fits.open(f's3://{s3_fpath_d4}', fsspec_kwargs={\"anon\": True}) as hdul4:\n    img_hdu4 = hdul4[\"IMAGE\"].copy()\n    img_data4 = hdul4[\"IMAGE\"].data\n    img_hdr4 = hdul4[\"IMAGE\"].header\n    flags_data4 = hdul4[\"FLAGS\"].data","key":"jTG37ez7x5"},{"type":"outputs","id":"hkhy0uguzOE_MO4XlUHCl","children":[],"key":"I350x5fmJF"}],"key":"IosdZNXNGu"},{"type":"block","children":[{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"XJLmeFHHjC"}],"key":"fRaCIt3Zl9"},{"type":"paragraph","position":{"start":{"line":290,"column":1},"end":{"line":290,"column":1}},"children":[{"type":"text","value":"If you want to download the SPHEREx spectral images from IPAC directly (not from the cloud), simply use instead, for example,","position":{"start":{"line":290,"column":1},"end":{"line":290,"column":1}},"key":"urq5OoOwIL"}],"key":"elCGbvkYng"},{"type":"code","lang":"","value":"with fits.open(d2_result['access_url']) as hdul2:\n    ...","position":{"start":{"line":293,"column":1},"end":{"line":294,"column":1}},"key":"IQaTCWq4z8"}],"key":"cocxlJpxuI"}],"key":"qs7irm3CVs"},{"type":"block","position":{"start":{"line":299,"column":1},"end":{"line":299,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"children":[{"type":"text","value":"8. Remove Local Background, Create Masks, and Reproject","position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"key":"Rbg1KP5uEd"}],"identifier":"id-8-remove-local-background-create-masks-and-reproject","label":"8. Remove Local Background, Create Masks, and Reproject","html_id":"id-8-remove-local-background-create-masks-and-reproject","implicit":true,"key":"YNU2urg215"},{"type":"paragraph","position":{"start":{"line":303,"column":1},"end":{"line":303,"column":1}},"children":[{"type":"text","value":"Before we can subtract the images, we have to do some preprocessing. This includes:","position":{"start":{"line":303,"column":1},"end":{"line":303,"column":1}},"key":"IYwhhTslSB"}],"key":"drbScvwPoZ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":304,"column":1},"end":{"line":308,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":304,"column":1},"end":{"line":304,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Converting from surface brightness to flux density units","position":{"start":{"line":304,"column":1},"end":{"line":304,"column":1}},"key":"soeVwH8ktW"}],"key":"C2O46sttMw"}],"key":"CQFP1lRP25"},{"type":"listItem","spread":true,"position":{"start":{"line":305,"column":1},"end":{"line":305,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Removing the background","position":{"start":{"line":305,"column":1},"end":{"line":305,"column":1}},"key":"WJCEWlwSYh"}],"key":"oSmDZIlVWN"}],"key":"wiXrQVDP3f"},{"type":"listItem","spread":true,"position":{"start":{"line":306,"column":1},"end":{"line":306,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Creating masks to mask out bad pixels","position":{"start":{"line":306,"column":1},"end":{"line":306,"column":1}},"key":"zqTUpU8MNZ"}],"key":"fdoZewSOGr"}],"key":"hIiMqRUqSR"},{"type":"listItem","spread":true,"position":{"start":{"line":307,"column":1},"end":{"line":308,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Reproject the images on a common pixel grid (necessary for pixel-by-pixel subtraction of images later)","position":{"start":{"line":307,"column":1},"end":{"line":307,"column":1}},"key":"kS8C54GHLt"}],"key":"QFSzW0eLpi"}],"key":"Hqqup2EC79"}],"key":"EXIWcg0yVw"},{"type":"paragraph","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"children":[{"type":"text","value":"First, we convert from surface brightness to flux units using the solid angle pixel map for each detector. We download these calibrations from the cloud using the S3 paths hardcoded below. Then, we use ","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"key":"HBPZwuahDU"},{"type":"inlineCode","value":"astropy.units","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"key":"g01GQH0Yso"},{"type":"text","value":" to convert the image data from MJy/sr to ","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"key":"u9uO16YmWq"},{"type":"inlineMath","value":"\\mu","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">μ</span></span></span></span>","key":"u6Cj8lQOG2"},{"type":"text","value":"Jy/arcsec","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"key":"Kr7FMJMdOh"},{"type":"inlineMath","value":"^2","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span>","key":"uOpA3qvhT6"},{"type":"text","value":". This quantity is multiplied by the solid angle pixel map in arcsec","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"key":"BQAlf8tIJ4"},{"type":"inlineMath","value":"^2","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span>","key":"VtZnhxPOHs"},{"type":"text","value":" to get image data in units of ","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"key":"NaTz8Iy2gX"},{"type":"inlineMath","value":"\\mu","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">μ</span></span></span></span>","key":"SdV5tBmY16"},{"type":"text","value":"Jy.","position":{"start":{"line":309,"column":1},"end":{"line":309,"column":1}},"key":"Le9Cexb6Ha"}],"key":"LRWKm12p9E"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"yBdPgydbLA"}],"key":"Y6vVjcyyIy"},{"type":"paragraph","position":{"start":{"line":312,"column":1},"end":{"line":313,"column":1}},"children":[{"type":"text","value":"You can find more calibration products for the SPHEREx spectral images on the S3 bucket:\n","position":{"start":{"line":312,"column":1},"end":{"line":312,"column":1}},"key":"EbfBydRDIA"},{"type":"link","url":"https://nasa-irsa-spherex.s3.us-east-1.amazonaws.com/index.html","position":{"start":{"line":312,"column":1},"end":{"line":312,"column":1}},"children":[{"type":"text","value":"https://​nasa​-irsa​-spherex​.s3​.us​-east​-1​.amazonaws​.com​/index​.html","position":{"start":{"line":312,"column":1},"end":{"line":312,"column":1}},"key":"IclHJ0AUx6"}],"urlSource":"https://nasa-irsa-spherex.s3.us-east-1.amazonaws.com/index.html","key":"z3Tm4gBEzH"}],"key":"qNxtMs8o3C"}],"key":"RG6aqq3ExT"}],"key":"tnLWhu3WhV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"s3_fpath_sapm2 = sapm_s3[1] # list idx 1 is value for D2 path\nwith fits.open(f's3://{s3_fpath_sapm2}', fsspec_kwargs={\"anon\": True}) as hdul_sapm2:\n    sapm_data2 = hdul_sapm2[\"IMAGE\"].data\n    sapm_hdr2 = hdul_sapm2[\"IMAGE\"].header\n\ns3_fpath_sapm4 = sapm_s3[3] # list idx 3 is value for D4 path\nwith fits.open(f\"s3://{s3_fpath_sapm4}\", fsspec_kwargs={\"anon\": True}) as hdul_sapm4:\n    sapm_data4 = hdul_sapm4[\"IMAGE\"].data\n    sapm_hdr4 = hdul_sapm4[\"IMAGE\"].header","key":"y0WVL2sf0N"},{"type":"outputs","id":"oT0dz31zqkMVHbR7LVn_9","children":[],"key":"xVbmkfGn9y"}],"key":"V3DFf9A6Sj"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":329,"column":1},"end":{"line":329,"column":1}},"children":[{"type":"text","value":"After downloading the solid angle pixel map calibration products for each detector, we convert the images from brightness (MJy/sr) to spectral flux density (","position":{"start":{"line":329,"column":1},"end":{"line":329,"column":1}},"key":"PiaUyGOtmR"},{"type":"inlineMath","value":"\\mu","position":{"start":{"line":329,"column":1},"end":{"line":329,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">μ</span></span></span></span>","key":"URpumHbXgi"},{"type":"text","value":"Jy) and update the corresponding units in the headers of the imates.","position":{"start":{"line":329,"column":1},"end":{"line":329,"column":1}},"key":"Fv4kbr5V9z"}],"key":"UOLwF22DpN"}],"key":"ApNzJQZvyH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f\"Spectral image BUNIT: {img_hdr2['BUNIT']}\")\nprint(f\"Solid angle pixel map BUNIT: {sapm_hdr2['BUNIT']}\")\n\nimg_data2 = ((img_data2 * Unit(img_hdr2[\"BUNIT\"])).to(u.uJy / u.arcsec**2) * (sapm_data2 * Unit(sapm_hdr2[\"BUNIT\"]))).value\nimg_hdu2.header[\"BUNIT\"] = \"uJy\"\nimg_hdr2[\"BUNIT\"] = \"uJy\"\n\nimg_data4 = ((img_data4 * Unit(img_hdr4[\"BUNIT\"])).to(u.uJy / u.arcsec**2) * (sapm_data4 * Unit(sapm_hdr4[\"BUNIT\"]))).value\nimg_hdu4.header[\"BUNIT\"] = \"uJy\"\nimg_hdr4[\"BUNIT\"] = \"uJy\"","key":"QIXlN9aqDE"},{"type":"outputs","id":"fTdb01M6x-DFMxJlKv2wX","children":[],"key":"gwqCgegbPw"}],"key":"GRgCCISCTb"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":344,"column":1},"end":{"line":344,"column":1}},"children":[{"type":"text","value":"Next, we remove the background from both images. We estimate the background using the ","position":{"start":{"line":344,"column":1},"end":{"line":344,"column":1}},"key":"UEpfat56r0"},{"type":"inlineCode","value":"sep","position":{"start":{"line":344,"column":1},"end":{"line":344,"column":1}},"key":"lICYR3BU7i"},{"type":"text","value":" Python package, which allows fitting a non-parametric background to an image in user-defined zones.","position":{"start":{"line":344,"column":1},"end":{"line":344,"column":1}},"key":"IRJHM9zhhv"}],"key":"qcy4s1pQeJ"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"et73Gy6Lu5"}],"key":"IPxcTUZeAn"},{"type":"paragraph","position":{"start":{"line":347,"column":1},"end":{"line":347,"column":1}},"children":[{"type":"inlineCode","value":"sep","position":{"start":{"line":347,"column":1},"end":{"line":347,"column":1}},"key":"ohYZ9qnUTw"},{"type":"text","value":" only support native byte order arrays. We therefore have to apply","position":{"start":{"line":347,"column":1},"end":{"line":347,"column":1}},"key":"qXQ0VStMbm"}],"key":"XEtH9LbhYD"},{"type":"code","lang":"","value":"img.astype(img.dtype.newbyteorder(\"=\"))","position":{"start":{"line":349,"column":1},"end":{"line":349,"column":1}},"key":"AJkTxVi1na"},{"type":"paragraph","position":{"start":{"line":351,"column":1},"end":{"line":351,"column":1}},"children":[{"type":"text","value":"before feeding it to ","position":{"start":{"line":351,"column":1},"end":{"line":351,"column":1}},"key":"qJSl6mOnxL"},{"type":"inlineCode","value":"sep","position":{"start":{"line":351,"column":1},"end":{"line":351,"column":1}},"key":"t2ztTdZH5Z"},{"type":"text","value":".","position":{"start":{"line":351,"column":1},"end":{"line":351,"column":1}},"key":"CtVk2hGa9R"}],"key":"CupUvQSo4t"}],"key":"R65wsKJjFo"}],"key":"I20jSCtDKI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"bkg2 = sep.Background(img_data2.astype(img_data2.dtype.newbyteorder(\"=\")), bw=64, bh=64, fw=11, fh=11)\nimg_data2 = img_data2 - bkg2\n\nbkg4 = sep.Background(img_data4.astype(img_data4.dtype.newbyteorder(\"=\")), bw=64, bh=64, fw=11, fh=11)\nimg_data4 = img_data4 - bkg4","key":"IeN8r7qAov"},{"type":"outputs","id":"VfQ4PDnRuNCcVfYK31RUN","children":[],"key":"wWs0Fx6FLW"}],"key":"i9s25LQFSb"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":362,"column":1},"end":{"line":366,"column":1}},"children":[{"type":"text","value":"Next we create masks (which also need to be reprojected). The merged masks will be applied later to the difference image.\nNote that flags ","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"YcCqn5eXPw"},{"type":"inlineCode","value":"2097152","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"WwtINshn6q"},{"type":"text","value":" (which corresponds to ","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"vwhflhwIJx"},{"type":"span","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"children":[{"type":"text","value":"2","key":"tgprVa21hz"},{"type":"superscript","children":[{"type":"text","value":"21","key":"xiOXN8i0YP"}],"key":"cRkKxyfeym"}],"key":"xJEga0Cjvp"},{"type":"text","value":", so bit 21), is assigned to pixel which are not contaminated by image errors, transients, cosmic rays, etc.\nNote that we ignore the ","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"SVj69REozy"},{"type":"inlineCode","value":"OVERFLOW","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"lXfcHtrCYE"},{"type":"text","value":" flag, which is coincident with the ","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"E2KXzauWVE"},{"type":"inlineCode","value":"SUR_ERROR","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"KYitZrU8YI"},{"type":"text","value":" flag. See the ","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"V1vR6HSYHf"},{"type":"link","url":"https://irsa.ipac.caltech.edu/onlinehelp/spherex/spherex/sp.html#explorebitflags","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"children":[{"type":"text","value":"SPHEREx bitmask flag description","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"MO2nPRVMuW"}],"urlSource":"https://irsa.ipac.caltech.edu/onlinehelp/spherex/spherex/sp.html#explorebitflags","key":"VFoap4SY5F"},{"type":"text","value":" for more information about the different flag bits.\nWe therefore choose these as good pixels and flag the other ones.\nFor simplicity, we set the bad pixels to ","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"TP5htWlYpe"},{"type":"inlineCode","value":"np.nan","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"BureHBMAYt"},{"type":"text","value":".","position":{"start":{"line":362,"column":1},"end":{"line":362,"column":1}},"key":"XauWKKiMIO"}],"key":"zP3tjHWnpa"}],"key":"rlNwXwmxXu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"mask2 = np.zeros(flags_data2.shape) * np.nan\nmask2[(flags_data2 == 2097152) | (flags_data2 == 2) | (flags_data2 == 0)] = 1\n\nmask4 = np.zeros(flags_data4.shape) * np.nan\nmask4[(flags_data4 == 2097152) | (flags_data2 == 2) | (flags_data4 == 0)] = 1","key":"Svx9ikM7bM"},{"type":"outputs","id":"JUesgUoZR9DTE0KIVlcSq","children":[],"key":"U1W0fExQ9q"}],"key":"styztExfkY"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"children":[{"type":"text","value":"Finally, we reproject the images and masks to the same pixel grid. We reproject D2 on D4. For this we use ","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"key":"XLkEAmLUuc"},{"type":"inlineCode","value":"reproject_exact()","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"key":"KkZVlS276B"},{"type":"text","value":" (for flux conservation) and ","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"key":"ufhpydLinN"},{"type":"inlineCode","value":"reproject_interp()","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"key":"wXM5XZtTr8"},{"type":"text","value":" (for mask) from the ","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"key":"KCufipOxwM"},{"type":"emphasis","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"children":[{"type":"text","value":"reproject","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"key":"ExrL0ckS84"}],"key":"h6FskWQWeG"},{"type":"text","value":" Python package.","position":{"start":{"line":376,"column":1},"end":{"line":376,"column":1}},"key":"v9n8NP9KTE"}],"key":"im5TYjyy3y"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"mhwHkoVGCt"}],"key":"slwKTwbU32"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":379,"column":1},"end":{"line":380,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":379,"column":1},"end":{"line":379,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"reproject_exact","position":{"start":{"line":379,"column":1},"end":{"line":379,"column":1}},"key":"paYlZOXkdL"},{"type":"text","value":" conserves the total flux, but it takes slightly longer than non-exact methods. The cell below should take between 2-3 minutes to execute.","position":{"start":{"line":379,"column":1},"end":{"line":379,"column":1}},"key":"vac8wQZMGU"}],"key":"XfyLv0ZW4R"}],"key":"YA5iP9Fnvm"},{"type":"listItem","spread":true,"position":{"start":{"line":380,"column":1},"end":{"line":380,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Due to the bilinear method applied in ","position":{"start":{"line":380,"column":1},"end":{"line":380,"column":1}},"key":"mYeCWuIayM"},{"type":"inlineCode","value":"reproject_interp","position":{"start":{"line":380,"column":1},"end":{"line":380,"column":1}},"key":"AuBj0GogXA"},{"type":"text","value":", single-pixel NaNs get conservatively extended into multi-pixel NaN regions.","position":{"start":{"line":380,"column":1},"end":{"line":380,"column":1}},"key":"VmGShHZq4F"}],"key":"IKWPuqnXxT"}],"key":"DYvTrtUR8Q"}],"key":"wqkE0SlI9B"}],"key":"zXGTJVhz88"}],"key":"YCLrqzi1vV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"img_data2_reproj, footprint = reproject_exact(input_data=(img_data2, img_hdr2), output_projection=img_hdr4)\nfootprint[footprint == 0] = np.nan  # Set zero values to NaN\nmask2_reproj, _ = reproject_interp(input_data=(mask2, img_hdr2), output_projection=img_hdr4)","key":"ZbRTUsrKDl"},{"type":"outputs","id":"RHIrAR4Q9_J4CIFdvTbF5","children":[],"key":"rvgbt5OkuI"}],"key":"q5U6cBEysY"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"children":[{"type":"text","value":"We use ","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"DENWIv11Wb"},{"type":"emphasis","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"StZ86vzteb"}],"key":"rBl4zYKesQ"},{"type":"text","value":" to visualize the two detector images as well as the reprojected D4 image. See the file ","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"nXyM9dn6FV"},{"type":"inlineCode","value":"spherex_source_discovery_tool/bokeh_viz.py","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"MBxqpgy1dO"},{"type":"text","value":" for more information on the used function ","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"il9he31i3R"},{"type":"inlineCode","value":"plot_overlap_trio()","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"GsDT1JklBr"},{"type":"text","value":" to learn how to use ","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"MKRuHeZ60b"},{"type":"emphasis","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"GCHqqskSM3"}],"key":"NIlq9nX5pz"},{"type":"text","value":".","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"lUAiA33zmN"}],"key":"MM72VG1XWt"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"JiGrPIf0kb"}],"key":"tuP2WSYzqL"},{"type":"paragraph","position":{"start":{"line":392,"column":1},"end":{"line":392,"column":1}},"children":[{"type":"text","value":"The initial bokeh plot has a ~20 second rendering penalty due to static asset loading. Subsequent bokeh plots should take less time to display.","position":{"start":{"line":392,"column":1},"end":{"line":392,"column":1}},"key":"LuYCcaCB2A"}],"key":"hUBako6oQ7"}],"key":"hVu65bVcjN"}],"key":"w5UIxdWZgS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Plot data\nplot1_info = {\n    \"img_data\": img_data4,\n    \"title\": \"D4 Image\",\n    \"units\": img_hdu4.header[\"BUNIT\"]\n}\nplot2_info = {\n    \"img_data\": img_data2_reproj * footprint,\n    \"title\": \"D2 Reprojected on D4\",\n    \"units\": img_hdu2.header[\"BUNIT\"]\n}\nplot3_info = {\n    \"img_data\": img_data4 * footprint,\n    \"title\": \"D4 Image with D2 Footprint Mask\",\n    \"units\": img_hdu4.header[\"BUNIT\"]\n}\n\nplot_overlap_trio(plot1_info, plot2_info, plot3_info, clip=True)","key":"Y6FrHX6qG5"},{"type":"outputs","id":"7SzxvvA7ikqALZS7iaOQn","children":[],"key":"pJv4hYfxSL"}],"key":"iwrqZbXPJQ"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":416,"column":1},"end":{"line":416,"column":1}},"children":[{"type":"text","value":"9. Generate Cutouts and Subtracted Color Image","position":{"start":{"line":416,"column":1},"end":{"line":416,"column":1}},"key":"BlILmgGKpm"}],"identifier":"id-9-generate-cutouts-and-subtracted-color-image","label":"9. Generate Cutouts and Subtracted Color Image","html_id":"id-9-generate-cutouts-and-subtracted-color-image","implicit":true,"key":"wD4WdtSQpt"}],"key":"f5eTA9vw4S"},{"type":"block","position":{"start":{"line":418,"column":1},"end":{"line":418,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":420,"column":1},"end":{"line":420,"column":1}},"children":[{"type":"text","value":"For this example, we only use parts of the image. For this, we first generate cutouts of the D4 image as well as the reprojected D2 image.","position":{"start":{"line":420,"column":1},"end":{"line":420,"column":1}},"key":"xITE4DHXTE"}],"key":"Txa0ynWpBK"}],"key":"OtYBLPboPJ"},{"type":"block","position":{"start":{"line":422,"column":1},"end":{"line":422,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":424,"column":1},"end":{"line":424,"column":1}},"children":[{"type":"text","value":"Next, we subtract the images. For keeping track of the wavelength and file names, we create two handy dictionaries.","position":{"start":{"line":424,"column":1},"end":{"line":424,"column":1}},"key":"brw1gjgQE8"}],"key":"EBJx2PwSsa"},{"type":"paragraph","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"children":[{"type":"text","value":"Finally, we use ","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"key":"eCzGbnovTM"},{"type":"emphasis","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"key":"LOKN1slxzJ"}],"key":"iTBdsBkNnZ"},{"type":"text","value":" to show interactive representation of the two images as well as the subtracted image ","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"key":"RdCF8r7wFU"},{"type":"emphasis","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"children":[{"type":"text","value":"inside","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"key":"liqqwK7WQX"}],"key":"g7KQgd8xIg"},{"type":"text","value":" this Jupyter Notebook.","position":{"start":{"line":426,"column":1},"end":{"line":426,"column":1}},"key":"ccxtNrU0Qp"}],"key":"EcQArToKra"}],"key":"KZapc7xrIY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Set up data directory and cutout paths\ndata_dir = './data/'\nif not os.path.exists(data_dir):\n    os.mkdir(data_dir)\n\ncut_path2 = os.path.join(data_dir , f\"cutout_{get_filename(d2_result['access_url'])}\")\ncut_path4 = os.path.join(data_dir , f\"cutout_{get_filename(d4_result['access_url'])}\")\n\n# Generate cutouts from input images\n# NOTE: We use D4's WCS for both cutouts since we reprojected\ncut2 = Cutout2D(img_data2_reproj, position=coord, size=(150, 150), wcs=WCS(img_hdu4.header))\ncut2_hdu = copy.deepcopy(img_hdu4)  # make copy to avoid modifying HDU of full-size image\ncut2_hdu.data = cut2.data\ncut2_hdu.header.update(cut2.wcs.to_header())\ncut2_hdu.writeto(cut_path2, overwrite=True)\ncut2_mask = Cutout2D(mask2_reproj, position=coord, size=(150, 150), wcs=WCS(img_hdu4.header))\n\ncut4 = Cutout2D(img_data4*footprint, position=coord, size=(150, 150), wcs=WCS(img_hdu4.header))\ncut4_hdu = copy.deepcopy(img_hdu4)  # make copy to avoid modifying HDU of full-size image\ncut4_hdu.data = cut4.data\ncut4_hdu.header.update(cut4.wcs.to_header())\ncut4_hdu.writeto(cut_path4, overwrite=True)\ncut4_mask = Cutout2D(mask4, position=coord, size=(150, 150), wcs=WCS(img_hdu4.header))","key":"DzQ36P7Fhx"},{"type":"outputs","id":"pjnaFTUNDzvJ48PXjBFqD","children":[],"key":"pROUFrXM1x"}],"key":"oknQ4Dolya"},{"type":"block","children":[],"key":"KQusVOkmHS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"d2_range = get_lambda_range(d2_result)\nd2_info = {\n    \"img_data\": cut2.data,\n    \"title\": rf\"{d2_range[0]:.2f}-{d2_range[1]:.2f} um (D2)\",\n    \"units\": img_hdr2[\"BUNIT\"]\n}\n\nd4_range = get_lambda_range(d4_result)\nd4_info = {\n    \"img_data\": cut4.data,\n    \"title\": rf\"{d4_range[0]:.2f}-{d4_range[1]:.2f} um (D4)\",\n    \"units\": img_hdr4[\"BUNIT\"]\n}\n\nsubtracted_info = {\n    \"img_data\": np.subtract(cut2.data, cut4.data),\n    \"title\": \"Subtracted (D2-D4)\",\n    \"units\": img_hdr4[\"BUNIT\"]\n}\n\nsubtracted_masked_info = {\n    \"img_data\": np.subtract(cut2.data, cut4.data) * cut2_mask.data * cut4_mask.data,\n    \"title\": \"Subtracted (D2-D4)\",\n    \"units\": img_hdr4[\"BUNIT\"]\n}\n\nplot_subtracted_trio(d2_info, d4_info, subtracted_masked_info, clip=True)","key":"TxLlvKudZQ"},{"type":"outputs","id":"YAA6O0QT6-b6ieWgwSWON","children":[],"key":"OFvR8ASReN"}],"key":"kayt6Vhb8D"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":484,"column":1},"end":{"line":484,"column":1}},"children":[{"type":"text","value":"10. Run ","position":{"start":{"line":484,"column":1},"end":{"line":484,"column":1}},"key":"aakRiudtta"},{"type":"inlineCode","value":"SExtractor","key":"mi1mkWeROJ"},{"type":"text","value":" on the Subtracted Color Image","position":{"start":{"line":484,"column":1},"end":{"line":484,"column":1}},"key":"XIpcvacLtK"}],"identifier":"id-10-run-sextractor-on-the-subtracted-color-image","label":"10. Run SExtractor on the Subtracted Color Image","html_id":"id-10-run-sextractor-on-the-subtracted-color-image","implicit":true,"key":"YQoBL4PbBk"},{"type":"paragraph","position":{"start":{"line":486,"column":1},"end":{"line":486,"column":1}},"children":[{"type":"text","value":"A use case could be to search for red sources such as galaxies with an Active Galactic Nucleus (AGN), which are manifested by red mid-infrared colors. Such red sources can be identified on the subtracted image.","position":{"start":{"line":486,"column":1},"end":{"line":486,"column":1}},"key":"XnCEA1pXna"}],"key":"CCqZlEroyn"},{"type":"paragraph","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"children":[{"type":"text","value":"In the following, we run ","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"key":"hdiqaqPbAO"},{"type":"link","url":"https://sextractor.readthedocs.io/en/latest/Introduction.html","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"children":[{"type":"inlineCode","value":"SExtractor","key":"bv6pepJrUd"}],"urlSource":"https://sextractor.readthedocs.io/en/latest/Introduction.html","key":"wKc3i30FVo"},{"type":"text","value":" on all the images (reprojected D2, D4, and subtracted image) to identify sources. Before that, however, we have to save the subtracted image to disk (note that the D2 and D4 cutouts are already saved to disk).","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"key":"sLInhV655S"}],"key":"h7ggfEI14y"}],"key":"Ie4hbpImTT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Save subtracted image to fits file for source extraction\nsubtracted_cut_path = os.path.join(data_dir , f\"subtracted_{get_exp_id(img_hdu2)}_{get_exp_id(img_hdu4)}.fits\")\nsub_hdu = copy.deepcopy(cut2_hdu)  # make copy to avoid modifying original\nsub_hdu.data = subtracted_info[\"img_data\"]\nsub_hdu.writeto(subtracted_cut_path, overwrite=True)","key":"XVMHRYfFJY"},{"type":"outputs","id":"_bJaACX0Fve5z4O6slxec","children":[],"key":"BajmQitv8R"}],"key":"TKSXAOKQXm"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":498,"column":1},"end":{"line":499,"column":1}},"children":[{"type":"text","value":"Now, we run ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"TUzmZOju2E"},{"type":"inlineCode","value":"SExtractor","key":"qQpbjmExhj"},{"type":"text","value":". This software needs a few parameter files such as a configuration and parameter files as well as some others (for example a convolution filter). These files are provided in the ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"C7fpoeDZkp"},{"type":"inlineCode","value":"spherex_source_discovery_tool","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"Sp43Z6tkdK"},{"type":"text","value":" directory. For ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"SMpQtjX4Fj"},{"type":"inlineCode","value":"SExtractor","key":"aOKJdlRI3o"},{"type":"text","value":" to find them, we have to give it absolute path names to these files. We use ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"UkK9i0mHqd"},{"type":"inlineCode","value":"os.path.realpath()","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"qhfECZayQu"},{"type":"text","value":" in the following to translate relative paths to absolute paths.\nFinally, we run ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"Ug99EynZlm"},{"type":"inlineCode","value":"SExtractor","key":"Y0eDoxWv7j"},{"type":"text","value":" on the last lines.","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"JMUPTPI2sO"}],"key":"toXfZ47QvV"}],"key":"Nes8DcvzF8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sxt_config = get_sextractor_file(\"default_sdt.sex\", package=\"spherex_source_discovery_tool\")\nsxt_params = get_sextractor_file(\"default_sdt.param\", package=\"spherex_source_discovery_tool\")\nsxt_nnw = get_sextractor_file(\"default.nnw\", package=\"spherex_source_discovery_tool\")\nsxt_conv = get_sextractor_file(\"default.conv\", package=\"spherex_source_discovery_tool\")\n\nsubtracted_cat = os.path.realpath( os.path.join(data_dir , f\"subtracted_{get_exp_id(img_hdu2)}_{get_exp_id(img_hdu4)}.cat\")) # need to use absolute path here!\nd2_cat = os.path.realpath( os.path.join(data_dir , f\"{get_exp_id(img_hdu2)}.cat\") ) # need to use absolute path here!\nd4_cat = os.path.realpath( os.path.join(data_dir , f\"{get_exp_id(img_hdu4)}.cat\") ) # need to use absolute path here!\n\nrun_sextractor(os.path.realpath(subtracted_cut_path), sxt_config, sxt_params, subtracted_cat, sxt_nnw, sxt_conv)\nrun_sextractor(os.path.realpath(cut_path2), sxt_config, sxt_params, d2_cat, sxt_nnw, sxt_conv)\nrun_sextractor(os.path.realpath(cut_path4), sxt_config, sxt_params, d4_cat, sxt_nnw, sxt_conv)","key":"EARm8e8j4F"},{"type":"outputs","id":"nSAGewAgewM_LvjwBVklN","children":[],"key":"bcOZ2r3JGv"}],"key":"dhIuowCaQT"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":516,"column":1},"end":{"line":516,"column":1}},"children":[{"type":"text","value":"11. Select Sources Interactively","position":{"start":{"line":516,"column":1},"end":{"line":516,"column":1}},"key":"Pw03guo6yx"}],"identifier":"id-11-select-sources-interactively","label":"11. Select Sources Interactively","html_id":"id-11-select-sources-interactively","implicit":true,"key":"xkn4MJ5FXO"},{"type":"paragraph","position":{"start":{"line":518,"column":1},"end":{"line":518,"column":1}},"children":[{"type":"text","value":"In the following, we show two ways to visualize the extracted sources on the images and how to interactively select interesting sources. (Note that you can always select the source automatically in Python using, for example, ","position":{"start":{"line":518,"column":1},"end":{"line":518,"column":1}},"key":"PLt5hCCWkw"},{"type":"inlineCode","value":"astropy","position":{"start":{"line":518,"column":1},"end":{"line":518,"column":1}},"key":"BzA4nXGTKG"},{"type":"text","value":" tables instead of doing it interactively.)","position":{"start":{"line":518,"column":1},"end":{"line":518,"column":1}},"key":"qKT8VTvZOy"}],"key":"WALWRJrMxB"},{"type":"paragraph","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"children":[{"type":"text","value":"First, we read in the ","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"fCP7FxOgLg"},{"type":"inlineCode","value":"SExtractor","key":"zhLdrVwyDP"},{"type":"text","value":" catalog. Note that we want to change ","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"zf4ZArL1m2"},{"type":"inlineCode","value":"ALPHA_J2000","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"K2GDrdNWbj"},{"type":"text","value":" and ","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"aMEjoVMKPu"},{"type":"inlineCode","value":"DELTA_J2000","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"ZEvVPQWdJ3"},{"type":"text","value":" to the more universal ","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"IpGUjtjitP"},{"type":"inlineCode","value":"ra","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"K75Bcdzt9i"},{"type":"text","value":" and ","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"Eq58ptdB6R"},{"type":"inlineCode","value":"dec","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"IMr17WeRrY"},{"type":"text","value":" column names. This is especially important for Firefly to be able to read the table out of the box and mark the source in the table on the images.","position":{"start":{"line":520,"column":1},"end":{"line":520,"column":1}},"key":"D0z9q4BwH6"}],"key":"UJ5iuUwAJy"}],"key":"An0ZLbFlrE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"extracted = Table.read(subtracted_cat , format=\"ascii\")\nextracted.rename_column(\"ALPHA_J2000\", \"ra\")\nextracted.rename_column(\"DELTA_J2000\", \"dec\")\nextracted.sort(keys=\"NUMBER\")","key":"FdwwO8y9LZ"},{"type":"outputs","id":"bAcQMCbJ1vjlXkAGbrPPC","children":[],"key":"FPCDG8iAII"}],"key":"S1DkwnVSPK"},{"type":"block","children":[{"type":"heading","depth":3,"position":{"start":{"line":529,"column":1},"end":{"line":529,"column":1}},"children":[{"type":"text","value":"11.1 Using ","position":{"start":{"line":529,"column":1},"end":{"line":529,"column":1}},"key":"k7Zfa11kmm"},{"type":"emphasis","position":{"start":{"line":529,"column":1},"end":{"line":529,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":529,"column":1},"end":{"line":529,"column":1}},"key":"xHsyZXjyxc"}],"key":"ysChg6VVlZ"},{"type":"text","value":" visualizations","position":{"start":{"line":529,"column":1},"end":{"line":529,"column":1}},"key":"jJUWR1TAUD"}],"identifier":"id-11-1-using-bokeh-visualizations","label":"11.1 Using bokeh visualizations","html_id":"id-11-1-using-bokeh-visualizations","implicit":true,"key":"DekHNiZ7v7"},{"type":"paragraph","position":{"start":{"line":531,"column":1},"end":{"line":531,"column":1}},"children":[{"type":"text","value":"First, we demonstrate how we can use ","position":{"start":{"line":531,"column":1},"end":{"line":531,"column":1}},"key":"qghaoBiGkv"},{"type":"emphasis","position":{"start":{"line":531,"column":1},"end":{"line":531,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":531,"column":1},"end":{"line":531,"column":1}},"key":"L67bRMvXpk"}],"key":"MSz4GORr8Q"},{"type":"text","value":" to create an interactive dashboard to select sources.","position":{"start":{"line":531,"column":1},"end":{"line":531,"column":1}},"key":"GVcLVESeOJ"}],"key":"RuOp9Aof4e"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"E4oybgUuwM"}],"key":"doecIgw3Xo"},{"type":"paragraph","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"children":[{"type":"text","value":"Currently, ","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"key":"AYj17PHkBF"},{"type":"emphasis","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"key":"kSAZbKYhlI"}],"key":"TPMscJtwLX"},{"type":"text","value":" tables cannot be displayed in Fornax. Therefore the example below will not work. The user is encouraged to use ","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"key":"CbW4RRpB3c"},{"type":"emphasis","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"key":"IlI9Y8QsXC"}],"key":"pV7BnMIjZy"},{"type":"text","value":", which use is demonstrated in Section 10.2 below.","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"key":"Xs6ww7GA6l"}],"key":"aN8T3vpbCL"}],"key":"kAfE4PuLzT"}],"key":"lkXeNsMZae"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plot_apertures(subtracted_cut_path, source_tab=extracted, label=\"Extracted Sources\", clip=True)","key":"AYcACj0WXu"},{"type":"outputs","id":"22ZhyNK1VZ5O_SDbB7LmP","children":[],"key":"ZRRuFq6QMy"}],"key":"daqPfEgRJh"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":541,"column":1},"end":{"line":541,"column":1}},"children":[{"type":"text","value":"Alternatively, the sources can be easily selected in Python itself by defining a selection function.","position":{"start":{"line":541,"column":1},"end":{"line":541,"column":1}},"key":"CPuUZBf0g4"}],"key":"pBNy7EZt3U"}],"key":"tVOYf491l7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create custom selection function\ndef select_sources(sxt_tab):\n    \"\"\"Selects the 25 brightest sources from the SExtractor-generated catalog.\n\n    Parameters\n    ----------\n    sxt_tab: astropy.table.Table\n        Table of extracted sources, including named IDs and converted fluxes\n\n    Returns\n    -------\n    bright_tab: astropy.table.Table\n        Table of selected sources\n    \"\"\"\n    # Select bright sources (using automatic aperture flux for now)\n    sxt_tab.sort(\"FLUX_AUTO\", reverse=True)\n    bright_tab = sxt_tab[0:25]\n\n    return bright_tab\n\n# Preview selected sources\nselected = select_sources(extracted)\nplot_apertures(subtracted_cut_path, source_tab=selected, label=\"25 Brightest Sources\", clip=True)","key":"QKaCdw0zQZ"},{"type":"outputs","id":"Z0zSbvLOwATsrww_y7OWg","children":[],"key":"bihA7Ns4Wx"}],"key":"Dnt6pqGhcF"},{"type":"block","children":[{"type":"heading","depth":3,"position":{"start":{"line":569,"column":1},"end":{"line":569,"column":1}},"children":[{"type":"text","value":"11.2 Using ","position":{"start":{"line":569,"column":1},"end":{"line":569,"column":1}},"key":"qWhouOPHWl"},{"type":"emphasis","position":{"start":{"line":569,"column":1},"end":{"line":569,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":569,"column":1},"end":{"line":569,"column":1}},"key":"Q1KoI460cY"}],"key":"n3ycCspZTA"},{"type":"text","value":" visualization","position":{"start":{"line":569,"column":1},"end":{"line":569,"column":1}},"key":"jYqLJFMulA"}],"identifier":"id-11-2-using-firefly-visualization","label":"11.2 Using Firefly visualization","html_id":"id-11-2-using-firefly-visualization","implicit":true,"key":"QA6LyXFgp3"},{"type":"paragraph","position":{"start":{"line":571,"column":1},"end":{"line":572,"column":1}},"children":[{"type":"text","value":"Alternatively to ","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"jHwUy2G4iD"},{"type":"emphasis","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"Uii84wIL4S"}],"key":"o8zvs425I3"},{"type":"text","value":", we can use the ","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"f9N3sXi0iR"},{"type":"emphasis","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"M5PB1sAlpK"}],"key":"m5jsNDgorm"},{"type":"text","value":" application to show the image including the data table. First we reinitiate ","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"PVOuaFT0Cl"},{"type":"emphasis","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"B3SLh31gfr"}],"key":"CO6K7R5sD2"},{"type":"text","value":", which will again open a new tab called “Firefly Viewer”.\nAs mentioned above, we give again two options for initiating ","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"Ci906tp1X5"},{"type":"emphasis","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"c2hgYf5HMS"}],"key":"QJuypanflY"},{"type":"text","value":"; in a new browser tab or a new JupterLab tab.","position":{"start":{"line":571,"column":1},"end":{"line":571,"column":1}},"key":"mxQsoATnXL"}],"key":"KWeREfG0zj"}],"key":"kSV7urvxoB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Set up Firefly client in browser tab\n#fc = FireflyClient.make_client(url=\"https://irsa.ipac.caltech.edu/irsaviewer\")\n\n# Set up Firefly client in new JupyterLab tab\nfc = FireflyClient.make_lab_client()\n\nfc.reinit_viewer()","key":"c37CGic6mC"},{"type":"outputs","id":"wFT_VTBTEdctyPql48KZA","children":[],"key":"Fwt8YNq0bY"}],"key":"YnmgtC4GBO"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":584,"column":1},"end":{"line":584,"column":1}},"children":[{"type":"text","value":"Then, we load the images and finally the catalog to the application. ","position":{"start":{"line":584,"column":1},"end":{"line":584,"column":1}},"key":"aqx7YModen"},{"type":"emphasis","position":{"start":{"line":584,"column":1},"end":{"line":584,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":584,"column":1},"end":{"line":584,"column":1}},"key":"v6oCTzc7ph"}],"key":"NthfzJcFmE"},{"type":"text","value":" takes care of the rest!","position":{"start":{"line":584,"column":1},"end":{"line":584,"column":1}},"key":"T7j4OmgKln"}],"key":"gFo4swgRQC"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"rpWQ032fOj"}],"key":"y9rx1nfupO"},{"type":"paragraph","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"children":[{"type":"text","value":"We do not have to save the table to disk. Instead, we can use a “stream” and directly feed it to ","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"key":"KNc5Q3e4sx"},{"type":"emphasis","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"key":"zNeOzM0cyH"}],"key":"l2OkhYacaR"},{"type":"text","value":". We do this by using","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"key":"TbgEmrbKRk"}],"key":"nuJAGqm5Rq"},{"type":"code","lang":"","value":"io.BytesIO()","position":{"start":{"line":589,"column":1},"end":{"line":589,"column":1}},"key":"Fvsr8ERB9E"},{"type":"paragraph","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"children":[{"type":"text","value":"For more tips and tricks on how to use ","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"key":"NYU2YzCPcL"},{"type":"emphasis","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"key":"ockNGTwwcV"}],"key":"cc0ipdYG9B"},{"type":"text","value":" in Python, we encourage reviewing the ","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"key":"ldX4jVwCuG"},{"type":"link","url":"https://caltech-ipac.github.io/firefly_client/usage/","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"children":[{"type":"text","value":"Firefly","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"key":"zdrgNrrsmf"}],"key":"RyKgf7vrLb"},{"type":"text","value":" manual webpage","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"key":"lkAC8Jcxbg"}],"urlSource":"https://caltech-ipac.github.io/firefly_client/usage/","key":"J4Hnaa6QER"},{"type":"text","value":".","position":{"start":{"line":591,"column":1},"end":{"line":591,"column":1}},"key":"ugMHBrLJd7"}],"key":"IGXtVQMKNn"}],"key":"twJJLznEP0"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"iysUJEHFMU"}],"key":"FQJnglCwA1"},{"type":"paragraph","position":{"start":{"line":595,"column":1},"end":{"line":595,"column":1}},"children":[{"type":"text","value":"You can align and lock the images by their WCS by adding","position":{"start":{"line":595,"column":1},"end":{"line":595,"column":1}},"key":"mEMJJUtIve"}],"key":"qVQb2jGIvY"},{"type":"code","lang":"","value":"fc.align_images(lock_match=True)","position":{"start":{"line":597,"column":1},"end":{"line":597,"column":1}},"key":"E5ZAiNkqGp"}],"key":"tNqcUr5x84"}],"key":"gJC6ICR0CL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Load images\nfc.show_fits_image(\n        file_input=cut_path2,\n        plot_id=\"D2\",\n        Title=\"Detector 2\"\n    )\nfc.show_fits_image(\n        file_input=cut_path4,\n        plot_id=\"D4\",\n        Title=\"Detector 4\"\n    )\nfc.show_fits_image(\n        file_input=subtracted_cut_path,\n        plot_id=\"subtracted\",\n        Title=\"Subtracted image\"\n    )\nfc.align_images(lock_match=True)\n\n# Load table\ntbl_stream = io.BytesIO()\nextracted.write(tbl_stream, format='votable')\nfc.show_table(file_input=tbl_stream,\n              tbl_id=\"SExtractor Table\",\n              title='Table')","key":"StWGo51Njo"},{"type":"outputs","id":"RbHDSceyVYoIabeMVCXnG","children":[],"key":"pUB1JA11hd"}],"key":"M02X8IiGCQ"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":628,"column":1},"end":{"line":628,"column":1}},"children":[{"type":"text","value":"12. Perform Aperture Photometry on Selected Sources","position":{"start":{"line":628,"column":1},"end":{"line":628,"column":1}},"key":"ZLnIvHqjUz"}],"identifier":"id-12-perform-aperture-photometry-on-selected-sources","label":"12. Perform Aperture Photometry on Selected Sources","html_id":"id-12-perform-aperture-photometry-on-selected-sources","implicit":true,"key":"O1Tj0PX7SB"},{"type":"paragraph","position":{"start":{"line":630,"column":1},"end":{"line":630,"column":1}},"children":[{"type":"text","value":"Finally, we compute the SPHEREx spectra for selected sources. This includes downloading all the available SPHEREx spectral image cutouts for the sources and then measuring their photometry to generate a spectrum. For simplicity, we here perform aperture photometry but include background subtraction.","position":{"start":{"line":630,"column":1},"end":{"line":630,"column":1}},"key":"rjkDrD50Zg"}],"key":"yCgSDfzezB"},{"type":"heading","depth":3,"position":{"start":{"line":632,"column":1},"end":{"line":632,"column":1}},"children":[{"type":"text","value":"12.1 Download SPHEREx spectral image cutouts","position":{"start":{"line":632,"column":1},"end":{"line":632,"column":1}},"key":"SBk9fkx1zb"}],"identifier":"id-12-1-download-spherex-spectral-image-cutouts","label":"12.1 Download SPHEREx spectral image cutouts","html_id":"id-12-1-download-spherex-spectral-image-cutouts","implicit":true,"key":"AxJ9t5rJz6"},{"type":"paragraph","position":{"start":{"line":634,"column":1},"end":{"line":634,"column":1}},"children":[{"type":"text","value":"Here we select one source to proceed (multiple sources can be measured by looping over the code below). Note that we here directly give it the unique source ID that we defined in the catalog column ","position":{"start":{"line":634,"column":1},"end":{"line":634,"column":1}},"key":"kih1G7lu5l"},{"type":"inlineCode","value":"NUMBER","position":{"start":{"line":634,"column":1},"end":{"line":634,"column":1}},"key":"SrDkJQygeF"},{"type":"text","value":".","position":{"start":{"line":634,"column":1},"end":{"line":634,"column":1}},"key":"EnOkRRzds9"}],"key":"Rgphx1psTz"}],"key":"AfBYUSQtPD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"selected_ids = [65]\nmatched_stars = extracted[extracted['NUMBER'] == selected_ids[0]][\"NUMBER\", \"ra\", \"dec\"].to_pandas()","key":"gnWCHMh1Av"},{"type":"outputs","id":"Cv8oUnv3hYJvw32P2ANt6","children":[],"key":"inK2B3UOho"}],"key":"fU0ZB4YhAO"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":641,"column":1},"end":{"line":641,"column":1}},"children":[{"type":"text","value":"We then set up the TAP service as well as the cutout size to run a query for all SPHEREx spectral images that contain the sources.","position":{"start":{"line":641,"column":1},"end":{"line":641,"column":1}},"key":"pXHIs4u31c"}],"key":"N6rhOEp4nW"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"Ski85Wn62l"}],"key":"eL3Fd5NTNO"},{"type":"paragraph","position":{"start":{"line":643,"column":1},"end":{"line":643,"column":1}},"children":[{"type":"text","value":"Note that the following procedure follows the one shown in the SPHEREx ","position":{"start":{"line":643,"column":1},"end":{"line":643,"column":1}},"key":"BtaN7b5mCr"},{"type":"link","url":"https://caltech-ipac.github.io/irsa-tutorials/spherex-cutouts/","position":{"start":{"line":643,"column":1},"end":{"line":643,"column":1}},"children":[{"type":"text","value":"Image Cutout tutorial notebook","position":{"start":{"line":643,"column":1},"end":{"line":643,"column":1}},"key":"bkCkHrDViz"}],"urlSource":"https://caltech-ipac.github.io/irsa-tutorials/spherex-cutouts/","key":"LbyE4TOIW3"},{"type":"text","value":".","position":{"start":{"line":643,"column":1},"end":{"line":643,"column":1}},"key":"HzflJ1ssEO"}],"key":"MxuKrAPzkl"}],"key":"a6SbJ9oe4w"}],"key":"UqIpIhML2f"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Define the service endpoint for IRSA's Table Access Protocol (TAP)\n# so that we can query SPHEREx metadata tables.\nservice = pyvo.dal.TAPService(\"https://irsa.ipac.caltech.edu/TAP\")\n\n# Specify cutout size (approximately 60 pixels on a side)\nsize = 0.1 * u.degree\n\n# Define a query that will search the appropriate SPHEREx metadata tables\n# for spectral images that cover the chosen coordinates and match the\n# specified bandpass. Return the cutout data access URL and the time of observation.\n# Sort by observation time.\nquery = f\"\"\"\nSELECT\n    'https://irsa.ipac.caltech.edu/' || a.uri || '?center={matched_stars['ra'][0]},{matched_stars['dec'][0]}d&size={size.value}' AS uri,\n    p.time_bounds_lower\nFROM spherex.artifact a\nJOIN spherex.plane p ON a.planeid = p.planeid\nWHERE 1 = CONTAINS(POINT('ICRS', {matched_stars['ra'][0]}, {matched_stars['dec'][0]}), p.poly)\nORDER BY p.time_bounds_lower\n\"\"\"\n\n# Execute the query and return as an astropy Table.\nt1 = time.time()\ntap_results = service.search(query)\nprint(\"Time to do TAP query: {:2.2f} seconds.\".format(time.time() - t1))\nprint(\"Number of images found: {}\".format(len(tap_results)))","key":"IN30yf9zHu"},{"type":"outputs","id":"_3qm2kHrgyOru-oXj69_f","children":[],"key":"qZgKNXFKCv"}],"key":"afDcyZ8k4O"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":675,"column":1},"end":{"line":675,"column":1}},"children":[{"type":"text","value":"We then define a handy function that downloads the images.","position":{"start":{"line":675,"column":1},"end":{"line":675,"column":1}},"key":"E2Y51MWRP0"}],"key":"aOu4eRZurr"}],"key":"B5U2oA90aO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def process_cutout(row, ra, dec, cache, retries=3, delay=5):\n    '''\n    Downloads the cutouts given in a row of the table including all SPHEREx images overlapping with a position.\n\n    Parameters\n    ----------\n    row : `astropy.table.Row`\n        Row of a table that will be changed in place by this function. The table\n        is created by the SQL TAP query.\n    ra, dec : `float`\n        RA and Dec coordinates (same as used for the TAP query) in degrees.\n    cache : `bool`\n        If set to `True`, the output of cached and the cutout processing will run faster next time.\n        Turn this feature off by setting `cache = False`.\n    retries : `int`, optional\n        Number of times to retry downloading the cutout in case of failure.\n    delay : `int`, optional\n        Delay in seconds between retries.\n    '''\n    for attempt in range(retries):\n        try:\n            with fits.open(row[\"uri\"]) as hdulist:\n                # There are seven HDUs:\n                # 0 contains minimal metadata in the header and no data.\n                # 1 through 6 are: IMAGE, FLAGS, VARIANCE, ZODI, PSF, WCS-WAVE\n                header = hdulist[1].header\n\n                # Fetch spatial and spectral WCS\n                spatial_wcs = WCS(header)\n                spectral_wcs = WCS(header, fobj=hdulist, key=\"W\")\n                spectral_wcs.sip = None  # disable SIP distortions\n                row[\"spectral_wcs\"] = spectral_wcs\n\n                # Compute wavelength/bandpass at source position\n                x_src, y_src = spatial_wcs.world_to_pixel(SkyCoord(ra=ra, dec=dec, unit=\"deg\", frame=\"icrs\"))\n                wl_src, bp_src = spectral_wcs.pixel_to_world(x_src, y_src)\n                row[\"central_wl_src\"] = wl_src.to(u.micrometer).value\n\n                # Collect the HDUs for this cutout and append the row's cutout_index to the EXTNAME.\n                hdus = []\n                for hdu in hdulist[1:]:  # skip the primary header\n                    hdu.header[\"EXTNAME\"] = f\"{hdu.header['EXTNAME']}{row['cutout_index']}\"\n                    hdus.append(hdu.copy())  # Copy so the data is available after the file is closed\n                row[\"hdus\"] = hdus\n        except TimeoutError:\n            if attempt == retries - 1:\n                raise\n            time.sleep(delay)","key":"NUWu1xdMd0"},{"type":"outputs","id":"7t_lWcz_tYeH38xSH4-y2","children":[],"key":"h0OEJ8UVno"}],"key":"Sm7D8XlIG5"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":728,"column":1},"end":{"line":728,"column":1}},"children":[{"type":"text","value":"We add some placeholders and other information to the table so we can keep track of things.","position":{"start":{"line":728,"column":1},"end":{"line":728,"column":1}},"key":"QiO1QgMZqv"}],"key":"h9lggrJIpu"}],"key":"SNgdk1MuKl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Add columns to hold relevant cutout information\nresults_table = tap_results.to_table()\nresults_table[\"cutout_index\"] = range(1, len(results_table) + 1)\nresults_table[\"central_wl_src\"] = np.full(len(results_table), np.nan)\nresults_table[\"hdus\"] = np.full(len(results_table), None)\nresults_table[\"spectral_wcs\"] = np.full(len(results_table), None)  # since we are not saving primary HDU","key":"GHQwCRep3h"},{"type":"outputs","id":"EgH0r9_nXPyCw3rn--pq9","children":[],"key":"msTfnJTuY1"}],"key":"qmoNo4xp1b"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":739,"column":1},"end":{"line":739,"column":1}},"children":[{"type":"text","value":"Finally, we can run the download of the cutouts in parallel via the function created above. The cutouts are saved directly in the table.","position":{"start":{"line":739,"column":1},"end":{"line":739,"column":1}},"key":"J6gYCuwzbt"}],"key":"z9CnKEeIS2"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"slzcocRJyA"}],"key":"D6XtAd0DnL"},{"type":"paragraph","position":{"start":{"line":742,"column":1},"end":{"line":742,"column":1}},"children":[{"type":"text","value":"The cell below can take a couple of minutes to run depending on the number of observations available at a given sky coordinate position.","position":{"start":{"line":742,"column":1},"end":{"line":742,"column":1}},"key":"B6InTO1yVu"}],"key":"NqizjzUpnw"}],"key":"aT2FOCJqrm"}],"key":"KWdWlqG9D3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Process cutouts in parallel\nt1 = time.time()\nn_timeouts = 0\nwith concurrent.futures.ThreadPoolExecutor(max_workers=8) as executor:\n    futures = [executor.submit(process_cutout, row, matched_stars['ra'][0], matched_stars['dec'][0], False) for row in results_table]\n\n    # Raise any exceptions caught during cutout processing\n    for future in concurrent.futures.as_completed(futures):\n        try:\n            future.result()\n        except Exception as e:\n            n_timeouts += 1\n            print(f\"An error occurred: {e}\")\n\n# Check if any cutouts failed. If so, you might need to re-run this cell with\n# fewer workers, cache enabled, or increased timeout/retries.\nn_failed = np.count_nonzero(results_table['hdus'] == None)\nif n_timeouts > 0 or n_failed > 0:\n    print(f\"\\n!!!!! WARNING !!!!!\\n{n_timeouts} cutouts had timeouts and {n_failed} cutouts\"\n          f\" failed to process.\\n\")\n\nprint(\"Time to create cutouts in serial mode: {:2.2f} minutes.\".format((time.time() - t1) / 60))","key":"iRuVWB91WX"},{"type":"outputs","id":"BmZGev36AiczA___9E_gH","children":[],"key":"sjBm1w13Yk"}],"key":"r7IjUimyLF"},{"type":"block","children":[{"type":"heading","depth":3,"position":{"start":{"line":770,"column":1},"end":{"line":770,"column":1}},"children":[{"type":"text","value":"12.2 Obtain spectrum","position":{"start":{"line":770,"column":1},"end":{"line":770,"column":1}},"key":"Zhr1unc9gc"}],"identifier":"id-12-2-obtain-spectrum","label":"12.2 Obtain spectrum","html_id":"id-12-2-obtain-spectrum","implicit":true,"key":"sSkXL3cOvj"},{"type":"paragraph","position":{"start":{"line":772,"column":1},"end":{"line":773,"column":1}},"children":[{"type":"text","value":"Having obtained the cutouts, we can now perform aperture photometry on the cutouts and measure the fluxes as a function of wavelength.\nSee ","position":{"start":{"line":772,"column":1},"end":{"line":772,"column":1}},"key":"PSoxIv2jMt"},{"type":"inlineCode","value":"spherex_source_discovery_tool/aperture_photometry.py","position":{"start":{"line":772,"column":1},"end":{"line":772,"column":1}},"key":"CTy1PwdOfk"},{"type":"text","value":" for more information on the functions used below.","position":{"start":{"line":772,"column":1},"end":{"line":772,"column":1}},"key":"sozxDIr0Sb"}],"key":"jCcbawWhcZ"}],"key":"aFGM9T2uXK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"phot_path = os.path.realpath( \"./data/ap_phot_sources.pkl\" ) # this is where the photometry results are saved.\naperture_radii = [3.0, 4.0, 5.0]  # aperture radii in pixels\nmatched_stars = matched_stars.reset_index(drop=True)\n\n# Perform aperture photometry\nbuild_phot_table(results_table, matched_stars, aperture_radii, phot_path, sapm_s3)","key":"yuZk3wfqe5"},{"type":"outputs","id":"qk053FoYz9t0IXeWrN7Jx","children":[],"key":"aAAmTylF39"}],"key":"cjzXENcqcz"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":784,"column":1},"end":{"line":784,"column":1}},"children":[{"type":"text","value":"Load the photometry file we just created.","position":{"start":{"line":784,"column":1},"end":{"line":784,"column":1}},"key":"P8suYUjxqn"}],"key":"gK80GNK1ly"}],"key":"Tyyc9HRP0C"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if os.path.exists(phot_path):\n    with open(phot_path, 'rb') as f:\n        all_stars_band_phot = pickle.load(f)","key":"PZJGYgRqUB"},{"type":"outputs","id":"d7P4JiFF9nkwA7hxOLFOE","children":[],"key":"FoHQvTywYC"}],"key":"XxZbH1lNIX"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":792,"column":1},"end":{"line":792,"column":1}},"children":[{"type":"text","value":"Apply flagging to the extracted 1D-Spectrum.","position":{"start":{"line":792,"column":1},"end":{"line":792,"column":1}},"key":"sieybMSqcQ"}],"key":"mMvJOBlB2C"}],"key":"QPsxAfVAbt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Define bad photometry flags\nbad_flags = ['TRANSIENT', 'OVERFLOW', 'SUR_ERROR', 'PHANTOM', 'REFERENCE', 'NONFUNC', 'DICHROIC',\n             'MISSING_DATA', 'HOT', 'COLD', 'FULLSAMPLE', 'PHANMISS', 'NONLINEAR', 'PERSIST', 'OUTLIER']\nap_rad = 3.0  # set your preferred aperture radius, from the `aperture_radii` list you specified above\ntarg = 0  # pick index from `all_stars_band_phot` table\nwvl, bdw, abmags, abmag_errs, flx, var, n_bad = \\\n                grab_star(obs_log_entry=all_stars_band_phot['obs_log'][targ], ap_rad=ap_rad, bad_flags=bad_flags)","key":"fDoji72zwm"},{"type":"outputs","id":"y0gWyrK9e9_4vynjzzZr1","children":[],"key":"vwF5u0RhpQ"}],"key":"Ig6bHamkp2"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":804,"column":1},"end":{"line":804,"column":1}},"children":[{"type":"text","value":"Finally visualize the spectrum using ","position":{"start":{"line":804,"column":1},"end":{"line":804,"column":1}},"key":"Y56YmyKkIf"},{"type":"emphasis","position":{"start":{"line":804,"column":1},"end":{"line":804,"column":1}},"children":[{"type":"text","value":"bokeh","position":{"start":{"line":804,"column":1},"end":{"line":804,"column":1}},"key":"lUAh5IanQS"}],"key":"nAO0idYY5f"},{"type":"text","value":" in flux and magnitudes!","position":{"start":{"line":804,"column":1},"end":{"line":804,"column":1}},"key":"n8La2e07ni"}],"key":"YA8lARqkV6"}],"key":"ue0rlg9aPv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plot_spectrum(wvl, bdw, flx, var, abmags, abmag_errs, n_bad, type=\"flux\",\n              source_id=all_stars_band_phot['NUMBER'][targ], ap_size=3.0)\nplot_spectrum(wvl, bdw, flx, var, abmags, abmag_errs, n_bad, type=\"magnitude\",\n              source_id=all_stars_band_phot['NUMBER'][targ], ap_size=3.0)","key":"FVy5B9sszW"},{"type":"outputs","id":"npyhuHWvCagb4LpcG2kqG","children":[],"key":"SbqAAJ0t5X"}],"key":"UaEhLIxa8t"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":813,"column":1},"end":{"line":813,"column":1}},"children":[{"type":"text","value":"Acknowledgements","position":{"start":{"line":813,"column":1},"end":{"line":813,"column":1}},"key":"Fo9jK3xjle"}],"identifier":"acknowledgements","label":"Acknowledgements","html_id":"acknowledgements","implicit":true,"key":"iPhkRzpTrq"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":815,"column":1},"end":{"line":817,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":815,"column":1},"end":{"line":815,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"The Source Discovery Tool aperture photometry functions are adapted from code by Zafar Rustamkulov.","position":{"start":{"line":815,"column":1},"end":{"line":815,"column":1}},"key":"QFshGrknXe"}],"key":"MpLoafXvBc"}],"key":"JzgbBBOGEW"},{"type":"listItem","spread":true,"position":{"start":{"line":816,"column":1},"end":{"line":817,"column":1}},"children":[{"type":"paragraph","children":[{"type":"link","url":"https://irsa.ipac.caltech.edu/","position":{"start":{"line":816,"column":1},"end":{"line":816,"column":1}},"children":[{"type":"text","value":"Caltech/IPAC-IRSA","position":{"start":{"line":816,"column":1},"end":{"line":816,"column":1}},"key":"qFSsJO8rmc"}],"urlSource":"https://irsa.ipac.caltech.edu/","key":"vL8BZfXvjg"}],"key":"hhab1nYZk6"}],"key":"sXGjof0VeD"}],"key":"y41fWpy5EL"},{"type":"paragraph","position":{"start":{"line":818,"column":1},"end":{"line":818,"column":1}},"children":[{"type":"text","value":"This work has made use of the NASA/IPAC Infrared Science Archive, which is funded by the National Aeronautics and Space Administration and operated by the California Institute of Technology. We acknowledge support from the SPHEREx project under a contract from the NASA/Goddard Space Flight Center to the California Institute of Technology. This research was partly carried out at the California Institute of Technology under a contract with the National Aeronautics and Space Administration (80GSFC18C0011).  The DOI for SPHEREx QR2 data is 10.26131/IRSA629 (","position":{"start":{"line":818,"column":1},"end":{"line":818,"column":1}},"key":"nkBJOqJVzZ"},{"type":"cite","url":"https://doi.org/10.26131/IRSA629","position":{"start":{"line":818,"column":1},"end":{"line":818,"column":1}},"children":[{"type":"text","value":"SPHEREx Team (2025)","key":"QH4TIkzH0d"}],"kind":"narrative","label":"https://doi.org/10.26131/irsa629","identifier":"https://doi.org/10.26131/IRSA629","enumerator":"1","key":"sf2xKMoFYx"},{"type":"text","value":").","position":{"start":{"line":818,"column":1},"end":{"line":818,"column":1}},"key":"kuRKZV2MR1"}],"key":"fDp3076Ubq"}],"key":"clBAnd6fwJ"},{"type":"block","position":{"start":{"line":820,"column":1},"end":{"line":820,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":822,"column":1},"end":{"line":822,"column":1}},"children":[{"type":"text","value":"About this Notebook","position":{"start":{"line":822,"column":1},"end":{"line":822,"column":1}},"key":"aeZr0i35iF"}],"identifier":"about-this-notebook","label":"About this Notebook","html_id":"about-this-notebook","implicit":true,"key":"svZ9K2YO19"},{"type":"paragraph","position":{"start":{"line":824,"column":1},"end":{"line":824,"column":1}},"children":[{"type":"strong","position":{"start":{"line":824,"column":1},"end":{"line":824,"column":1}},"children":[{"type":"text","value":"Authors:","position":{"start":{"line":824,"column":1},"end":{"line":824,"column":1}},"key":"CYXUW1KAgt"}],"key":"Yh8RLNIVgI"},{"type":"text","value":" Gabriela Torrini, Andreas Faisst, and the SPHEREx Science Data Center (SSDC); Troy Raen, Brigitta Sipőcz, and Jaladh Singhal","position":{"start":{"line":824,"column":1},"end":{"line":824,"column":1}},"key":"ZITqDJ6Vak"}],"key":"Tz4vd5NTBY"},{"type":"paragraph","position":{"start":{"line":826,"column":1},"end":{"line":827,"column":1}},"children":[{"type":"strong","position":{"start":{"line":826,"column":1},"end":{"line":826,"column":1}},"children":[{"type":"text","value":"Contact:","position":{"start":{"line":826,"column":1},"end":{"line":826,"column":1}},"key":"rBMTerxv2I"}],"key":"K5kE7RwGVw"},{"type":"text","value":" ","position":{"start":{"line":826,"column":1},"end":{"line":826,"column":1}},"key":"kKQTqdjRYD"},{"type":"link","url":"https://irsa.ipac.caltech.edu/docs/help_desk.html","position":{"start":{"line":826,"column":1},"end":{"line":826,"column":1}},"children":[{"type":"text","value":"IRSA Helpdesk","position":{"start":{"line":826,"column":1},"end":{"line":826,"column":1}},"key":"L6rjNMARzj"}],"urlSource":"https://irsa.ipac.caltech.edu/docs/help_desk.html","key":"MFF3R3tbZs"},{"type":"text","value":" with questions\nor problems.","position":{"start":{"line":826,"column":1},"end":{"line":826,"column":1}},"key":"wqdOm0f2AJ"}],"key":"X8jXePI2ss"},{"type":"paragraph","position":{"start":{"line":829,"column":1},"end":{"line":829,"column":1}},"children":[{"type":"strong","position":{"start":{"line":829,"column":1},"end":{"line":829,"column":1}},"children":[{"type":"text","value":"Updated:","position":{"start":{"line":829,"column":1},"end":{"line":829,"column":1}},"key":"wFpI3JXjif"}],"key":"xDW86PwIeo"},{"type":"text","value":" 18 February 2026","position":{"start":{"line":829,"column":1},"end":{"line":829,"column":1}},"key":"TV8xXSttDs"}],"key":"Jk1vG5B4oX"},{"type":"paragraph","position":{"start":{"line":831,"column":1},"end":{"line":831,"column":1}},"children":[{"type":"strong","position":{"start":{"line":831,"column":1},"end":{"line":831,"column":1}},"children":[{"type":"text","value":"Runtime:","position":{"start":{"line":831,"column":1},"end":{"line":831,"column":1}},"key":"qC6cUt62fV"}],"key":"f0O8gB0Izo"},{"type":"text","value":" approximately 5 minutes","position":{"start":{"line":831,"column":1},"end":{"line":831,"column":1}},"key":"yY7EEIPJSE"}],"key":"atcLTzOA5H"}],"key":"OXCcJ2wz4a"}],"key":"MF4IOqemM0"},"references":{"cite":{"order":["https://doi.org/10.26131/irsa629"],"data":{"https://doi.org/10.26131/irsa629":{"label":"https://doi.org/10.26131/irsa629","enumerator":"1","doi":"10.26131/IRSA629","html":"SPHEREx Team. (2025). <i>SPHEREx Quick Release Spectral Images</i>. IPAC. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.26131/IRSA629\">10.26131/IRSA629</a>","url":"https://doi.org/10.26131/IRSA629"}}}},"footer":{"navigation":{"prev":{"title":"Understanding and Extracting the PSF Extension in a SPHEREx Cutout","short_title":"PSF Models","url":"/spherex-psf","group":"IRSA Tutorials"},"next":{"title":"Euclid Tutorial Notebooks","short_title":"Euclid","url":"/euclid","group":"IRSA Tutorials"}}},"domain":"http://localhost:3000"}