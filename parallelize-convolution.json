{"version":3,"kind":"Notebook","sha256":"be3de4ca759fb919d5fd62fae08292159c742da755c5a51a75357658eb0a7684","slug":"parallelize-convolution","location":"/tutorials/parallelize/Parallelize_Convolution.md","dependencies":[],"frontmatter":{"title":"Parallelizing image convolution","kernelspec":{"name":"python3","display_name":"Python [conda env:clonenv]","language":"python"},"jupytext":{"text_representation":{"extension":".md","format_name":"myst","format_version":"0.13","jupytext_version":"1.16.2"}},"execute":{"skip":true},"content_includes_title":false,"authors":[{"id":"IRSA Scientists and Developers","name":"IRSA Scientists and Developers"}],"github":"https://github.com/Caltech-IPAC/irsa-tutorials/","subject":"IRSA Tutorials","keywords":["astronomy"],"settings":{"output_matplotlib_strings":"remove"},"numbering":{"title":{"offset":1}},"source_url":"https://github.com/Caltech-IPAC/irsa-tutorials//blob/main/tutorials/parallelize/Parallelize_Convolution.md","edit_url":"https://github.com/Caltech-IPAC/irsa-tutorials//edit/main/tutorials/parallelize/Parallelize_Convolution.md","exports":[{"format":"md","filename":"Parallelize_Convolution.md","url":"/irsa-tutorials/build/Parallelize_Convolut-ea135cd9569cec4a465f9e544b8aa79e.md"}]},"mdast":{"type":"root","children":[{"type":"block","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"Learning Goals","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"dILnIXu7bJ"}],"identifier":"learning-goals","label":"Learning Goals","html_id":"learning-goals","implicit":true,"key":"Wd9B3Dz1qy"},{"type":"paragraph","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"By the end of this tutorial, you will be able to:","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"Y7kWSjiZ23"}],"key":"l4Yo6Qw3aU"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":24,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Employ three parallelization libraries to speed up a serial process.","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"SHxUn20D7K"}],"key":"bAiIkvOMCG"}],"key":"qxLc4hlOYc"},{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Calculate the speedup of the different approaches shown.","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"IL3fnc8o92"}],"key":"zhdQJaQuK8"}],"key":"NN8E3zzz9R"},{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Evaluate which library is suited to your task.","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"zO4OQ2L9ID"}],"key":"MBln8TbC9k"}],"key":"jnIYd1PR7F"}],"key":"j3jNzs01D0"}],"key":"QSu5jnUzQn"},{"type":"block","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"Introduction","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"cO822zztFb"}],"identifier":"introduction","label":"Introduction","html_id":"introduction","implicit":true,"key":"SfRCLS4YHM"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"This notebook shows how to speed up an image convolution task using these three libraries:","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"nbQXU4aYBL"}],"key":"h7JWip8bMT"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":34,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Ray: an open-source unified compute framework that makes it easy to scale AI and Python workloads.","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"hirwx4Jjgx"}],"key":"MASVDqKBE5"}],"key":"hYehfdbOi9"},{"type":"listItem","spread":true,"position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Multiprocessing: part of the standard library; supports spawning processes using an API similar to the threading module; offers both local and remote concurrency, effectively side-stepping the Global Interpreter Lock by using subprocesses instead of threads.","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"rPvT5JwrFQ"}],"key":"G3AqYckVPp"}],"key":"M0QBA8HNvO"},{"type":"listItem","spread":true,"position":{"start":{"line":36,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Dask: developed to natively scale computational packages like numpy, pandas and scikit-learn, and the surrounding ecosystem, to multi-core machines and distributed clusters when datasets exceed memory.","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"KHRgT3yDG4"}],"key":"emWx2PsGoG"}],"key":"ZNa8tidAT1"}],"key":"Up6PztDmAd"}],"key":"x5ulcH7tQ2"},{"type":"block","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"heading","depth":2,"position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"vAgEOZFIbP"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"jd3Xpk1KRw"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":42,"column":1},"end":{"line":48,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"paragraph","children":[{"type":"emphasis","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"text","value":"multiprocessing.Pool","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"uZDD8efMQa"}],"key":"Bbp9Dx4iQy"},{"type":"text","value":" for multiprocessing using the standard library","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"FGcrJgXZEm"}],"key":"vGf0RDkBtT"}],"key":"OJLd61tcqa"},{"type":"listItem","spread":true,"position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"children":[{"type":"paragraph","children":[{"type":"emphasis","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"children":[{"type":"text","value":"time","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"key":"pyxVNDLxwH"}],"key":"hCBlSchT2m"},{"type":"text","value":" for timing the processes","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"key":"eKsANIUy92"}],"key":"SpI1sZvjUt"}],"key":"ckBI7BBE2h"},{"type":"listItem","spread":true,"position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"paragraph","children":[{"type":"emphasis","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"text","value":"dask.distributed.Client","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"CVLCNi7Yru"}],"key":"YIq4XknwzX"},{"type":"text","value":" for making a local Dask cluster","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"oS5HGlAwFN"}],"key":"K9wJxNn7ny"}],"key":"idcyYjoZge"},{"type":"listItem","spread":true,"position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"paragraph","children":[{"type":"emphasis","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"numpy","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"rYyYWODS5y"}],"key":"ddKoWM38lC"},{"type":"text","value":" and ","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"nEh8HBTJPb"},{"type":"emphasis","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"scipy.signal","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"jSkwFxeoZA"}],"key":"OPee8YnvW2"},{"type":"text","value":" for numerical work","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"M8wcvLEQpq"}],"key":"tGprI0eo2w"}],"key":"FkjhVRZPxE"},{"type":"listItem","spread":true,"position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"children":[{"type":"paragraph","children":[{"type":"emphasis","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"children":[{"type":"text","value":"psutil","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"sE7BYfvqjq"}],"key":"wSosdV3E56"},{"type":"text","value":" for finding the available processors on your machine","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"nNL72EISkT"}],"key":"d8pxTzkDds"}],"key":"exnasBEbgO"},{"type":"listItem","spread":true,"position":{"start":{"line":47,"column":1},"end":{"line":48,"column":1}},"children":[{"type":"paragraph","children":[{"type":"emphasis","position":{"start":{"line":47,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"text","value":"ray","position":{"start":{"line":47,"column":1},"end":{"line":47,"column":1}},"key":"oVfSSieR1n"}],"key":"jrV51f2gtT"},{"type":"text","value":" for scaling up Python tasks","position":{"start":{"line":47,"column":1},"end":{"line":47,"column":1}},"key":"dKH2hw1Uly"}],"key":"ZYmX39lPAu"}],"key":"teoPCMUt8s"}],"key":"M2rhFUizl7"}],"key":"TEutNm3DC0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Uncomment the next line to install dependencies if needed.\n# !pip install dask[distributed] numpy ray scipy","key":"IPtfYFg8uR"},{"type":"outputs","id":"2i9I6NS9-0KcMR5JjaRg0","children":[],"key":"x6gtGbo97s"}],"key":"uWZVKXGucQ"},{"type":"block","children":[],"key":"Oiqh0nJXMN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from multiprocessing import Pool\nimport time\n\nfrom dask.distributed import Client\nimport numpy as np\nimport psutil\nimport scipy.signal\nimport ray","key":"QEhyde0xPR"},{"type":"outputs","id":"sLpipSUm66KHDhT8bARja","children":[],"key":"sl1fVZLHuj"}],"key":"LEPEQZ9wku"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"children":[{"type":"text","value":"Find the cpus available","position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"key":"qUR6EK71V8"}],"identifier":"find-the-cpus-available","label":"Find the cpus available","html_id":"find-the-cpus-available","implicit":true,"key":"Xm12Q0MAJw"},{"type":"paragraph","position":{"start":{"line":67,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"text","value":"Find and print the number of cpus\n(taken from ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"T5bDZJPG0k"},{"type":"link","url":"https://towardsdatascience.com/10x-faster-parallel-python-without-python-multiprocessing-e5017c93cce1","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"text","value":"https://​towardsdatascience​.com​/10x​-faster​-parallel​-python​-without​-python​-multiprocessing​-e5017c93cce1","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"bJSjCMIPw5"}],"urlSource":"https://towardsdatascience.com/10x-faster-parallel-python-without-python-multiprocessing-e5017c93cce1","key":"t49wqdlhJX"},{"type":"text","value":")","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"BtdrXWPKKo"}],"key":"hDerBlkse4"}],"key":"ADHIGGAZrE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"num_cpus = psutil.cpu_count(logical=True)\nprint(num_cpus)","key":"r6KSEchcsi"},{"type":"outputs","id":"kEi9SzrUOGMuxOfxZx4QS","children":[],"key":"XuKVg5fDTS"}],"key":"PKu6Wq7OCQ"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"children":[{"type":"text","value":"Process serially using a conventional loop","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"QLnab2q5kE"}],"identifier":"process-serially-using-a-conventional-loop","label":"Process serially using a conventional loop","html_id":"process-serially-using-a-conventional-loop","implicit":true,"key":"LC6qBZN0ZL"}],"key":"eVX80sczkI"},{"type":"block","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"text","value":"Use ","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"Ilg3W13bDG"},{"type":"inlineCode","value":"scipy.signal","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"mgAuZY5OAo"},{"type":"text","value":" to convolve two 2-dimensional arrays and return a 5x5 downsampled result.","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"Gui3wyIarA"}],"key":"wslU01miZP"}],"key":"Ld5ohnj7qv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def fconv(image, random_filter):\n    return scipy.signal.convolve2d(image, random_filter)[::5, ::5]","key":"U1ZDVHKJ08"},{"type":"outputs","id":"rTLlppja7gyjJ8s97JXGm","children":[],"key":"B8WmR6Z3vb"}],"key":"FaCWz9v7m7"},{"type":"block","children":[],"key":"uDKRIsbnF6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filters = [np.random.normal(size=(4, 4)) for _ in range(num_cpus)]","key":"z2pAYX5gd4"},{"type":"outputs","id":"mXj4vEr9X6vZohn2wPaIJ","children":[],"key":"CDias7zZbT"}],"key":"saQzcPd7sy"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"children":[{"type":"text","value":"Process 100 iterations serially, then extrapolate to num_cpus*100","position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"key":"IkuUn6ecqJ"}],"key":"PMPs7FWDyP"}],"key":"aAUXOp24h3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start = time.time()\nnum_iter = 100\nimage = np.zeros((3000, 3000))\nfor i in range(num_iter):\n    result = fconv(image, filters[i % num_cpus])\nduration_conv = time.time() - start\nprint(\"(scaled) conventional duration for {:d} iterations = {:.1f} seconds\"\n      .format(num_cpus*num_iter, duration_conv*num_cpus))","key":"Yk9SlpVGxe"},{"type":"outputs","id":"j6BufY1HKS_Ng88h98FDc","children":[],"key":"FsPkwF1Umo"}],"key":"IT8T6o0K6v"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"children":[{"type":"text","value":"Process in parallel using Ray","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"mWlqJjryiF"}],"identifier":"process-in-parallel-using-ray","label":"Process in parallel using Ray","html_id":"process-in-parallel-using-ray","implicit":true,"key":"RXwlyxyPAK"}],"key":"tDWEtIMMAM"},{"type":"block","position":{"start":{"line":105,"column":1},"end":{"line":105,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":107,"column":1},"end":{"line":107,"column":1}},"children":[{"type":"link","url":"https://docs.ray.io/en/latest/","position":{"start":{"line":107,"column":1},"end":{"line":107,"column":1}},"children":[{"type":"text","value":"Documentation for ray","position":{"start":{"line":107,"column":1},"end":{"line":107,"column":1}},"key":"QFcSPhNhGN"}],"urlSource":"https://docs.ray.io/en/latest/","key":"frN6jbktb9"}],"key":"QCGOacFcNv"}],"key":"nMz3g1IA7v"},{"type":"block","position":{"start":{"line":109,"column":1},"end":{"line":109,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"children":[{"type":"text","value":"The warning raised by ","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"key":"Mnt8wifLps"},{"type":"inlineCode","value":"ray.init","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"key":"PypTrGtQb1"},{"type":"text","value":" only affects shared object usage, which is not an issue for this tutorial. It may harm performance in other scenarios.","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"key":"rHvrYYTKAN"}],"key":"CX5rac88WB"}],"key":"Z90qOecu5P"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ray.init(num_cpus=num_cpus)","key":"cffuUo3VzQ"},{"type":"outputs","id":"SLUKN1qiFmJX6CrT7IA7b","children":[],"key":"nOjnJQH9PW"}],"key":"O1elDrEYg3"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"text","value":"Use ","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"Z5SqQF1Q1x"},{"type":"inlineCode","value":"scipy.signal","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"FkQgZJJd6k"},{"type":"text","value":" to convolve two 2-dimensional arrays and return a 5x5 downsampled result. To use Ray, we decorate the function that is doing the work.","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"Vm8V5omFGB"}],"key":"mOLwmfrvEH"}],"key":"aCDtIz7OoC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@ray.remote\ndef fray(image, random_filter):\n    return scipy.signal.convolve2d(image, random_filter)[::5, ::5]","key":"gRHiaqxbsG"},{"type":"outputs","id":"UPV21DbIdkpdd-CAVbFYO","children":[],"key":"MR4DNCwgRp"}],"key":"rmu7B7YGCi"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"children":[{"type":"text","value":"In the following loop, ","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"PVdghGIaEA"},{"type":"inlineCode","value":"ray.put","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"MVPwNUBAIz"},{"type":"text","value":" places the image into shared memory. The call to ","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"RVrGK4eJXI"},{"type":"inlineCode","value":"ray.get","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"TvHLLRn5DS"},{"type":"text","value":" retrieves the result.","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"XL1nMyvM3O"}],"key":"PlQmQk1Ewb"}],"key":"zRuHxvqrdt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start = time.time()\nimage = np.zeros((3000, 3000))\nfor _ in range(100):\n    image_id = ray.put(image)\n    ray.get([fray.remote(image_id, filters[i]) for i in range(num_cpus)])\nduration_ray = time.time() - start\nprint(\"Ray duration = {:.1f}, speedup = {:.2f}\"\n      .format(duration_ray, duration_conv*num_cpus / duration_ray))","key":"vQlM0OjXa5"},{"type":"outputs","id":"_-Pa8cBpaTt_nE2WxyS-N","children":[],"key":"hq6ctuoXdS"}],"key":"wXJTos22nJ"},{"type":"block","children":[],"key":"EKrH5l6sfj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ray.shutdown()","key":"yXJYQjz0YP"},{"type":"outputs","id":"5HAPod3hCizUN-a0HwHtS","children":[],"key":"UKtJACqCkB"}],"key":"PwfjDRKCqx"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"children":[{"type":"text","value":"Process in parallel using multiprocessing","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"key":"ZdStEjgDKt"}],"identifier":"process-in-parallel-using-multiprocessing","label":"Process in parallel using multiprocessing","html_id":"process-in-parallel-using-multiprocessing","implicit":true,"key":"ErhoCfZAN8"}],"key":"jeUskFRA0r"},{"type":"block","position":{"start":{"line":144,"column":1},"end":{"line":144,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":146,"column":1},"end":{"line":146,"column":1}},"children":[{"type":"link","url":"https://docs.python.org/3/library/multiprocessing.html","position":{"start":{"line":146,"column":1},"end":{"line":146,"column":1}},"children":[{"type":"text","value":"Documentation for multiprocessing","position":{"start":{"line":146,"column":1},"end":{"line":146,"column":1}},"key":"R50VTr0idj"}],"urlSource":"https://docs.python.org/3/library/multiprocessing.html","key":"CF2zFQYMtl"}],"key":"CMhucf6rWq"}],"key":"s9XNfUChps"},{"type":"block","position":{"start":{"line":148,"column":1},"end":{"line":148,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"children":[{"type":"text","value":"Use ","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"jWl5jekKJp"},{"type":"inlineCode","value":"scipy.signal","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"NtleYfiSyB"},{"type":"text","value":" to convolve two 2-dimensional arrays and return a 5x5 downsampled result. The call to the function has a slightly different form than that for the serial loop.","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"b7LGdCfIIW"}],"key":"DdLGGOL4tN"}],"key":"dRH9OpeVC2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Note: Mac and Windows users may need to copy the contents of this cell into a separate '.py' file\n# and then import it in order to use the `fmp` function with `multiprocessing`. This has to do with\n# differences in what does / does not get copied into the child processes in different operating systems.\nimport scipy.signal\n\ndef fmp(args):\n    image, random_filter = args\n    return scipy.signal.convolve2d(image, random_filter)[::5, ::5]","key":"L4Q9r2CXGy"},{"type":"outputs","id":"I93t7JcQlJzgI1C8UHYnT","children":[],"key":"E5amGEooXb"}],"key":"Lzrlg3oMRp"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":163,"column":1},"end":{"line":163,"column":1}},"children":[{"type":"text","value":"Use a multiprocessing pool with the number of cpus we found earlier.","position":{"start":{"line":163,"column":1},"end":{"line":163,"column":1}},"key":"sbpqy7v0sl"}],"key":"jTXmXuBdxI"}],"key":"fnGjSIAZlY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"pool = Pool(num_cpus)","key":"TnY7ObtxMq"},{"type":"outputs","id":"78h3YnhIpQDmxR9gTyzUT","children":[],"key":"xOHS9HgjGl"}],"key":"GQbLQEjQhM"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"children":[{"type":"text","value":"Using ","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"KXTXgYrkdf"},{"type":"inlineCode","value":"pool.map","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"elpBA6bM0y"},{"type":"text","value":" is the closest analog in multiprocessing to the Ray API.","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"TuQPh7DTwj"}],"key":"kMwxiiilni"}],"key":"uJsQ64UJiN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start = time.time()\nimage = np.zeros((3000, 3000))\nfor _ in range(100):\n    pool.map(fmp, zip(num_cpus * [image], filters))\nduration_mp = time.time() - start\nprint(\"Multiprocessing duration = {:.1f}, speedup = {:.2f}\"\n      .format(duration_mp, duration_conv*num_cpus / duration_mp))","key":"Ja08IqBbvJ"},{"type":"outputs","id":"3fZwHsXkvzZw5aKZ0DstV","children":[],"key":"nvvdZkNfjT"}],"key":"olE9MXqvWR"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":181,"column":1},"end":{"line":181,"column":1}},"children":[{"type":"text","value":"Process using Dask","position":{"start":{"line":181,"column":1},"end":{"line":181,"column":1}},"key":"viJB3Ij0lR"}],"identifier":"process-using-dask","label":"Process using Dask","html_id":"process-using-dask","implicit":true,"key":"sLaTNZDSO2"}],"key":"JMiGJOM5ZF"},{"type":"block","position":{"start":{"line":183,"column":1},"end":{"line":183,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":185,"column":1},"end":{"line":185,"column":1}},"children":[{"type":"link","url":"https://www.dask.org/get-started","position":{"start":{"line":185,"column":1},"end":{"line":185,"column":1}},"children":[{"type":"text","value":"Documentation for Dask","position":{"start":{"line":185,"column":1},"end":{"line":185,"column":1}},"key":"UZrPMMJ1ug"}],"urlSource":"https://www.dask.org/get-started","key":"btffCZnKY4"}],"key":"fEguetMAWX"}],"key":"LbnLHmVHhg"},{"type":"block","position":{"start":{"line":187,"column":1},"end":{"line":187,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":189,"column":1},"end":{"line":189,"column":1}},"children":[{"type":"text","value":"Define a Dask distributed client with number of workers set to the number of cpus we found earlier, and with one thread per worker.","position":{"start":{"line":189,"column":1},"end":{"line":189,"column":1}},"key":"u2C69O3gU2"}],"key":"Dzk0OUM2Cj"}],"key":"YLpuc0EOLs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client(n_workers=num_cpus, threads_per_worker=1)","key":"eV85MSfcVg"},{"type":"outputs","id":"J5VVX084ETMEEnUQXaviB","children":[],"key":"nvZV7i36G2"}],"key":"TWCjDlzxqu"},{"type":"block","children":[],"key":"qRHp6jo2Xo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(client)","key":"hJNz2wnyuX"},{"type":"outputs","id":"mV61ukk0wOZmTdUhsgMRP","children":[],"key":"imFuuY1EGw"}],"key":"WhDoggaO0z"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"children":[{"type":"text","value":"Dask recommends scattering the large inputs across the workers, though this makes little difference in execution time.","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"XqagjdQzdB"}],"key":"fg1Po1d3Ou"}],"key":"ODDgvC0GtF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start = time.time()\nimage = np.zeros((3000, 3000))\nfor _ in range(100):\n    for j in range(num_cpus):\n        big_future = client.scatter((image, filters[j % num_cpus]))\n        future = client.submit(fmp, big_future)\nduration_dask = time.time() - start\nprint(\"Dask duration = {:.1f}, speedup = {:.2f}\"\n      .format(duration_dask, duration_conv*num_cpus / duration_dask))","key":"iXpkTEgmAM"},{"type":"outputs","id":"LfGMqZZRLcGHveEswIq4V","children":[],"key":"nlSPp3TNEo"}],"key":"GyH4mtcAN7"},{"type":"block","children":[],"key":"P95GuivvnZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close()","key":"TZTn8bkDYU"},{"type":"outputs","id":"ndUDMaODqmT9A50C3RMrG","children":[],"key":"dnuOhJeQ4x"}],"key":"vAOlzAv8Iz"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"children":[{"type":"text","value":"Conclusions","position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"key":"QX30jfUXOF"}],"identifier":"conclusions","label":"Conclusions","html_id":"conclusions","implicit":true,"key":"R4GNZp5rKt"}],"key":"KNv2k1NOjc"},{"type":"block","position":{"start":{"line":219,"column":1},"end":{"line":219,"column":1}},"children":[{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":221,"column":1},"end":{"line":224,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":221,"column":1},"end":{"line":221,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Ray is the most effective at speeding up the convolution workload by fully utilizing all available processes","position":{"start":{"line":221,"column":1},"end":{"line":221,"column":1}},"key":"Fvk9Sm44u4"}],"key":"lnu7TbmZGT"}],"key":"H1z2UUFDhu"},{"type":"listItem","spread":true,"position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Multiprocessing is second in effectiveness","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"jfeYl4xBmE"}],"key":"bvsCGwl4nr"}],"key":"AVATI6oLDo"},{"type":"listItem","spread":true,"position":{"start":{"line":223,"column":1},"end":{"line":224,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Dask delivers the least speedup; perhaps due to having only six processes on the dask.distributed client","position":{"start":{"line":223,"column":1},"end":{"line":223,"column":1}},"key":"yyOCPhgxYU"}],"key":"I2pfot9yrr"}],"key":"bh49sY7zME"}],"key":"PjKc5cINCd"}],"key":"gBR8490kSH"},{"type":"block","position":{"start":{"line":225,"column":1},"end":{"line":225,"column":1}},"children":[{"type":"thematicBreak","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"UTnfDjNNDO"},{"type":"heading","depth":2,"position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"children":[{"type":"text","value":"About this notebook","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"key":"HMvWoSlesk"}],"identifier":"about-this-notebook","label":"About this notebook","html_id":"about-this-notebook","implicit":true,"key":"JHizAENSRP"},{"type":"paragraph","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"children":[{"type":"strong","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"children":[{"type":"text","value":"Author:","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"key":"Da7sepP6TU"}],"key":"sXPYp1oPug"},{"type":"text","value":" David Shupe in conjunction with Jessica Krick and the IRSA Science Platform team at IPAC.","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"key":"p9T1UoYH2Z"}],"key":"esdHE7BhEU"},{"type":"paragraph","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"children":[{"type":"strong","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"children":[{"type":"text","value":"Updated:","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"LtDRZ1t3Jp"}],"key":"IwSvk3tNs1"},{"type":"text","value":" 2024-09-24","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"gpJsP7ZvOP"}],"key":"VCuR7jMsPr"},{"type":"paragraph","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"children":[{"type":"strong","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"children":[{"type":"text","value":"Contact:","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"BytupIP7pO"}],"key":"eBwhYasSKW"},{"type":"text","value":" ","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"KJrSBcH97s"},{"type":"link","url":"https://irsa.ipac.caltech.edu/docs/help_desk.html","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"children":[{"type":"text","value":"the IRSA Helpdesk","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"aFxtNBM0o1"}],"urlSource":"https://irsa.ipac.caltech.edu/docs/help_desk.html","key":"r5vyR3JH5p"},{"type":"text","value":" with questions or reporting problems.","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"q46hY0evT6"}],"key":"ADkc3TQmaP"},{"type":"heading","depth":2,"position":{"start":{"line":236,"column":1},"end":{"line":236,"column":1}},"children":[{"type":"text","value":"Citations","position":{"start":{"line":236,"column":1},"end":{"line":236,"column":1}},"key":"XXs9Vdp78j"}],"identifier":"citations","label":"Citations","html_id":"citations","implicit":true,"key":"Qp1YeVV5PC"},{"type":"paragraph","position":{"start":{"line":238,"column":1},"end":{"line":238,"column":1}},"children":[{"type":"text","value":"If you use these software packages in your work, please use the following citations:","position":{"start":{"line":238,"column":1},"end":{"line":238,"column":1}},"key":"pdygEd8sj4"}],"key":"VRU0ZY9961"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":240,"column":1},"end":{"line":242,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Dask: Dask Development Team (2016). Dask: Library for dynamic task scheduling. URL ","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"key":"y639jRXZLx"},{"type":"link","url":"https://dask.org","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"children":[{"type":"text","value":"https://dask.org","position":{"start":{"line":240,"column":1},"end":{"line":240,"column":1}},"key":"JQVfy5Pjr4"}],"urlSource":"https://dask.org","key":"ZF9VmBTscB"}],"key":"jr1ZiUIk0i"}],"key":"DvRQrQgrZu"},{"type":"listItem","spread":true,"position":{"start":{"line":241,"column":1},"end":{"line":242,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Ray: The Ray Development Team. URL ","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"key":"mK4JmQRdal"},{"type":"link","url":"https://docs.ray.io","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"children":[{"type":"text","value":"https://docs.ray.io","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"key":"vBXKiwFYzP"}],"urlSource":"https://docs.ray.io","key":"PEwmUIDza8"}],"key":"rbQkC6mFJb"}],"key":"K3RESrqqCD"}],"key":"JxG5h4IGtG"}],"key":"zAOSAosr8t"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"VOdzRCY92G"},{"type":"outputs","id":"4_HjkY4c-2pkIXKGy9irB","children":[],"key":"EXWBX5aNKa"}],"key":"RzFdcqYKQW"}],"key":"OfD9guDSN1"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Using Firefly visualization tools in Python to vet SEDs","url":"/seds-in-firefly","group":"Special Topics"}}},"domain":"http://localhost:3000"}