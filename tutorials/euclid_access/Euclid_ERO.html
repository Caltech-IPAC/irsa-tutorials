
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Exploring Star Clusters in the Euclid ERO Data &#8212; IRSA Demo Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/euclid_access/Euclid_ERO';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Euclid Q1: MER mosaics" href="1_Euclid_intro_MER_images.html" />
    <link rel="prev" title="Euclid Q1: cloud access" href="../cloud_access/euclid-cloud-access.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
     
  

<a class="navbar-brand logo" href="https://irsa.ipac.caltech.edu/">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/irsa_logo.png" class="logo__image only-light" alt="NASA/IPAC Infrared Science Archive - Home"/>
    <script>document.write(`<img src="../../_static/irsa_logo.png" class="logo__image only-dark" alt="NASA/IPAC Infrared Science Archive - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Caltech-IPAC/irsa-tutorials" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Caltech/IPAC–IRSA Python Notebook Tutorials
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">VO on-prem data access</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../irsa-sia-examples/sia_2mass_allsky.html">Searching for 2MASS All-Sky Atlas Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../irsa-sia-examples/sia_allwise_atlas.html">Searching for AllWISE Atlas Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../irsa-sia-examples/sia_cosmos.html">Searching for contributed COSMOS images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../irsa-sia-examples/siav2_seip.html">Searching for Spitzer Enhanced Imaging Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cosmodc2/cosmoDC2_TAP_access.html">Querying CosmoDC2 Mock v1 catalogs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cloud data access</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../cloud_access/cloud-access-intro.html">IRSA cloud access introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parquet-catalog-demos/wise-allwise-catalog-demo.html">Analyzing cloud-hosted AllWISE Source Catalog in Parquet format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parquet-catalog-demos/neowise-source-table-strategies.html">Strategies to Efficiently Work with NEOWISE Single-exposure Source Table in Parquet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parquet-catalog-demos/neowise-source-table-lightcurves.html">Make Light Curves from NEOWISE Single-exposure Source Table</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openuniversesims/openuniverse2024_roman_simulated_timedomainsurvey.html">Analyzing cloud-hosted simulated Roman Time Domain Survey images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openuniversesims/openuniverse2024_roman_simulated_wideareasurvey.html">Analyzing cloud-hosted simulated Roman coadded images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_access/euclid-cloud-access.html">Euclid Q1: cloud access</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Euclid Early Release Observations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Exploring Star Clusters in the Euclid ERO Data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Euclid Quick Release 1</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1_Euclid_intro_MER_images.html">Euclid Q1: MER mosaics</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_Euclid_intro_MER_catalog.html">Euclid Q1: MER catalogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_Euclid_intro_1D_spectra.html">Euclid Q1: 1D spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_Euclid_intro_PHZ_catalog.html">Euclid Q1: PHZ catalogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_Euclid_intro_SPE_catalog.html">Euclid Q1: SPE catalogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud_access/euclid-cloud-access.html">Euclid Q1: cloud access</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SPHEREx Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spherex/spherex_intro.html">Introduction to SPHEREx Spectral Images</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizations with Firefly</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../firefly/SEDs_in_Firefly.html">Using Firefly visualization tools in Python to vet SEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../firefly/NEOWISE_light_curve_demo.html">Using Firefly visualization tools to understand the light curves of Solar System objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../firefly/OpenUniverse2024Preview_Firefly.html">Using Firefly to Explore OpenUniverse2024 Data Preview Simulated Roman and Rubin Images</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Simulated Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../roman_simulations/roman_hlss_number_density.html">Number Density as a Function of Redshift</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Generic techniques</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../parallelize/Parallelize_Convolution.html">Parallelizing image convolution</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/Caltech-IPAC/irsa-tutorials/main?urlpath=tree/tutorials/euclid_access/Euclid_ERO.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Caltech-IPAC/irsa-tutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Caltech-IPAC/irsa-tutorials/edit/main/tutorials/euclid_access/Euclid_ERO.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Caltech-IPAC/irsa-tutorials/issues/new?title=Issue%20on%20page%20%2Ftutorials/euclid_access/Euclid_ERO.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/tutorials/euclid_access/Euclid_ERO.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../../_sources/tutorials/euclid_access/Euclid_ERO.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Exploring Star Clusters in the Euclid ERO Data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-volume">Data Volume</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-environment">Setting up the Environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#search-euclid-ero-images">Search Euclid ERO Images</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-cutout-images">Create Cutout Images</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-sources-and-measure-their-photometry-on-the-vis-image">Extract Sources and Measure their Photometry on the VIS Image</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measure-the-photometry-on-the-nisp-images">Measure the Photometry on the NISP Images</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-gaia-catalog">Load Gaia Catalog</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#match-the-gaia-catalog-to-the-vis-and-nisp-catalogs">Match the Gaia Catalog to the VIS and NISP Catalogs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-with-firefly">Visualization with Firefly</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="exploring-star-clusters-in-the-euclid-ero-data">
<h1>Exploring Star Clusters in the Euclid ERO Data<a class="headerlink" href="#exploring-star-clusters-in-the-euclid-ero-data" title="Link to this heading">#</a></h1>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h2>
<p>By the end of this tutorial, you will be able to:</p>
<p>• Access the Euclid ERO images using <code class="docutils literal notranslate"><span class="pre">astroquery</span></code></p>
<p>• Create cutouts on the large Euclid ERO images directly</p>
<p>• Extract sources on the Euclid image and run photometry tools</p>
<p>• Compare photometry to the Gaia catalog</p>
<p>• Visualize the Euclid ERO image and the Gaia catalog in <code class="docutils literal notranslate"><span class="pre">Firefly</span></code></p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>Euclid is a European Space Agency (ESA) space mission with NASA participation, to study the geometry and nature of the dark Universe. As part of its first observations, Euclid publicly released so-called <em>Early Release Observations</em> (ERO) targeting some press-worthy targets on the sky such as star clusters or local galaxies.</p>
<p>In this notebook, we will focus on the ERO data of <strong>NGC 6397</strong>, a globular cluster 78,000 light years away. (Note that there is another globular cluster, <strong>NGC 6254</strong> that can also be used for this analysis - in fact the user can choose which one to use) The goal of this analysis is to extract the Euclid photometry of the stars belonging to the cluster and compare them to the photometry of Gaia. Due to the different pixel scales of the visible (VIS, <span class="math notranslate nohighlight">\(0.1^{\prime\prime}\)</span>) and near-IR (NISP, <span class="math notranslate nohighlight">\(0.3^{\prime\prime}\)</span>) wavelengths, we will first detect and extract the stars in the VIS filter and use their position to subsequently extract the photometry in the NISP (Y, J, H) filters (a method also referred to as <em>forced photometry</em>).</p>
<p>One challenge with Euclid data is their size due to the large sky coverage and small pixel size.
This notebook demonstrates how to download only a cutout of the large Euclid ERO observation image (namely focussing only on the position of the globular cluster. Furthermore, this notebook demonstrates how to extract sources on a large astronomical image and how to measure their photometry across different pixel scales using a very simple implementation of the forced photometry method with positional priors.
Finally, we also demonstrate how to visualize the Euclid images and catalog in <code class="docutils literal notranslate"><span class="pre">Firefly</span></code>, an open-source web-based UI library for astronomical data archive access and visualization developed at Caltech (https://github.com/Caltech-IPAC/firefly). <code class="docutils literal notranslate"><span class="pre">Firefly</span></code> is a convenient tool to visualize images similar to DS9 on your local computer, but it can run on a cloud-based science platform.</p>
<p>This notebook is written to be used in Fornax which is a cloud based computing platform using AWS. The advantage of this is that the user does not need to download actuall data, hence the analysis of large datasets is not limited by local computing resources. It also allows to access data across all archives fast and easy.</p>
</section>
<section id="data-volume">
<h2>Data Volume<a class="headerlink" href="#data-volume" title="Link to this heading">#</a></h2>
<p>The total data volume required for running this notebook is less than 20 MB.</p>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We rely on <code class="docutils literal notranslate"><span class="pre">astroquery</span></code>, <code class="docutils literal notranslate"><span class="pre">firefly_client</span></code>, <code class="docutils literal notranslate"><span class="pre">photutils</span></code>, and <code class="docutils literal notranslate"><span class="pre">sep</span></code> features that have been recently added, so please make sure you have the respective versions v0.4.10, v3.2, v2.0, and v1.4 or newer installed.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment the next line to install dependencies if needed.</span>
<span class="c1"># !pip install tqdm numpy matplotlib astropy &#39;photutils&gt;=2.0&#39; &#39;astroquery&gt;=0.4.10&#39; &#39;sep&gt;=1.4&#39; &#39;firefly_client&gt;=3.2&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>First, we import all necessary packages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># General imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Astroquery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.ipac.irsa</span><span class="w"> </span><span class="kn">import</span> <span class="n">Irsa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.gaia</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaia</span>

<span class="c1"># Astropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cutout2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span>

<span class="c1"># Photometry tools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSFPhotometry</span><span class="p">,</span> <span class="n">IterativePSFPhotometry</span><span class="p">,</span> <span class="n">CircularGaussianSigmaPRF</span><span class="p">,</span> <span class="n">make_psf_model_image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalBackground</span><span class="p">,</span> <span class="n">MMMBackground</span>

<span class="c1"># Firefly</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">firefly_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">FireflyClient</span>

<span class="c1"># Matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/work/irsa-tutorials/irsa-tutorials/.tox/py311-buildhtml/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
</div>
</div>
<p>Next, we define some parameters for <code class="docutils literal notranslate"><span class="pre">Matplotlib</span></code> plotting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Plotting stuff</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelpad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.major.pad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.major.pad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.minor.visible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.minor.visible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.minor.top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.minor.bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.minor.left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.minor.right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.major.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.major.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.minor.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.minor.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span>
<span class="c1">#mpl.rc(&#39;text&#39;, usetex=True)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;hatch.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">def_cols</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-up-the-environment">
<h2>Setting up the Environment<a class="headerlink" href="#setting-up-the-environment" title="Link to this heading">#</a></h2>
<p>Next, we set up the environment. This includes</p>
<ul class="simple">
<li><p>setting up an output data directory (will be created if it does not exist)</p></li>
<li><p>define the search radius around the target of interest to pull data from the Gaia catalog</p></li>
<li><p>define the cutout size that will be used to download a certain part of the Euclid ERO images</p></li>
</ul>
<p>Finally, we also define the target of interest here. We can choose between two globular clusters, <strong>NGC 6254</strong> and <strong>NGC6397</strong>, both covered by the Euclid ERO data.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">astropy</span></code> units can be attached to the <code class="docutils literal notranslate"><span class="pre">search_radius</span></code> and <code class="docutils literal notranslate"><span class="pre">cutout_size</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create output directory</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;./data/&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output directory already created.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating data directory.&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;./data/&quot;</span><span class="p">)</span>

<span class="n">search_radius</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span> <span class="c1"># search radius</span>
<span class="n">cutout_size</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span> <span class="c1"># cutout size</span>

<span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s1">&#39;NGC 6397&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output directory already created.
</pre></div>
</div>
</div>
</div>
</section>
<section id="search-euclid-ero-images">
<h2>Search Euclid ERO Images<a class="headerlink" href="#search-euclid-ero-images" title="Link to this heading">#</a></h2>
<p>Now, we search for the Euclid ERO images using the <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> package.
Note that the Euclid ERO images are no in the cloud currently, but we access them directly from IRSA using IRSA’s <em>Simple Image Access</em> (SIA) methods.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following only works for combined images (either extended or point source stacks). This would not work if there are multiple, let’s say, H-band images of Euclid at a given position. Therefore, no time domain studies here (which is anyway not one of the main goals of Euclid).</p>
</div>
<p>Here we use the collection <em>euclid_ero</em>, containing the Euclid ERO images. We first create a <code class="docutils literal notranslate"><span class="pre">SkyCoord</span></code> object and then query the SIA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_tab</span> <span class="o">=</span> <span class="n">Irsa</span><span class="o">.</span><span class="n">query_sia</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">search_radius</span><span class="p">),</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;euclid_ero&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of images available: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_tab</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of images available: 25
</pre></div>
</div>
</div>
</div>
<p>Sort the queried table by wavelength (column <code class="docutils literal notranslate"><span class="pre">em_min</span></code>). This allows us later when we plot the images to keep them sorted by wavelength (VIS, Y, J, H).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_tab</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;em_min&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s inspec the table that was downloaded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_tab</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=3</i>
<table id="table139730245437008" class="table-striped table-bordered table-condensed">
<thead><tr><th>s_ra</th><th>s_dec</th><th>facility_name</th><th>instrument_name</th><th>dataproduct_subtype</th><th>calib_level</th><th>dataproduct_type</th><th>energy_bandpassname</th><th>energy_emband</th><th>obs_id</th><th>s_resolution</th><th>em_min</th><th>em_max</th><th>em_res_power</th><th>proposal_title</th><th>access_url</th><th>access_format</th><th>access_estsize</th><th>t_exptime</th><th>s_region</th><th>obs_collection</th><th>obs_intent</th><th>algorithm_name</th><th>facility_keywords</th><th>instrument_keywords</th><th>environment_photometric</th><th>proposal_id</th><th>proposal_pi</th><th>proposal_project</th><th>target_name</th><th>target_type</th><th>target_standard</th><th>target_moving</th><th>target_keywords</th><th>obs_release_date</th><th>s_xel1</th><th>s_xel2</th><th>s_pixel_scale</th><th>position_timedependent</th><th>t_min</th><th>t_max</th><th>t_resolution</th><th>t_xel</th><th>obs_publisher_did</th><th>s_fov</th><th>em_xel</th><th>pol_states</th><th>pol_xel</th><th>cloud_access</th><th>o_ucd</th><th>upload_row_id</th></tr></thead>
<thead><tr><th>deg</th><th>deg</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th>arcsec</th><th>m</th><th>m</th><th></th><th></th><th></th><th></th><th>kbyte</th><th>s</th><th>deg</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th>arcsec</th><th></th><th>d</th><th>d</th><th>s</th><th></th><th></th><th>deg</th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>object</th><th>object</th><th>object</th><th>int16</th><th>object</th><th>object</th><th>object</th><th>object</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>object</th><th>object</th><th>object</th><th>int64</th><th>float64</th><th>object</th><th>object</th><th>object</th><th>object</th><th>object</th><th>object</th><th>bool</th><th>object</th><th>object</th><th>object</th><th>object</th><th>object</th><th>bool</th><th>bool</th><th>object</th><th>object</th><th>int64</th><th>int64</th><th>float64</th><th>bool</th><th>float64</th><th>float64</th><th>float64</th><th>int64</th><th>object</th><th>float64</th><th>int64</th><th>object</th><th>int64</th><th>object</th><th>object</th><th>int64</th></tr></thead>
<tr><td>265.1744234</td><td>-53.6588139</td><td>Euclid</td><td>VIS</td><td>weight</td><td>3</td><td>image</td><td>VIS</td><td>Optical</td><td>VIS-ERO-NGC6397</td><td>0.16</td><td>5.5e-07</td><td>9e-07</td><td>2.1</td><td>Euclid Early Release Observations</td><td>https://irsa.ipac.caltech.edu/data/Euclid/ERO/images/NGC6397/ERO-NGC6397/Euclid-VIS-ERO-NGC6397-Flattened.DR3.weight.fits</td><td>image/fits</td><td>5184009</td><td>--</td><td>POLYGON ICRS 266.0282156 -54.1557675 266.0082 -53.1559013 264.3406 -53.1559013 264.3205844 -54.1557675 266.0282156 -54.1557675</td><td>euclid_ero</td><td>science</td><td>coadd</td><td></td><td></td><td>--</td><td></td><td></td><td>Euclid</td><td>NGC 6397</td><td>object</td><td>False</td><td>False</td><td></td><td>2024-05-23 00:00:00</td><td>36000</td><td>36000</td><td>0.1000000000008</td><td>False</td><td>--</td><td>--</td><td>--</td><td>--</td><td>ivo://irsa.ipac/euclid_ero?VIS-ERO-NGC6397/Flattened</td><td>1.000000000008</td><td>--</td><td></td><td>--</td><td>{}</td><td></td><td>1</td></tr>
<tr><td>265.1744234</td><td>-53.6588139</td><td>Euclid</td><td>VIS</td><td>science</td><td>3</td><td>image</td><td>VIS</td><td>Optical</td><td>VIS-ERO-NGC6397</td><td>0.16</td><td>5.5e-07</td><td>9e-07</td><td>2.1</td><td>Euclid Early Release Observations</td><td>https://irsa.ipac.caltech.edu/data/Euclid/ERO/images/NGC6397/ERO-NGC6397/Euclid-VIS-ERO-NGC6397-Flattened.DR3.fits</td><td>image/fits</td><td>5184009</td><td>--</td><td>POLYGON ICRS 266.0282156 -54.1557675 266.0082 -53.1559013 264.3406 -53.1559013 264.3205844 -54.1557675 266.0282156 -54.1557675</td><td>euclid_ero</td><td>science</td><td>coadd</td><td></td><td></td><td>--</td><td></td><td></td><td>Euclid</td><td>NGC 6397</td><td>object</td><td>False</td><td>False</td><td></td><td>2024-05-23 00:00:00</td><td>36000</td><td>36000</td><td>0.1000000000008</td><td>False</td><td>--</td><td>--</td><td>--</td><td>--</td><td>ivo://irsa.ipac/euclid_ero?VIS-ERO-NGC6397/Flattened</td><td>1.000000000008</td><td>--</td><td></td><td>--</td><td>{}</td><td></td><td>1</td></tr>
<tr><td>265.1744234</td><td>-53.6588139</td><td>Euclid</td><td>VIS</td><td>auxiliary</td><td>3</td><td>image</td><td>VIS</td><td>Optical</td><td>VIS-ERO-NGC6397</td><td>0.16</td><td>5.5e-07</td><td>9e-07</td><td>2.1</td><td>Euclid Early Release Observations</td><td>https://irsa.ipac.caltech.edu/data/Euclid/ERO/images/NGC6397/ERO-NGC6397/Euclid-VIS-Mask-ERO-NGC6397-LSB.DR3.fits</td><td>image/fits</td><td>5184006</td><td>--</td><td>POLYGON ICRS 266.0282156 -54.1557675 266.0082 -53.1559013 264.3406 -53.1559013 264.3205844 -54.1557675 266.0282156 -54.1557675</td><td>euclid_ero</td><td>science</td><td>coadd</td><td></td><td></td><td>--</td><td></td><td></td><td>Euclid</td><td>NGC 6397</td><td>object</td><td>False</td><td>False</td><td></td><td>2024-05-23 00:00:00</td><td>36000</td><td>36000</td><td>0.1000000000008</td><td>False</td><td>--</td><td>--</td><td>--</td><td>--</td><td>ivo://irsa.ipac/euclid_ero?VIS-ERO-NGC6397/LSB</td><td>1.000000000008</td><td>--</td><td></td><td>--</td><td>{}</td><td></td><td>1</td></tr>
</table></div></div></div>
</div>
<p>Next, we add additional restrictions to narrow down the images.</p>
<p>The Euclid ERO images come in two different flavors:</p>
<ul class="simple">
<li><p><em>Flattened</em> images: idealized for compact sources (for example stars)</p></li>
<li><p><em>LSB</em> images: idealized for low surface brightness objects (for example galaxies)</p></li>
</ul>
<p>Maybe counter-intuitively, we select the <em>LSB</em> images here by checking if the file name given in the URL (<code class="docutils literal notranslate"><span class="pre">access_url</span></code> column) contains that key word. We found that the <em>Flattened</em> images contain many masked pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#sel_basic = np.where( [&quot;Flattened&quot; in tt[&quot;access_url&quot;] for tt in image_tab] )[0]</span>
<span class="n">sel_basic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">[</span><span class="s2">&quot;LSB&quot;</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">[</span><span class="s2">&quot;access_url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">image_tab</span><span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">image_tab</span> <span class="o">=</span> <span class="n">image_tab</span><span class="p">[</span><span class="n">sel_basic</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we want to check what filteres are available. This can be done by <code class="docutils literal notranslate"><span class="pre">np.unique()</span></code>, however, in that case it would sort the filters alphabetically. We want to keep the sorting based on the wavelength, therefore we opt for a more complicated way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s2">&quot;energy_bandpassname&quot;</span><span class="p">],</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_tab</span><span class="p">[</span><span class="s2">&quot;energy_bandpassname&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idxs</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filters: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filters: [&#39;VIS&#39;, &#39;Y&#39;, &#39;J&#39;, &#39;H&#39;]
</pre></div>
</div>
</div>
</div>
<p>We can now loop throught the filters and collect the images to create a handy summary table with all the data we have. This way we will have an easier time to later access the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a dictionary with all the necessary information (science, weight, noise, mask)</span>
<span class="n">summary_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span><span class="s2">&quot;products&quot;</span><span class="p">,</span><span class="s2">&quot;facility_name&quot;</span><span class="p">,</span><span class="s2">&quot;instrument_name&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">])</span>
<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s1">&#39;energy_bandpassname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s2">&quot;dataproduct_subtype&quot;</span><span class="p">][</span><span class="n">sel</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;science&quot;</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span> <span class="c1"># sort so that science is the first in the list. This is the order we create the hdu extensions</span>
        <span class="n">products</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;science&quot;</span><span class="p">)</span>
        <span class="n">products</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;science&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: no science image found!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>

    <span class="n">summary_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span> <span class="p">[</span><span class="n">filt</span> <span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">products</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s2">&quot;facility_name&quot;</span><span class="p">][</span><span class="n">sel</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s2">&quot;instrument_name&quot;</span><span class="p">][</span><span class="n">sel</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;science&#39;, &#39;auxiliary&#39;]
[&#39;science&#39;, &#39;auxiliary&#39;]
[&#39;science&#39;, &#39;auxiliary&#39;]
[&#39;science&#39;, &#39;auxiliary&#39;]
</pre></div>
</div>
</div>
</div>
<p>Let’s check out the summary table that we have created. We see that we have all the 4 Euclid bands and what data products are available for each of them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=4</i>
<table id="table139730240984592" class="table-striped table-bordered table-condensed">
<thead><tr><th>filter</th><th>products</th><th>facility_name</th><th>instrument_name</th></tr></thead>
<thead><tr><th>str3</th><th>str17</th><th>str6</th><th>str4</th></tr></thead>
<tr><td>VIS</td><td>science;auxiliary</td><td>Euclid</td><td>VIS</td></tr>
<tr><td>Y</td><td>science;auxiliary</td><td>Euclid</td><td>NISP</td></tr>
<tr><td>J</td><td>science;auxiliary</td><td>Euclid</td><td>NISP</td></tr>
<tr><td>H</td><td>science;auxiliary</td><td>Euclid</td><td>NISP</td></tr>
</table></div></div></div>
</div>
</section>
<section id="create-cutout-images">
<h2>Create Cutout Images<a class="headerlink" href="#create-cutout-images" title="Link to this heading">#</a></h2>
<p>Now that we have a list of data products, we can create the cutouts. This is important as the full Euclid ERO images would be too large to run extraction and photometry software on them (they would simply fail due to memory issues).</p>
<p>For each image, we create a cutout around the target of interest, using the <code class="docutils literal notranslate"><span class="pre">cutout_size</span></code> defined above. The cutouts are then collected into HDUs. That way we can easily access the different data products. Note that we only use the <em>science</em> products as the <em>ancillary</em> products are not needed.</p>
<p>We save the HDU to disk as it will be later used when we visualize the Euclid ERO FITS images in <code class="docutils literal notranslate"><span class="pre">Firefly</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will notice that <code class="docutils literal notranslate"><span class="pre">Cutout2D</span></code> can be applied to an URL. That way, it we do not need to download the full image to create a cutout. This is a useful trick to keep in mind when analyzing large images. This makes creating cutout images very fast.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">filt</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">)):</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">summary_table</span><span class="p">[</span><span class="n">summary_table</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span><span class="p">][</span><span class="s2">&quot;products&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s2">&quot;energy_bandpassname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s2">&quot;dataproduct_subtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">product</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_tab</span><span class="p">[</span><span class="s1">&#39;access_url&#39;</span><span class="p">][</span><span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">use_fsspec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">cutout_size</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">))</span> <span class="c1"># create cutout</span>


            <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="o">==</span> <span class="s2">&quot;science&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># if science image, then create a new hdu.</span>
                <span class="n">hdu0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="n">hdu0</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span> <span class="c1"># update header with WCS info</span>
                <span class="n">hdu0</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">product</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">hdu0</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;PRODUCT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">hdu0</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">hdulcutout</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">product</span> <span class="o">==</span> <span class="s2">&quot;science&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span> <span class="c1"># update header with WCS info</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">product</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;PRODUCT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FILTER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">hdulcutout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

<span class="c1">## Save the HDUL cube:</span>
<span class="n">hdulcutout</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s2">&quot;./data/euclid_images_test.fits&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 1.67 s, sys: 421 ms, total: 2.09 s
Wall time: 16.8 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0it [00:00, ?it/s]
1it [00:11, 11.77s/it]
2it [00:13,  5.72s/it]
3it [00:15,  4.07s/it]
4it [00:16,  2.99s/it]
4it [00:16,  4.17s/it]
</pre></div>
</div>
</div>
</div>
<p>Let’s look at the HDU that we created to check what information we have. You see that all filters are collected in different extensions. Also note the different dimensions of the FITS layers as the pixel scale of VIS and NISP are different.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdulcutout</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filename: (No file associated with this HDUList)
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  VIS_SCIENCE    1 PrimaryHDU     190   (900, 900)   float32   
  1  Y_SCIENCE     1 ImageHDU       191   (300, 300)   float32   
  2  J_SCIENCE     1 ImageHDU       191   (300, 300)   float32   
  3  H_SCIENCE     1 ImageHDU       191   (300, 300)   float32
</pre></div>
</div>
</div>
</div>
<p>We can now plot the image cutouts that we generated. The globular cluster is clearly visible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="c1"># number of images</span>
<span class="n">ncols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># number of columns</span>
<span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">nimages</span> <span class="o">//</span> <span class="n">ncols</span> <span class="p">)</span> <span class="c1"># number of rows</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">nrows</span><span class="p">)</span> <span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimages</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">hdulcutout</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_SCIENCE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span> <span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span> <span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary_table</span><span class="p">[</span><span class="s2">&quot;facility_name&quot;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span><span class="n">summary_table</span><span class="p">[</span><span class="s2">&quot;instrument_name&quot;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span><span class="n">filt</span><span class="p">)</span> <span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                 <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span> <span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2e58d9534cc6df4882af8a7b67bfdead35a7dce614442b415a611b92fe60b1ff.png" src="../../_images/2e58d9534cc6df4882af8a7b67bfdead35a7dce614442b415a611b92fe60b1ff.png" />
</div>
</div>
</section>
<section id="extract-sources-and-measure-their-photometry-on-the-vis-image">
<h2>Extract Sources and Measure their Photometry on the VIS Image<a class="headerlink" href="#extract-sources-and-measure-their-photometry-on-the-vis-image" title="Link to this heading">#</a></h2>
<p>Now that we have the images in memory (and on disk - but we do not need them, yet), we can measure the fluxes of the individual stars.
Our simple photometry pipeline has different parts:</p>
<ul class="simple">
<li><p>First, we are using the Python package <code class="docutils literal notranslate"><span class="pre">sep</span></code> (similar to SExtractor) to extract the position of the sources. We do that on the VIS image, which provides the highest resolution.</p></li>
<li><p>Second, we use <code class="docutils literal notranslate"><span class="pre">sep</span></code> to perform aperture measurements of the photometry. We will use that to compare the obtained fluxes to our forced photometry method</p></li>
<li><p>Third, we apply a PSF fitting technique (using the <code class="docutils literal notranslate"><span class="pre">photutils</span></code> Python package) to improve the photometry measurement</p></li>
</ul>
<p>We start by extracting the sources using <code class="docutils literal notranslate"><span class="pre">sep</span></code>. We first isolate the data that we want to look at (the VIS image only).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Get Data (this will be replaced later)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">hdulcutout</span><span class="p">[</span><span class="s2">&quot;VIS_SCIENCE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">hdr</span> <span class="o">=</span> <span class="n">hdulcutout</span><span class="p">[</span><span class="s2">&quot;VIS_SCIENCE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<p>There are some NaN value on the image that we need to mask out. For this we create a mask image that we later feed to <code class="docutils literal notranslate"><span class="pre">sep</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we compute the background statistics what will be used by <code class="docutils literal notranslate"><span class="pre">sep</span></code> to extract the sources above a certain threshold.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[135.95871  99.62191 100.63356]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Input data contains invalid values (NaNs or infs), which were automatically clipped. [astropy.stats.sigma_clipping]
</pre></div>
</div>
</div>
</div>
<p>Finally, we perform object detection with <code class="docutils literal notranslate"><span class="pre">sep</span></code>. There are also modules in <code class="docutils literal notranslate"><span class="pre">photutils</span></code> to do that, however, we found that <code class="docutils literal notranslate"><span class="pre">sep</span></code> works best here. We output the number of objects found on the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">objects</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">img</span><span class="o">-</span><span class="n">median</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">minarea</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">deblend_cont</span><span class="o">=</span><span class="mf">0.0002</span><span class="p">,</span> <span class="n">deblend_nthresh</span><span class="o">=</span><span class="mi">64</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of sources extracted: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of sources extracted:  2759
</pre></div>
</div>
</div>
</div>
<p>Next, we perform simple aperture photometry on the detected sources. Again, we use the <code class="docutils literal notranslate"><span class="pre">sep</span></code> package for this. We will use these aperture photometry later to compare to the PSF photometry.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">sum_circle</span><span class="p">(</span><span class="n">img</span><span class="o">-</span><span class="n">median</span><span class="p">,</span> <span class="n">objects</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">objects</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">r</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we use the <code class="docutils literal notranslate"><span class="pre">photutils</span></code> Python package to perform PSF fitting. Here we assume a simple Gaussian with a FWHM given by <code class="docutils literal notranslate"><span class="pre">psf_fwhm</span></code> as PSF.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We use a Gaussian PSF here for simplicity. The photometry can be improved by using a pixelated PSF measured directly from the Euclid images (for example by stacking stars).</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_fwhm</span> <span class="o">=</span> <span class="mf">0.16</span> <span class="c1"># PSF FWHM in arcsec</span>
<span class="n">pixscale</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># VIS pixel scale in arcsec/px</span>

<span class="n">init_params</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">objects</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span><span class="n">objects</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="c1"># initial positions</span>
<span class="n">psf_model</span> <span class="o">=</span> <span class="n">CircularGaussianSigmaPRF</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">psf_fwhm</span><span class="o">/</span><span class="n">pixscale</span> <span class="o">/</span> <span class="mf">2.35</span><span class="p">)</span>
<span class="n">psf_model</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">psf_model</span><span class="o">.</span><span class="n">y_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">psf_model</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">fit_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">psfphot</span> <span class="o">=</span> <span class="n">PSFPhotometry</span><span class="p">(</span><span class="n">psf_model</span><span class="p">,</span>
                        <span class="n">fit_shape</span><span class="p">,</span>
                        <span class="n">finder</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">exclude_border</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="c1"># not needed because we are using fixed initial positions.</span>
                        <span class="n">aperture_radius</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="n">progress_bar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After initiating the <code class="docutils literal notranslate"><span class="pre">PSFPhotometry</span></code> object, we can run the PSF photometry measurement. This can take a while (typically between 1 and 2 minutes).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phot</span> <span class="o">=</span> <span class="n">psfphot</span><span class="p">(</span><span class="n">img</span><span class="o">-</span><span class="n">median</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">init_params</span><span class="o">=</span><span class="n">init_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fit source/group:   0%|          | 0/2759 [00:00&lt;?, ?it/s]
Fit source/group:   1%|          | 23/2759 [00:00&lt;00:12, 227.85it/s]
Fit source/group:   2%|▏         | 46/2759 [00:00&lt;00:12, 214.70it/s]
Fit source/group:   3%|▎         | 69/2759 [00:00&lt;00:12, 220.21it/s]
Fit source/group:   3%|▎         | 92/2759 [00:00&lt;00:12, 220.51it/s]
Fit source/group:   4%|▍         | 115/2759 [00:00&lt;00:15, 171.15it/s]
Fit source/group:   5%|▌         | 138/2759 [00:00&lt;00:13, 187.34it/s]
Fit source/group:   6%|▌         | 159/2759 [00:00&lt;00:13, 192.52it/s]
Fit source/group:   7%|▋         | 181/2759 [00:00&lt;00:13, 197.40it/s]
Fit source/group:   7%|▋         | 203/2759 [00:01&lt;00:12, 203.26it/s]
Fit source/group:   8%|▊         | 226/2759 [00:01&lt;00:12, 210.79it/s]
Fit source/group:   9%|▉         | 250/2759 [00:01&lt;00:11, 218.91it/s]
Fit source/group:  10%|▉         | 273/2759 [00:01&lt;00:11, 218.62it/s]
Fit source/group:  11%|█         | 296/2759 [00:01&lt;00:11, 217.68it/s]
Fit source/group:  12%|█▏        | 320/2759 [00:01&lt;00:10, 222.55it/s]
Fit source/group:  12%|█▏        | 343/2759 [00:01&lt;00:10, 224.11it/s]
Fit source/group:  13%|█▎        | 366/2759 [00:01&lt;00:11, 209.26it/s]
Fit source/group:  14%|█▍        | 388/2759 [00:01&lt;00:11, 210.87it/s]
Fit source/group:  15%|█▍        | 410/2759 [00:01&lt;00:11, 212.16it/s]
Fit source/group:  16%|█▌        | 435/2759 [00:02&lt;00:10, 218.94it/s]
Fit source/group:  17%|█▋        | 457/2759 [00:02&lt;00:10, 217.29it/s]
Fit source/group:  17%|█▋        | 481/2759 [00:02&lt;00:10, 221.76it/s]
Fit source/group:  18%|█▊        | 504/2759 [00:02&lt;00:10, 219.69it/s]
Fit source/group:  19%|█▉        | 528/2759 [00:02&lt;00:09, 224.89it/s]
Fit source/group:  20%|█▉        | 551/2759 [00:02&lt;00:10, 215.49it/s]
Fit source/group:  21%|██        | 573/2759 [00:02&lt;00:10, 213.69it/s]
Fit source/group:  22%|██▏       | 596/2759 [00:02&lt;00:09, 217.18it/s]
Fit source/group:  22%|██▏       | 618/2759 [00:02&lt;00:10, 203.58it/s]
Fit source/group:  23%|██▎       | 639/2759 [00:03&lt;00:10, 203.71it/s]
Fit source/group:  24%|██▍       | 661/2759 [00:03&lt;00:10, 207.77it/s]
Fit source/group:  25%|██▍       | 682/2759 [00:03&lt;00:10, 193.24it/s]
Fit source/group:  26%|██▌       | 704/2759 [00:03&lt;00:10, 198.47it/s]
Fit source/group:  26%|██▋       | 726/2759 [00:03&lt;00:10, 200.14it/s]
Fit source/group:  27%|██▋       | 747/2759 [00:03&lt;00:09, 201.64it/s]
Fit source/group:  28%|██▊       | 770/2759 [00:03&lt;00:09, 207.30it/s]
Fit source/group:  29%|██▊       | 792/2759 [00:03&lt;00:09, 207.88it/s]
Fit source/group:  30%|██▉       | 815/2759 [00:03&lt;00:09, 214.08it/s]
Fit source/group:  30%|███       | 837/2759 [00:03&lt;00:09, 208.27it/s]
Fit source/group:  31%|███       | 860/2759 [00:04&lt;00:08, 212.74it/s]
Fit source/group:  32%|███▏      | 883/2759 [00:04&lt;00:08, 214.77it/s]
Fit source/group:  33%|███▎      | 906/2759 [00:04&lt;00:08, 218.03it/s]
Fit source/group:  34%|███▎      | 928/2759 [00:04&lt;00:08, 217.57it/s]
Fit source/group:  34%|███▍      | 950/2759 [00:04&lt;00:09, 200.91it/s]
Fit source/group:  35%|███▌      | 972/2759 [00:04&lt;00:08, 203.46it/s]
Fit source/group:  36%|███▌      | 993/2759 [00:04&lt;00:08, 204.61it/s]
Fit source/group:  37%|███▋      | 1014/2759 [00:04&lt;00:08, 199.54it/s]
Fit source/group:  38%|███▊      | 1035/2759 [00:04&lt;00:08, 198.56it/s]
Fit source/group:  38%|███▊      | 1058/2759 [00:05&lt;00:08, 205.81it/s]
Fit source/group:  39%|███▉      | 1080/2759 [00:05&lt;00:08, 208.15it/s]
Fit source/group:  40%|███▉      | 1102/2759 [00:05&lt;00:07, 209.13it/s]
Fit source/group:  41%|████      | 1126/2759 [00:05&lt;00:07, 215.61it/s]
Fit source/group:  42%|████▏     | 1149/2759 [00:05&lt;00:07, 218.37it/s]
Fit source/group:  43%|████▎     | 1173/2759 [00:05&lt;00:07, 222.80it/s]
Fit source/group:  43%|████▎     | 1196/2759 [00:05&lt;00:06, 223.43it/s]
Fit source/group:  44%|████▍     | 1219/2759 [00:05&lt;00:06, 222.56it/s]
Fit source/group:  45%|████▌     | 1242/2759 [00:05&lt;00:06, 221.10it/s]
Fit source/group:  46%|████▌     | 1265/2759 [00:05&lt;00:06, 223.56it/s]
Fit source/group:  47%|████▋     | 1288/2759 [00:06&lt;00:06, 219.02it/s]
Fit source/group:  47%|████▋     | 1310/2759 [00:06&lt;00:06, 210.25it/s]
Fit source/group:  48%|████▊     | 1332/2759 [00:06&lt;00:06, 211.71it/s]
Fit source/group:  49%|████▉     | 1354/2759 [00:06&lt;00:06, 210.80it/s]
Fit source/group:  50%|████▉     | 1376/2759 [00:06&lt;00:06, 206.82it/s]
Fit source/group:  51%|█████     | 1397/2759 [00:06&lt;00:06, 206.42it/s]
Fit source/group:  51%|█████▏    | 1418/2759 [00:06&lt;00:06, 194.33it/s]
Fit source/group:  52%|█████▏    | 1440/2759 [00:06&lt;00:06, 199.85it/s]
Fit source/group:  53%|█████▎    | 1464/2759 [00:06&lt;00:06, 210.76it/s]
Fit source/group:  54%|█████▍    | 1486/2759 [00:07&lt;00:06, 212.00it/s]
Fit source/group:  55%|█████▍    | 1508/2759 [00:07&lt;00:05, 211.03it/s]
Fit source/group:  55%|█████▌    | 1530/2759 [00:07&lt;00:06, 192.50it/s]
Fit source/group:  56%|█████▋    | 1552/2759 [00:07&lt;00:06, 199.49it/s]
Fit source/group:  57%|█████▋    | 1576/2759 [00:07&lt;00:05, 208.78it/s]
Fit source/group:  58%|█████▊    | 1599/2759 [00:07&lt;00:05, 213.08it/s]
Fit source/group:  59%|█████▉    | 1621/2759 [00:07&lt;00:05, 208.58it/s]
Fit source/group:  60%|█████▉    | 1643/2759 [00:07&lt;00:05, 203.61it/s]
Fit source/group:  60%|██████    | 1665/2759 [00:07&lt;00:05, 205.98it/s]
Fit source/group:  61%|██████    | 1688/2759 [00:08&lt;00:05, 211.80it/s]
Fit source/group:  62%|██████▏   | 1711/2759 [00:08&lt;00:04, 216.60it/s]
Fit source/group:  63%|██████▎   | 1736/2759 [00:08&lt;00:04, 221.74it/s]
Fit source/group:  64%|██████▍   | 1759/2759 [00:08&lt;00:04, 207.82it/s]
Fit source/group:  65%|██████▍   | 1780/2759 [00:08&lt;00:04, 200.70it/s]
Fit source/group:  65%|██████▌   | 1803/2759 [00:08&lt;00:04, 207.28it/s]
Fit source/group:  66%|██████▌   | 1824/2759 [00:08&lt;00:04, 207.44it/s]
Fit source/group:  67%|██████▋   | 1849/2759 [00:08&lt;00:04, 217.40it/s]
Fit source/group:  68%|██████▊   | 1873/2759 [00:08&lt;00:03, 221.55it/s]
Fit source/group:  69%|██████▊   | 1896/2759 [00:09&lt;00:03, 220.80it/s]
Fit source/group:  70%|██████▉   | 1920/2759 [00:09&lt;00:03, 224.24it/s]
Fit source/group:  70%|███████   | 1943/2759 [00:09&lt;00:03, 220.85it/s]
Fit source/group:  71%|███████▏  | 1966/2759 [00:09&lt;00:03, 219.83it/s]
Fit source/group:  72%|███████▏  | 1989/2759 [00:09&lt;00:03, 200.80it/s]
Fit source/group:  73%|███████▎  | 2012/2759 [00:09&lt;00:03, 205.84it/s]
Fit source/group:  74%|███████▍  | 2036/2759 [00:09&lt;00:03, 213.34it/s]
Fit source/group:  75%|███████▍  | 2058/2759 [00:09&lt;00:03, 209.43it/s]
Fit source/group:  75%|███████▌  | 2080/2759 [00:09&lt;00:03, 191.70it/s]
Fit source/group:  76%|███████▌  | 2100/2759 [00:10&lt;00:03, 190.07it/s]
Fit source/group:  77%|███████▋  | 2120/2759 [00:10&lt;00:03, 189.86it/s]
Fit source/group:  78%|███████▊  | 2143/2759 [00:10&lt;00:03, 200.75it/s]
Fit source/group:  79%|███████▊  | 2167/2759 [00:10&lt;00:02, 210.00it/s]
Fit source/group:  79%|███████▉  | 2191/2759 [00:10&lt;00:02, 216.00it/s]
Fit source/group:  80%|████████  | 2214/2759 [00:10&lt;00:02, 219.65it/s]
Fit source/group:  81%|████████  | 2238/2759 [00:10&lt;00:02, 222.85it/s]
Fit source/group:  82%|████████▏ | 2263/2759 [00:10&lt;00:02, 229.00it/s]
Fit source/group:  83%|████████▎ | 2286/2759 [00:10&lt;00:02, 228.97it/s]
Fit source/group:  84%|████████▍ | 2311/2759 [00:10&lt;00:01, 232.57it/s]
Fit source/group:  85%|████████▍ | 2335/2759 [00:11&lt;00:01, 232.46it/s]
Fit source/group:  86%|████████▌ | 2359/2759 [00:11&lt;00:01, 230.91it/s]
Fit source/group:  86%|████████▋ | 2383/2759 [00:11&lt;00:01, 229.99it/s]
Fit source/group:  87%|████████▋ | 2407/2759 [00:11&lt;00:01, 231.44it/s]
Fit source/group:  88%|████████▊ | 2431/2759 [00:11&lt;00:01, 206.01it/s]
Fit source/group:  89%|████████▉ | 2453/2759 [00:11&lt;00:01, 204.65it/s]
Fit source/group:  90%|████████▉ | 2476/2759 [00:11&lt;00:01, 211.39it/s]
Fit source/group:  91%|█████████ | 2498/2759 [00:11&lt;00:01, 169.31it/s]
Fit source/group:  91%|█████████▏| 2519/2759 [00:12&lt;00:01, 163.25it/s]
Fit source/group:  92%|█████████▏| 2537/2759 [00:12&lt;00:01, 151.13it/s]
Fit source/group:  93%|█████████▎| 2554/2759 [00:12&lt;00:01, 150.30it/s]
Fit source/group:  93%|█████████▎| 2570/2759 [00:12&lt;00:01, 147.18it/s]
Fit source/group:  94%|█████████▎| 2586/2759 [00:12&lt;00:01, 122.95it/s]
Fit source/group:  94%|█████████▍| 2606/2759 [00:12&lt;00:01, 129.53it/s]
Fit source/group:  95%|█████████▍| 2620/2759 [00:12&lt;00:01, 119.93it/s]
Fit source/group:  95%|█████████▌| 2633/2759 [00:13&lt;00:01, 110.30it/s]
Fit source/group:  96%|█████████▌| 2646/2759 [00:13&lt;00:00, 113.72it/s]
Fit source/group:  96%|█████████▋| 2659/2759 [00:13&lt;00:00, 117.06it/s]
Fit source/group:  97%|█████████▋| 2671/2759 [00:13&lt;00:00, 117.74it/s]
Fit source/group:  97%|█████████▋| 2685/2759 [00:13&lt;00:00, 118.12it/s]
Fit source/group:  98%|█████████▊| 2697/2759 [00:13&lt;00:00, 84.93it/s]
Fit source/group:  98%|█████████▊| 2710/2759 [00:13&lt;00:00, 94.49it/s]
Fit source/group:  99%|█████████▊| 2723/2759 [00:13&lt;00:00, 98.62it/s]
Fit source/group:  99%|█████████▉| 2744/2759 [00:14&lt;00:00, 125.72it/s]
Fit source/group: 100%|██████████| 2759/2759 [00:14&lt;00:00, 195.46it/s]
WARNING: One or more fit(s) may not have converged. Please check the &quot;flags&quot; column in the output table. [photutils.psf.photometry]
</pre></div>
</div>
</div>
</div>
<p>Once this is done, we can create a residual image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resimage</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">-</span><span class="n">median</span><span class="p">,</span> <span class="n">psf_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Add model sources:   0%|          | 0/2759 [00:00&lt;?, ?it/s]
Add model sources:  18%|█▊        | 497/2759 [00:00&lt;00:00, 4964.60it/s]
Add model sources:  38%|███▊      | 1062/2759 [00:00&lt;00:00, 5362.91it/s]
Add model sources:  59%|█████▉    | 1628/2759 [00:00&lt;00:00, 5496.68it/s]
Add model sources:  79%|███████▉  | 2178/2759 [00:00&lt;00:00, 5494.38it/s]
Add model sources:  99%|█████████▉| 2728/2759 [00:00&lt;00:00, 5481.35it/s]
Add model sources: 100%|██████████| 2759/2759 [00:00&lt;00:00, 5434.94it/s]
</pre></div>
</div>
</div>
</div>
<p>We now want to add the best-fit coordinates (R.A. and Decl.) to the VIS photometry catalog. For this, we have to convert the image coordinates into sky coordinates using the WCS information. We will need these coordinates because we want to use them as positional priors for the photometry measurement on the NISP images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Add coordinates to catalog</span>
<span class="n">wcs1</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="c1"># VIS</span>
<span class="n">radec</span> <span class="o">=</span> <span class="n">wcs1</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
<span class="n">phot</span><span class="p">[</span><span class="s2">&quot;ra_fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">phot</span><span class="p">[</span><span class="s2">&quot;dec_fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we plot the VIS image and the residual with the extracted sources overlaid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span> <span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resimage</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">5</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span> <span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9bd045ef9d147894824c2a7a7d860bb4bf79f7ea61cf984fc2fd0cead8f911f8.png" src="../../_images/9bd045ef9d147894824c2a7a7d860bb4bf79f7ea61cf984fc2fd0cead8f911f8.png" />
</div>
</div>
<p>As an additional check, we can compare the aperture photometry and the PSF photometry. We should find a good agreement between those two measurement methods. However, note that the PSF photometry should do a better job in deblending the fluxes of sources that are close by.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">minlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">maxlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">/</span><span class="mf">1.5</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">/</span><span class="mf">1.2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Aperture Photometry [flux]&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PSF forced-photometry [flux]&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a154bb494f4e448c4948b4f50450b0989b8871fabc39c834911b21bd1b0ee8d4.png" src="../../_images/a154bb494f4e448c4948b4f50450b0989b8871fabc39c834911b21bd1b0ee8d4.png" />
</div>
</div>
</section>
<section id="measure-the-photometry-on-the-nisp-images">
<h2>Measure the Photometry on the NISP Images<a class="headerlink" href="#measure-the-photometry-on-the-nisp-images" title="Link to this heading">#</a></h2>
<p>We now have the photometry and the position of sources on the VIS image. We can now proceed with similar steps on the NISP images. Because the NISP PSF and pixel scale are larger that those of the VIS images, we utilize the advantage of position prior-based forced photometry.
For this, we use the positions of the VIS measurements and perform PSF fitting on the NISP image using these priors.</p>
<p>The steps below are almost identical to the ones applied to the VIS images.</p>
<p>We first isolate the data, which is in this case the NISP <em>H</em>-band filter. Note that this is an arbitrary choice and you should be encouraged to try other filters as well!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img2</span> <span class="o">=</span> <span class="n">hdulcutout</span><span class="p">[</span><span class="s2">&quot;H_SCIENCE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">hdr2</span> <span class="o">=</span> <span class="n">hdulcutout</span><span class="p">[</span><span class="s2">&quot;H_SCIENCE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">img2</span><span class="p">[</span><span class="n">img2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<p>We again need to create a mask that will be fed to the PSF fitting module.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">img2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>… and we also get some statistics on the sky background.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean2</span><span class="p">,</span> <span class="n">median2</span><span class="p">,</span> <span class="n">std2</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">mean2</span><span class="p">,</span> <span class="n">median2</span><span class="p">,</span> <span class="n">std2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2626.3018 1889.8518 2043.9841]
</pre></div>
</div>
</div>
</div>
<p>Now, we need to obtain the (x,y) image coordinates on the NISP image that correspond to the extracted sources on the VIS image. We use the WCS information from the NISP image for this case and apply it to the sky coordinates obtained on the VIS image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="c1"># VIS</span>
<span class="n">wcs2</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr2</span><span class="p">)</span> <span class="c1"># NISP</span>
<span class="n">radec</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span><span class="n">objects</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">xy</span> <span class="o">=</span> <span class="n">wcs2</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">radec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Having all this set up, we can now again perform the PSF photometry using <code class="docutils literal notranslate"><span class="pre">PSFPhotometry()</span></code> from the <code class="docutils literal notranslate"><span class="pre">photutils</span></code> package. This again can take a while, typically 1 minute.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_fwhm</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># arcsec</span>
<span class="n">pixscale</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># arcsec/px</span>

<span class="n">init_params</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="c1"># initial positions</span>
<span class="n">psf_model</span> <span class="o">=</span> <span class="n">CircularGaussianSigmaPRF</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">psf_fwhm</span><span class="o">/</span><span class="n">pixscale</span> <span class="o">/</span> <span class="mf">2.35</span><span class="p">)</span>
<span class="n">psf_model</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">psf_model</span><span class="o">.</span><span class="n">y_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">psf_model</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">fit_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">psfphot2</span> <span class="o">=</span> <span class="n">PSFPhotometry</span><span class="p">(</span><span class="n">psf_model</span><span class="p">,</span>
                        <span class="n">fit_shape</span><span class="p">,</span>
                        <span class="n">finder</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.</span><span class="o">*</span><span class="n">std2</span><span class="p">,</span> <span class="n">exclude_border</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="c1"># not needed because we are using fixed initial positions.</span>
                        <span class="n">aperture_radius</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="n">progress_bar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">phot2</span> <span class="o">=</span> <span class="n">psfphot2</span><span class="p">(</span><span class="n">img2</span><span class="o">-</span><span class="n">median2</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask2</span><span class="p">,</span> <span class="n">init_params</span><span class="o">=</span><span class="n">init_params</span><span class="p">)</span>
<span class="n">resimage2</span> <span class="o">=</span> <span class="n">psfphot2</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">img2</span><span class="o">-</span><span class="n">median2</span><span class="p">,</span> <span class="n">psf_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fit source/group:   0%|          | 0/2759 [00:00&lt;?, ?it/s]
Fit source/group:   0%|          | 7/2759 [00:00&lt;00:40, 67.26it/s]
Fit source/group:   1%|          | 19/2759 [00:00&lt;00:28, 96.60it/s]
Fit source/group:   1%|▏         | 39/2759 [00:00&lt;00:19, 141.77it/s]
Fit source/group:   2%|▏         | 54/2759 [00:00&lt;00:22, 122.47it/s]
Fit source/group:   2%|▏         | 67/2759 [00:00&lt;00:21, 123.68it/s]
Fit source/group:   3%|▎         | 80/2759 [00:00&lt;00:24, 110.08it/s]
Fit source/group:   3%|▎         | 92/2759 [00:00&lt;00:26, 101.65it/s]
Fit source/group:   4%|▍         | 104/2759 [00:00&lt;00:25, 105.33it/s]
Fit source/group:   4%|▍         | 115/2759 [00:01&lt;00:27, 97.81it/s]
Fit source/group:   5%|▍         | 128/2759 [00:01&lt;00:24, 105.48it/s]
Fit source/group:   5%|▌         | 140/2759 [00:01&lt;00:26, 100.56it/s]
Fit source/group:   5%|▌         | 151/2759 [00:01&lt;00:25, 102.77it/s]
Fit source/group:   6%|▌         | 162/2759 [00:01&lt;00:26, 97.41it/s]
Fit source/group:   6%|▌         | 172/2759 [00:01&lt;00:29, 87.48it/s]
Fit source/group:   7%|▋         | 192/2759 [00:01&lt;00:24, 104.57it/s]
Fit source/group:   7%|▋         | 206/2759 [00:01&lt;00:22, 112.30it/s]
Fit source/group:   8%|▊         | 228/2759 [00:02&lt;00:18, 139.71it/s]
Fit source/group:   9%|▉         | 243/2759 [00:02&lt;00:20, 125.35it/s]
Fit source/group:   9%|▉         | 259/2759 [00:02&lt;00:19, 126.70it/s]
Fit source/group:  10%|▉         | 273/2759 [00:02&lt;00:21, 118.35it/s]
Fit source/group:  10%|█         | 286/2759 [00:02&lt;00:20, 121.07it/s]
Fit source/group:  11%|█         | 301/2759 [00:02&lt;00:19, 124.94it/s]
Fit source/group:  11%|█▏        | 314/2759 [00:02&lt;00:25, 96.01it/s]
Fit source/group:  12%|█▏        | 325/2759 [00:03&lt;00:25, 94.01it/s]
Fit source/group:  13%|█▎        | 345/2759 [00:03&lt;00:20, 117.36it/s]
Fit source/group:  13%|█▎        | 361/2759 [00:03&lt;00:19, 123.82it/s]
Fit source/group:  14%|█▎        | 375/2759 [00:03&lt;00:21, 113.44it/s]
Fit source/group:  14%|█▍        | 390/2759 [00:03&lt;00:20, 117.44it/s]
Fit source/group:  15%|█▍        | 403/2759 [00:03&lt;00:19, 119.62it/s]
Fit source/group:  15%|█▌        | 422/2759 [00:03&lt;00:17, 136.81it/s]
Fit source/group:  16%|█▌        | 437/2759 [00:03&lt;00:17, 136.24it/s]
Fit source/group:  16%|█▋        | 452/2759 [00:03&lt;00:16, 135.76it/s]
Fit source/group:  17%|█▋        | 466/2759 [00:04&lt;00:18, 121.90it/s]
Fit source/group:  17%|█▋        | 479/2759 [00:04&lt;00:18, 121.57it/s]
Fit source/group:  18%|█▊        | 498/2759 [00:04&lt;00:16, 139.04it/s]
Fit source/group:  19%|█▊        | 513/2759 [00:04&lt;00:18, 123.81it/s]
Fit source/group:  19%|█▉        | 528/2759 [00:04&lt;00:17, 127.06it/s]
Fit source/group:  20%|█▉        | 542/2759 [00:04&lt;00:19, 115.57it/s]
Fit source/group:  20%|██        | 554/2759 [00:04&lt;00:20, 105.60it/s]
Fit source/group:  21%|██        | 568/2759 [00:04&lt;00:19, 112.62it/s]
Fit source/group:  21%|██        | 580/2759 [00:05&lt;00:20, 106.17it/s]
Fit source/group:  21%|██▏       | 592/2759 [00:05&lt;00:19, 108.61it/s]
Fit source/group:  22%|██▏       | 604/2759 [00:05&lt;00:21, 100.29it/s]
Fit source/group:  22%|██▏       | 615/2759 [00:05&lt;00:26, 80.16it/s]
Fit source/group:  23%|██▎       | 633/2759 [00:05&lt;00:21, 100.86it/s]
Fit source/group:  23%|██▎       | 647/2759 [00:05&lt;00:19, 109.92it/s]
Fit source/group:  24%|██▍       | 660/2759 [00:05&lt;00:20, 102.47it/s]
Fit source/group:  25%|██▍       | 677/2759 [00:06&lt;00:18, 112.40it/s]
Fit source/group:  25%|██▌       | 690/2759 [00:06&lt;00:17, 115.65it/s]
Fit source/group:  25%|██▌       | 703/2759 [00:06&lt;00:22, 92.74it/s]
Fit source/group:  26%|██▌       | 715/2759 [00:06&lt;00:22, 92.03it/s]
Fit source/group:  26%|██▋       | 726/2759 [00:06&lt;00:22, 90.88it/s]
Fit source/group:  27%|██▋       | 746/2759 [00:06&lt;00:18, 109.15it/s]
Fit source/group:  27%|██▋       | 758/2759 [00:06&lt;00:21, 95.24it/s]
Fit source/group:  28%|██▊       | 778/2759 [00:07&lt;00:17, 110.86it/s]
Fit source/group:  29%|██▉       | 796/2759 [00:07&lt;00:16, 116.79it/s]
Fit source/group:  30%|██▉       | 816/2759 [00:07&lt;00:14, 135.78it/s]
Fit source/group:  30%|███       | 831/2759 [00:07&lt;00:17, 112.96it/s]
Fit source/group:  31%|███       | 845/2759 [00:07&lt;00:16, 117.44it/s]
Fit source/group:  31%|███       | 859/2759 [00:07&lt;00:15, 121.85it/s]
Fit source/group:  32%|███▏      | 872/2759 [00:07&lt;00:18, 104.81it/s]
Fit source/group:  32%|███▏      | 888/2759 [00:07&lt;00:16, 115.90it/s]
Fit source/group:  33%|███▎      | 904/2759 [00:08&lt;00:15, 120.56it/s]
Fit source/group:  33%|███▎      | 918/2759 [00:08&lt;00:14, 124.22it/s]
Fit source/group:  34%|███▎      | 931/2759 [00:08&lt;00:14, 125.61it/s]
Fit source/group:  34%|███▍      | 945/2759 [00:08&lt;00:14, 127.52it/s]
Fit source/group:  35%|███▍      | 959/2759 [00:08&lt;00:15, 116.40it/s]
Fit source/group:  35%|███▌      | 971/2759 [00:08&lt;00:15, 116.01it/s]
Fit source/group:  36%|███▌      | 983/2759 [00:08&lt;00:20, 88.46it/s]
Fit source/group:  36%|███▌      | 993/2759 [00:09&lt;00:26, 67.01it/s]
Fit source/group:  37%|███▋      | 1008/2759 [00:09&lt;00:21, 82.59it/s]
Fit source/group:  37%|███▋      | 1025/2759 [00:09&lt;00:17, 96.67it/s]
Fit source/group:  38%|███▊      | 1044/2759 [00:09&lt;00:15, 108.31it/s]
Fit source/group:  38%|███▊      | 1056/2759 [00:09&lt;00:16, 101.39it/s]
Fit source/group:  39%|███▉      | 1072/2759 [00:09&lt;00:15, 110.09it/s]
Fit source/group:  39%|███▉      | 1085/2759 [00:09&lt;00:14, 114.01it/s]
Fit source/group:  40%|███▉      | 1098/2759 [00:09&lt;00:14, 116.72it/s]
Fit source/group:  40%|████      | 1111/2759 [00:10&lt;00:14, 117.57it/s]
Fit source/group:  41%|████      | 1124/2759 [00:10&lt;00:15, 108.55it/s]
Fit source/group:  41%|████      | 1136/2759 [00:10&lt;00:15, 102.95it/s]
Fit source/group:  42%|████▏     | 1147/2759 [00:10&lt;00:16, 97.57it/s]
Fit source/group:  42%|████▏     | 1161/2759 [00:10&lt;00:14, 106.69it/s]
Fit source/group:  43%|████▎     | 1175/2759 [00:10&lt;00:13, 114.09it/s]
Fit source/group:  43%|████▎     | 1187/2759 [00:10&lt;00:13, 115.21it/s]
Fit source/group:  43%|████▎     | 1199/2759 [00:10&lt;00:15, 102.09it/s]
Fit source/group:  44%|████▍     | 1210/2759 [00:11&lt;00:16, 95.21it/s]
Fit source/group:  44%|████▍     | 1220/2759 [00:11&lt;00:17, 90.46it/s]
Fit source/group:  45%|████▍     | 1232/2759 [00:11&lt;00:16, 90.37it/s]
Fit source/group:  45%|████▌     | 1244/2759 [00:11&lt;00:15, 97.31it/s]
Fit source/group:  46%|████▌     | 1257/2759 [00:11&lt;00:14, 104.15it/s]
Fit source/group:  46%|████▋     | 1277/2759 [00:11&lt;00:11, 129.41it/s]
Fit source/group:  47%|████▋     | 1291/2759 [00:11&lt;00:11, 130.56it/s]
Fit source/group:  47%|████▋     | 1305/2759 [00:11&lt;00:12, 118.94it/s]
Fit source/group:  48%|████▊     | 1318/2759 [00:11&lt;00:12, 111.12it/s]
Fit source/group:  48%|████▊     | 1330/2759 [00:12&lt;00:13, 104.21it/s]
Fit source/group:  49%|████▊     | 1341/2759 [00:12&lt;00:14, 98.28it/s]
Fit source/group:  49%|████▉     | 1352/2759 [00:12&lt;00:14, 94.96it/s]
Fit source/group:  49%|████▉     | 1363/2759 [00:12&lt;00:14, 98.41it/s]
Fit source/group:  50%|████▉     | 1373/2759 [00:12&lt;00:15, 88.48it/s]
Fit source/group:  50%|█████     | 1383/2759 [00:12&lt;00:17, 79.08it/s]
Fit source/group:  50%|█████     | 1393/2759 [00:12&lt;00:17, 80.19it/s]
Fit source/group:  51%|█████     | 1407/2759 [00:13&lt;00:15, 89.77it/s]
Fit source/group:  51%|█████▏    | 1417/2759 [00:13&lt;00:16, 79.75it/s]
Fit source/group:  52%|█████▏    | 1439/2759 [00:13&lt;00:11, 111.08it/s]
Fit source/group:  53%|█████▎    | 1452/2759 [00:13&lt;00:11, 114.31it/s]
Fit source/group:  53%|█████▎    | 1473/2759 [00:13&lt;00:09, 139.00it/s]
Fit source/group:  54%|█████▍    | 1488/2759 [00:13&lt;00:09, 141.19it/s]
Fit source/group:  54%|█████▍    | 1503/2759 [00:13&lt;00:08, 140.43it/s]
Fit source/group:  55%|█████▌    | 1518/2759 [00:13&lt;00:10, 122.20it/s]
Fit source/group:  55%|█████▌    | 1531/2759 [00:14&lt;00:10, 113.86it/s]
Fit source/group:  56%|█████▌    | 1543/2759 [00:14&lt;00:11, 106.82it/s]
Fit source/group:  56%|█████▋    | 1557/2759 [00:14&lt;00:10, 114.39it/s]
Fit source/group:  57%|█████▋    | 1570/2759 [00:14&lt;00:11, 106.95it/s]
Fit source/group:  58%|█████▊    | 1588/2759 [00:14&lt;00:09, 125.22it/s]
Fit source/group:  58%|█████▊    | 1602/2759 [00:14&lt;00:09, 123.75it/s]
Fit source/group:  59%|█████▊    | 1615/2759 [00:14&lt;00:11, 103.89it/s]
Fit source/group:  59%|█████▉    | 1627/2759 [00:14&lt;00:10, 106.61it/s]
Fit source/group:  59%|█████▉    | 1639/2759 [00:15&lt;00:11, 97.50it/s]
Fit source/group:  60%|█████▉    | 1650/2759 [00:15&lt;00:12, 92.13it/s]
Fit source/group:  60%|██████    | 1662/2759 [00:15&lt;00:11, 97.82it/s]
Fit source/group:  61%|██████    | 1675/2759 [00:15&lt;00:10, 105.24it/s]
Fit source/group:  61%|██████    | 1687/2759 [00:15&lt;00:09, 108.13it/s]
Fit source/group:  62%|██████▏   | 1700/2759 [00:15&lt;00:09, 112.03it/s]
Fit source/group:  62%|██████▏   | 1712/2759 [00:15&lt;00:09, 113.30it/s]
Fit source/group:  62%|██████▏   | 1724/2759 [00:15&lt;00:08, 115.18it/s]
Fit source/group:  63%|██████▎   | 1736/2759 [00:15&lt;00:10, 95.16it/s]
Fit source/group:  63%|██████▎   | 1751/2759 [00:16&lt;00:09, 107.05it/s]
Fit source/group:  64%|██████▍   | 1763/2759 [00:16&lt;00:10, 91.87it/s]
Fit source/group:  64%|██████▍   | 1774/2759 [00:16&lt;00:10, 90.48it/s]
Fit source/group:  65%|██████▍   | 1784/2759 [00:16&lt;00:12, 79.49it/s]
Fit source/group:  65%|██████▌   | 1797/2759 [00:16&lt;00:10, 90.17it/s]
Fit source/group:  66%|██████▌   | 1811/2759 [00:16&lt;00:09, 101.91it/s]
Fit source/group:  66%|██████▋   | 1829/2759 [00:16&lt;00:08, 116.16it/s]
Fit source/group:  67%|██████▋   | 1842/2759 [00:17&lt;00:08, 109.13it/s]
Fit source/group:  67%|██████▋   | 1854/2759 [00:17&lt;00:08, 102.72it/s]
Fit source/group:  68%|██████▊   | 1866/2759 [00:17&lt;00:09, 97.63it/s]
Fit source/group:  68%|██████▊   | 1878/2759 [00:17&lt;00:08, 102.62it/s]
Fit source/group:  69%|██████▊   | 1892/2759 [00:17&lt;00:07, 111.44it/s]
Fit source/group:  69%|██████▉   | 1907/2759 [00:17&lt;00:07, 114.68it/s]
Fit source/group:  70%|██████▉   | 1919/2759 [00:17&lt;00:08, 98.65it/s]
Fit source/group:  70%|██████▉   | 1931/2759 [00:17&lt;00:07, 103.77it/s]
Fit source/group:  70%|███████   | 1942/2759 [00:18&lt;00:08, 97.97it/s]
Fit source/group:  71%|███████   | 1953/2759 [00:18&lt;00:09, 87.15it/s]
Fit source/group:  71%|███████▏  | 1972/2759 [00:18&lt;00:07, 111.74it/s]
Fit source/group:  72%|███████▏  | 1985/2759 [00:18&lt;00:08, 90.29it/s]
Fit source/group:  72%|███████▏  | 1996/2759 [00:18&lt;00:08, 88.10it/s]
Fit source/group:  73%|███████▎  | 2008/2759 [00:18&lt;00:07, 94.22it/s]
Fit source/group:  73%|███████▎  | 2019/2759 [00:18&lt;00:08, 90.92it/s]
Fit source/group:  74%|███████▎  | 2031/2759 [00:18&lt;00:07, 95.54it/s]
Fit source/group:  74%|███████▍  | 2046/2759 [00:19&lt;00:06, 104.71it/s]
Fit source/group:  75%|███████▍  | 2059/2759 [00:19&lt;00:06, 110.66it/s]
Fit source/group:  75%|███████▌  | 2074/2759 [00:19&lt;00:06, 111.42it/s]
Fit source/group:  76%|███████▌  | 2086/2759 [00:19&lt;00:06, 105.22it/s]
Fit source/group:  76%|███████▌  | 2098/2759 [00:19&lt;00:06, 100.57it/s]
Fit source/group:  77%|███████▋  | 2117/2759 [00:19&lt;00:05, 115.62it/s]
Fit source/group:  77%|███████▋  | 2132/2759 [00:19&lt;00:05, 121.98it/s]
Fit source/group:  78%|███████▊  | 2145/2759 [00:19&lt;00:04, 122.95it/s]
Fit source/group:  78%|███████▊  | 2158/2759 [00:20&lt;00:05, 103.77it/s]
Fit source/group:  79%|███████▊  | 2169/2759 [00:20&lt;00:05, 98.75it/s]
Fit source/group:  79%|███████▉  | 2181/2759 [00:20&lt;00:05, 103.49it/s]
Fit source/group:  80%|███████▉  | 2197/2759 [00:20&lt;00:04, 114.11it/s]
Fit source/group:  80%|████████  | 2210/2759 [00:20&lt;00:04, 116.46it/s]
Fit source/group:  81%|████████  | 2222/2759 [00:20&lt;00:05, 96.90it/s]
Fit source/group:  81%|████████  | 2234/2759 [00:20&lt;00:05, 93.89it/s]
Fit source/group:  81%|████████▏ | 2246/2759 [00:21&lt;00:05, 91.46it/s]
Fit source/group:  82%|████████▏ | 2264/2759 [00:21&lt;00:04, 107.56it/s]
Fit source/group:  82%|████████▏ | 2276/2759 [00:21&lt;00:04, 107.40it/s]
Fit source/group:  83%|████████▎ | 2288/2759 [00:21&lt;00:04, 103.03it/s]
Fit source/group:  84%|████████▎ | 2307/2759 [00:21&lt;00:03, 122.66it/s]
Fit source/group:  84%|████████▍ | 2320/2759 [00:21&lt;00:03, 124.25it/s]
Fit source/group:  85%|████████▍ | 2337/2759 [00:21&lt;00:03, 136.36it/s]
Fit source/group:  85%|████████▌ | 2351/2759 [00:21&lt;00:03, 112.36it/s]
Fit source/group:  86%|████████▌ | 2364/2759 [00:22&lt;00:04, 96.99it/s]
Fit source/group:  86%|████████▌ | 2375/2759 [00:22&lt;00:04, 86.14it/s]
Fit source/group:  86%|████████▋ | 2385/2759 [00:22&lt;00:04, 84.87it/s]
Fit source/group:  87%|████████▋ | 2397/2759 [00:22&lt;00:04, 86.42it/s]
Fit source/group:  87%|████████▋ | 2412/2759 [00:22&lt;00:03, 97.26it/s]
Fit source/group:  88%|████████▊ | 2425/2759 [00:22&lt;00:03, 104.56it/s]
Fit source/group:  88%|████████▊ | 2436/2759 [00:22&lt;00:03, 90.55it/s]
Fit source/group:  89%|████████▊ | 2447/2759 [00:22&lt;00:03, 95.00it/s]
Fit source/group:  89%|████████▉ | 2457/2759 [00:23&lt;00:03, 83.04it/s]
Fit source/group:  90%|████████▉ | 2473/2759 [00:23&lt;00:03, 93.06it/s]
Fit source/group:  90%|█████████ | 2485/2759 [00:23&lt;00:02, 98.71it/s]
Fit source/group:  90%|█████████ | 2496/2759 [00:23&lt;00:03, 80.06it/s]
Fit source/group:  91%|█████████ | 2517/2759 [00:23&lt;00:02, 107.52it/s]
Fit source/group:  92%|█████████▏| 2530/2759 [00:23&lt;00:02, 83.99it/s]
Fit source/group:  92%|█████████▏| 2541/2759 [00:24&lt;00:02, 83.56it/s]
Fit source/group:  93%|█████████▎| 2554/2759 [00:24&lt;00:02, 92.97it/s]
Fit source/group:  93%|█████████▎| 2568/2759 [00:24&lt;00:01, 103.52it/s]
Fit source/group:  94%|█████████▎| 2581/2759 [00:24&lt;00:01, 109.15it/s]
Fit source/group:  94%|█████████▍| 2594/2759 [00:24&lt;00:01, 113.88it/s]
Fit source/group:  95%|█████████▍| 2614/2759 [00:24&lt;00:01, 126.62it/s]
Fit source/group:  95%|█████████▌| 2634/2759 [00:24&lt;00:00, 144.85it/s]
Fit source/group:  96%|█████████▌| 2649/2759 [00:24&lt;00:00, 138.33it/s]
Fit source/group:  97%|█████████▋| 2668/2759 [00:24&lt;00:00, 140.99it/s]
Fit source/group:  97%|█████████▋| 2687/2759 [00:25&lt;00:00, 144.09it/s]
Fit source/group:  98%|█████████▊| 2708/2759 [00:25&lt;00:00, 146.21it/s]
Fit source/group:  99%|█████████▊| 2723/2759 [00:25&lt;00:00, 103.78it/s]
Fit source/group:  99%|█████████▉| 2735/2759 [00:25&lt;00:00, 106.41it/s]
Fit source/group: 100%|█████████▉| 2756/2759 [00:25&lt;00:00, 128.29it/s]
Fit source/group: 100%|██████████| 2759/2759 [00:25&lt;00:00, 107.38it/s]
WARNING: One or more fit(s) may not have converged. Please check the &quot;flags&quot; column in the output table. [photutils.psf.photometry]
Add model sources:   0%|          | 0/2759 [00:00&lt;?, ?it/s]
Add model sources:  21%|██        | 576/2759 [00:00&lt;00:00, 5752.68it/s]
Add model sources:  42%|████▏     | 1166/2759 [00:00&lt;00:00, 5835.24it/s]
Add model sources:  63%|██████▎   | 1750/2759 [00:00&lt;00:00, 5823.69it/s]
Add model sources:  85%|████████▍ | 2333/2759 [00:00&lt;00:00, 5723.64it/s]
Add model sources: 100%|██████████| 2759/2759 [00:00&lt;00:00, 5741.12it/s]
</pre></div>
</div>
</div>
</div>
<p>Again, we convert the pixel coordinates to sky coordinates and add them to the catalog.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wcs2</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr2</span><span class="p">)</span> <span class="c1"># NISP</span>
<span class="n">radec</span> <span class="o">=</span> <span class="n">wcs2</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span><span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
<span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;ra_fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;dec_fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we create the same figure as above, showing the NISP image and the residual with the (VIS-extracted) sources overlaid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img2</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span> <span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span> <span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resimage2</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">20</span><span class="o">*</span><span class="n">std2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="n">std2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;x_fit&quot;</span><span class="p">],</span> <span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;y_fit&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span> <span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/410f7c8c14f237cd910810b1f288a54002c5e4a31d4d2521f9b03eb64dca9c36.png" src="../../_images/410f7c8c14f237cd910810b1f288a54002c5e4a31d4d2521f9b03eb64dca9c36.png" />
</div>
</div>
</section>
<section id="load-gaia-catalog">
<h2>Load Gaia Catalog<a class="headerlink" href="#load-gaia-catalog" title="Link to this heading">#</a></h2>
<p>We now load the Gaia sources at the location of the globular clusters. The goal is to compare the photometry of Gaia to the one derived above for the Euclid VIS and NISP images. This is scientifically useful, for example we can compute the colors of the stars in the Gaia optical bands and the Euclid near-IR bands.
To search for Gaia sources, we use <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> again.</p>
<p>We first have to elimiate the row limit for the Gaia query by setting</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Gaia</span><span class="o">.</span><span class="n">ROW_LIMIT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we request the Gaia catalog around the position of the globular cluster. We use the same size as the cutout size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gaia_objects</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">query_object_async</span><span class="p">(</span><span class="n">coordinate</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="n">cutout_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of Gaia stars found: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia_objects</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: Query finished. [astroquery.utils.tap.core]
Number of Gaia stars found: 1202
</pre></div>
</div>
</div>
</div>
<p>We then convert the sky coordinates of the Gaia stars to (x,y) image coordinates for VIS and NISP images using the corresponding WCS. This makes it more easy to plot the Gaia sources later on the images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="c1"># VIS</span>
<span class="n">wcs2</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr2</span><span class="p">)</span> <span class="c1"># NISP</span>
<span class="n">xy</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
<span class="n">xy2</span> <span class="o">=</span> <span class="n">wcs2</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>

<span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;x_vis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;y_vis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;x_nisp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;y_nisp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We save the Gaia table to disk as we will later use it for the visualization in <code class="docutils literal notranslate"><span class="pre">Firefly</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gaia_objects</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;./data/gaiatable.csv&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can overlay the Gaia sources on the VIS and NISP images (here the x/y coordinates become handy).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;x_vis&quot;</span><span class="p">],</span> <span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;y_vis&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span> <span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;VIS&quot;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img2</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;x_nisp&quot;</span><span class="p">],</span> <span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;y_nisp&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span> <span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;NISP&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/69fbac2adfc94e895ca3c08b32a6d4602978a7d5b59969b4a717dd6f82e9751f.png" src="../../_images/69fbac2adfc94e895ca3c08b32a6d4602978a7d5b59969b4a717dd6f82e9751f.png" />
</div>
</div>
</section>
<section id="match-the-gaia-catalog-to-the-vis-and-nisp-catalogs">
<h2>Match the Gaia Catalog to the VIS and NISP Catalogs<a class="headerlink" href="#match-the-gaia-catalog-to-the-vis-and-nisp-catalogs" title="Link to this heading">#</a></h2>
<p>Now, we match the Gaia source positions to the extracted sources in the VIS and NISP images.</p>
<p>We first define which Gaia columns to copy to the matched catalog as well as the matching distance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gaia_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_g_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_bp_mean_mag&quot;</span><span class="p">,</span> <span class="s2">&quot;phot_rp_mean_mag&quot;</span><span class="p">,</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span><span class="s2">&quot;pmra&quot;</span><span class="p">,</span><span class="s2">&quot;pmdec&quot;</span><span class="p">]</span>
<span class="n">matching_distance</span> <span class="o">=</span> <span class="mf">0.6</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsecond</span>
</pre></div>
</div>
</div>
</div>
<p>First match to the VIS image. We use the <code class="docutils literal notranslate"><span class="pre">astropy</span></code> <em>SkyCoord()</em> function for matching in sky coordinates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;ra_fit&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;dec_fit&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span> <span class="p">)</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">gaia_objects</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
<span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">d3d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>

<span class="n">sel_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d2d</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsecond</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">matching_distance</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gaia Sources matched to VIS: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_matched</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">phot</span><span class="p">[</span><span class="s2">&quot;gaia_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2d</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsecond</span><span class="p">)</span>

<span class="k">for</span> <span class="n">gaia_key</span> <span class="ow">in</span> <span class="n">gaia_keys</span><span class="p">:</span>
    <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;gaia_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gaia_key</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;gaia_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gaia_key</span><span class="p">)][</span><span class="n">sel_matched</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaia_objects</span><span class="p">[</span><span class="n">gaia_key</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sel_matched</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Gaia Sources matched to VIS: 1223
</pre></div>
</div>
</div>
</div>
<p>And then we add the NISP sources. Note that we do not have to perform matching here because by design the VIS and NISP sources are matched (spatial prior forced photometry).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;gaia_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2d</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsecond</span><span class="p">)</span>

<span class="k">for</span> <span class="n">gaia_key</span> <span class="ow">in</span> <span class="n">gaia_keys</span><span class="p">:</span>
    <span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;gaia_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gaia_key</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">phot2</span><span class="p">[</span><span class="s2">&quot;gaia_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gaia_key</span><span class="p">)][</span><span class="n">sel_matched</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaia_objects</span><span class="p">[</span><span class="n">gaia_key</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sel_matched</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p>Once matched, we can now compare the Gaia and Euclid/NISP magnitudes of the stars.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s2">&quot;gaia_phot_rp_mean_mag&quot;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;ZP_STACK&quot;</span><span class="p">]</span>

<span class="c1"># selection</span>
<span class="n">sel_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s2">&quot;gaia_source_id&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">sel_good</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">sel_good</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">minlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
<span class="n">maxlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">/</span><span class="mf">1.5</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">/</span><span class="mf">1.2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">])</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">minlim</span><span class="p">,</span><span class="n">maxlim</span><span class="p">]),</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Gaia Rp [mag]&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;I$_E$ [mag]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2cbb87a691c4afaeae9f178abf2ada98b1c4bdd19179498b53870ed41f323fe1.png" src="../../_images/2cbb87a691c4afaeae9f178abf2ada98b1c4bdd19179498b53870ed41f323fe1.png" />
</div>
</div>
</section>
<section id="visualization-with-firefly">
<h2>Visualization with Firefly<a class="headerlink" href="#visualization-with-firefly" title="Link to this heading">#</a></h2>
<p>At the end of this Notebook, we demonstrate how we can visualize the images and catalogs created above in <code class="docutils literal notranslate"><span class="pre">Firefly</span></code>.</p>
<p>We start by initializing the Firefly client.
The following line will open a new <code class="docutils literal notranslate"><span class="pre">Firefly</span></code> GUI in a separate tab <strong>inside</strong> the Jupyter Notebook environment. The user can drag the tab onto the currently open tab to create a “split tab”. This the user to see the code and images side-by-side.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment when using within Jupyter Lab with jupyter_firefly_extensions installed</span>
<span class="c1"># fc = FireflyClient.make_lab_client()</span>

<span class="c1"># Uncomment for contexts other than the above</span>
<span class="n">fc</span> <span class="o">=</span> <span class="n">FireflyClient</span><span class="o">.</span><span class="n">make_client</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://irsa.ipac.caltech.edu/irsaviewer&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">Open your web browser to <a href="https://irsa.ipac.caltech.edu/irsaviewer/?__wsch=MjAyNS0wNy0wMw"" target="_blank">this link</a></div></div>
</div>
<p>In order to display in image or catalog in <code class="docutils literal notranslate"><span class="pre">Firefly</span></code>, it needs to be uploaded to the <code class="docutils literal notranslate"><span class="pre">Firefly</span></code> server. We do this here using the <code class="docutils literal notranslate"><span class="pre">upload_file()</span></code> function.
We first upload the FITS image that we created above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fval</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s1">&#39;./data/euclid_images_test.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once the image is uploaded we can use the <code class="docutils literal notranslate"><span class="pre">show_fits()</span></code> function to display it.
Note that our FITS image has multiple extensions (VIS, and NISP bands). We can open them separately in new <code class="docutils literal notranslate"><span class="pre">Firefly</span></code> tabs by looping over the HDUs and specifying the plot ID by the extension’s name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">hh</span><span class="p">,</span><span class="n">hdu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdulcutout</span><span class="p">):</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">show_fits</span><span class="p">(</span><span class="n">fval</span><span class="p">,</span> <span class="n">MultiImageIdx</span><span class="o">=</span><span class="n">hh</span><span class="p">,</span> <span class="n">plot_id</span><span class="o">=</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can lock the WCS between the images (allowing the user to pan and zoom the images simultaneously) by running:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fc</span><span class="o">.</span><span class="n">align_images</span><span class="p">(</span><span class="n">lock_match</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;success&#39;: True}
</pre></div>
</div>
</div>
</div>
<p>In the same way, we can upload a table, in this case our Gaia table. We again use <code class="docutils literal notranslate"><span class="pre">upload_file()</span></code> but in this case we use <code class="docutils literal notranslate"><span class="pre">show_table()</span></code> to show it in <code class="docutils literal notranslate"><span class="pre">Firefly</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tval</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s1">&#39;./data/gaiatable.csv&#39;</span><span class="p">)</span>
<span class="n">fc</span><span class="o">.</span><span class="n">show_table</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">tbl_id</span> <span class="o">=</span> <span class="s2">&quot;gaiatable&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;success&#39;: True}
</pre></div>
</div>
</div>
</div>
<p>Now, check out the <code class="docutils literal notranslate"><span class="pre">Firefly</span></code> GUI. You can zoom the images, click on sources, filter the table, display different selection, and much more!</p>
</section>
<hr class="docutils" />
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Link to this heading">#</a></h2>
<p><strong>Author</strong>: Andreas Faisst (IPAC Scientist)</p>
<p><strong>Updated</strong>: 2025-03-17</p>
<p><strong>Contact</strong>: the <a class="reference external" href="https://irsa.ipac.caltech.edu/docs/help_desk.html">IRSA Helpdesk</a> with questions or reporting problems.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../cloud_access/euclid-cloud-access.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Euclid Q1: cloud access</p>
      </div>
    </a>
    <a class="right-next"
       href="1_Euclid_intro_MER_images.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Euclid Q1: MER mosaics</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-volume">Data Volume</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-environment">Setting up the Environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#search-euclid-ero-images">Search Euclid ERO Images</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-cutout-images">Create Cutout Images</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-sources-and-measure-their-photometry-on-the-vis-image">Extract Sources and Measure their Photometry on the VIS Image</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measure-the-photometry-on-the-nisp-images">Measure the Photometry on the NISP Images</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-gaia-catalog">Load Gaia Catalog</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#match-the-gaia-catalog-to-the-vis-and-nisp-catalogs">Match the Gaia Catalog to the VIS and NISP Catalogs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-with-firefly">Visualization with Firefly</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By IRSA developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2025, IRSA developers.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>